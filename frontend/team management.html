<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title data-translate="team-management-title">Team Management - UAI Agency</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Fallback for Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2979ff;
      --secondary-color: #ffe600;
      --accent-color: #ff6b35;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --dark-color: #333;
      --light-color: #f8f9fa;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--dark-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-card.primary {
      border-color: var(--primary-color);
    }

    .stat-card.success {
      border-color: var(--success-color);
    }

    .stat-card.warning {
      border-color: var(--warning-color);
    }

    .stat-card.danger {
      border-color: var(--danger-color);
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--primary-color);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--dark-color);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 1rem;
      color: #666;
      font-weight: 500;
    }

    .team-levels {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--dark-color);
      text-align: center;
    }

    .levels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .level-card {
      background: linear-gradient(135deg, var(--primary-color), #5c6bc0);
      color: white;
      border-radius: var(--border-radius);
      padding: 25px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .level-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .level-card:hover::before {
      left: 100%;
    }

    .level-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .level-card.level-a {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
    }

    .level-card.level-b {
      background: linear-gradient(135deg, #4caf50, #8bc34a);
    }

    .level-card.level-c {
      background: linear-gradient(135deg, #9c27b0, #e91e63);
    }

    .level-icon {
      font-size: 2rem;
      margin-bottom: 15px;
    }

    /* Temporary Worker Status Styles */
    .temp-worker-info {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .temp-worker-card {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      border-radius: var(--border-radius);
      padding: 25px;
      display: flex;
      align-items: center;
      gap: 20px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
      transition: var(--transition);
    }

    .temp-worker-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(255, 107, 53, 0.4);
    }

    .temp-worker-icon {
      font-size: 2.5rem;
      color: white;
      flex-shrink: 0;
    }

    .temp-worker-content {
      flex: 1;
    }

    .temp-worker-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .temp-worker-countdown {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .temp-worker-countdown span {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 8px;
      border-radius: 6px;
      margin: 0 2px;
    }

    .temp-worker-description {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .level-name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .level-count {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .management-tools {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .tool-card {
      background: var(--light-color);
      border-radius: var(--border-radius);
      padding: 15px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      text-decoration: none;
      color: var(--dark-color);
      border: 2px solid transparent;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .tool-card:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .tool-card.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--secondary-color);
    }

    .tool-icon {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .tool-name {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .invite-section {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 30px;
      color: white;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .invite-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .invite-description {
      font-size: 1.1rem;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    .invite-btn {
      background: var(--secondary-color);
      color: var(--dark-color);
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      display: inline-block;
    }

    .invite-btn:hover {
      background: #ffd700;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .invitation-tracking-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .invited-users-table {
      margin-top: 20px;
    }

    .invited-users-table h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .invited-users-table table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .invited-users-table th,
    .invited-users-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .invited-users-table th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .invited-users-table tr:hover {
      background: #f8f9fa;
    }

    .rewards-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .reward-card {
      background: var(--light-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: var(--transition);
    }

    .reward-card:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .reward-icon {
      width: 60px;
      height: 60px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .reward-content {
      flex: 1;
    }

    .reward-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-color);
    }

    .reward-progress {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .reward-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      border-radius: 4px;
      transition: width 0.6s ease;
    }

    .reward-status {
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
      min-width: 100px;
    }

    .reward-status.pending {
      background: var(--warning-color);
      color: white;
    }

    .reward-status.completed {
      background: var(--success-color);
      color: white;
    }

    .reward-status.no-reward {
      background: #6c757d;
      color: white;
    }

    .stat-card.warning {
      border-color: #ffc107;
    }

    .stat-card.warning .stat-icon {
      background: #ffc107;
    }



    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading i {
      font-size: 2rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: var(--danger-color);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      text-align: center;
    }

    .success {
      background: var(--success-color);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      text-align: center;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: #666;
      transition: var(--transition);
      padding: 5px 10px;
    }

    .nav-item.active {
      color: var(--primary-color);
    }

    .nav-item i {
      font-size: 1.2rem;
      margin-bottom: 5px;
      display: block;
      width: 100%;
      text-align: center;
      color: inherit;
    }
    
    .nav-item i:before {
      font-family: "Font Awesome 5 Free", "Font Awesome 5 Brands", "Font Awesome 6 Free", "Font Awesome 6 Brands";
      font-weight: 900;
    }

    .nav-item span {
      font-size: 0.8rem;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .levels-grid {
        grid-template-columns: 1fr;
      }

      .tools-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .workers-table {
        font-size: 0.9rem;
      }

      .workers-table th,
      .workers-table td {
        padding: 10px 5px;
      }
    }

    @media (max-width: 480px) {
      .tools-grid {
        grid-template-columns: 1fr;
      }

      .reward-card {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-users"></i> Team Management</h1>
      <p>Manage your team, track performance, and maximize your earnings</p>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <i class="fas fa-spinner"></i>
      <p>Loading team data...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="error" style="display: none;">
      <i class="fas fa-exclamation-triangle"></i>
      <span id="error-message">Failed to load team data</span>
    </div>

    <!-- Success Message -->
    <div id="success" class="success" style="display: none;">
      <i class="fas fa-check-circle"></i>
      <span id="success-message">Operation completed successfully</span>
    </div>



    <!-- Temporary Worker Status -->
    <div id="temp-worker-status-section" style="display: none;">
      <div class="team-levels">
        <h2 class="section-title">Temporary Worker Status</h2>
        <div class="temp-worker-info">
          <div class="temp-worker-card">
            <div class="temp-worker-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="temp-worker-content">
              <div class="temp-worker-title">Trial Period</div>
              <div class="temp-worker-countdown">
                <span id="days-remaining">0</span>d 
                <span id="hours-remaining">0</span>h 
                <span id="minutes-remaining">0</span>m 
                <span id="seconds-remaining">0</span>s remaining
              </div>
              <div class="temp-worker-description">
                Complete tasks to earn and upgrade to Level 1
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Levels -->
    <div id="levels-section" style="display: none;">
      <div class="team-levels">
        <h2 class="section-title">Team Levels</h2>
        <div class="levels-grid">
          <a href="team-level-a.html" class="level-card level-a">
            <div class="level-icon">
              <i class="fas fa-crown"></i>
            </div>
            <div class="level-name">Level A</div>
            <div class="level-count" id="level-a-count">0</div>
          </a>
          <a href="team-level-b.html" class="level-card level-b">
            <div class="level-icon">
              <i class="fas fa-medal"></i>
            </div>
            <div class="level-name">Level B</div>
            <div class="level-count" id="level-b-count">0</div>
          </a>
          <a href="team-level-c.html" class="level-card level-c">
            <div class="level-icon">
              <i class="fas fa-trophy"></i>
            </div>
            <div class="level-name">Level C</div>
            <div class="level-count" id="level-c-count">0</div>
          </a>
        </div>
      </div>
    </div>

    <!-- Management Tools -->
    <div id="tools-section" style="display: none;">
      <div class="management-tools">
        <h2 class="section-title">Team Management Tools</h2>
        <div class="tools-grid">
          <a href="regular-staff.html" class="tool-card active">
            <div class="tool-icon">
              <i class="fas fa-user-tie"></i>
            </div>
            <div class="tool-name">Regular Staff</div>
          </a>
          <a href="temporary-workers.html" class="tool-card">
            <div class="tool-icon">
              <i class="fas fa-user-clock"></i>
            </div>
            <div class="tool-name">Temporary Workers</div>
          </a>
          <a href="recruitment.html" class="tool-card">
            <div class="tool-icon">
              <i class="fas fa-user-plus"></i>
            </div>
            <div class="tool-name">Recruitment</div>
          </a>
          <a href="competition.html" class="tool-card">
            <div class="tool-icon">
              <i class="fas fa-trophy"></i>
            </div>
            <div class="tool-name">Competition</div>
          </a>
        </div>
      </div>
    </div>

    <!-- Invite Section -->
    <div id="invite-section" style="display: none;">
      <div class="invite-section">
        <h2 class="invite-title">Invite Friends & Earn Rewards</h2>
        <p class="invite-description">
          Share your invitation code with friends and earn rewards every day! 
          Watch videos easily and receive rewards non-stop!
        </p>
        <button class="invite-btn" onclick="shareReferralCode()">
          <i class="fas fa-share-alt"></i> Share Invitation Code
        </button>
      </div>
    </div>

    <!-- Invitation Tracking Section -->
    <div id="invitation-tracking-section" style="display: none;">
      <div class="invitation-tracking-section">
        <h2 class="section-title">People Who Joined Using Your Invitation Code</h2>
        <div id="invitation-stats" class="stats-grid">
          <div class="stat-card primary">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-value" id="total-invited">0</div>
            <div class="stat-label">Total Invited</div>
          </div>
          <div class="stat-card success">
            <div class="stat-icon">
              <i class="fas fa-coins"></i>
            </div>
            <div class="stat-value" id="total-earnings">KES 0</div>
            <div class="stat-label">Total Earnings</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value" id="total-pending">KES 0</div>
            <div class="stat-label">Pending Rewards</div>
          </div>
        </div>
        <div id="invited-users-container">
          <!-- Invited users will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Daily Rewards -->
    <div id="rewards-section" style="display: none;">
      <div class="rewards-section">
        <h2 class="section-title">Today's Recommended Rewards</h2>
        <p style="text-align: center; margin-bottom: 20px; color: #666;">
          When your A-level subordinates become regular employees and reach the corresponding number, 
          you will receive rewards.
        </p>
        <div id="rewards-container">
          <!-- Rewards will be loaded here -->
        </div>
      </div>
    </div>


  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="home.html" class="nav-item">
      <i class="fas fa-home" style="font-size: 1.2rem; margin-bottom: 5px;"></i>
      <span data-translate="nav-home-label">Home</span>
    </a>
    <a href="task.html" class="nav-item">
      <i class="fas fa-tasks" style="font-size: 1.2rem; margin-bottom: 5px;"></i>
      <span data-translate="nav-task-label">Tasks</span>
    </a>
    <a href="team management.html" class="nav-item active">
      <i class="fas fa-users" style="font-size: 1.2rem; margin-bottom: 5px;"></i>
      <span data-translate="nav-team-label">Team</span>
    </a>
    <a href="level.html" class="nav-item">
      <i class="fas fa-layer-group" style="font-size: 1.2rem; margin-bottom: 5px;"></i>
      <span data-translate="nav-level-label">Level</span>
    </a>
    <a href="profile.html" class="nav-item">
      <i class="fas fa-user" style="font-size: 1.2rem; margin-bottom: 5px;"></i>
      <span data-translate="nav-profile-label">Profile</span>
    </a>
  </nav>

  <script>
    // Global variables
    let teamStats = null;
    let userProfile = null;

    // Function to mask phone numbers for privacy
    function maskPhoneNumber(phone) {
      if (!phone) return 'N/A';
      
      // Remove any non-digit characters
      const digits = phone.replace(/\D/g, '');
      
      // Handle different phone number formats
      if (digits.length >= 10) {
        // For Kenyan numbers (+254XXXXXXXXX or 0XXXXXXXXX)
        if (digits.startsWith('254')) {
          // Format: +254 XXX *** XXX
          return `+254 ${digits.slice(3, 6)} *** ${digits.slice(-3)}`;
        } else if (digits.startsWith('0')) {
          // Format: 0XX *** XXX
          return `${digits.slice(0, 3)} *** ${digits.slice(-3)}`;
        } else if (digits.length >= 10) {
          // Generic format: XXX *** XXX
          return `${digits.slice(0, 3)} *** ${digits.slice(-3)}`;
        }
      }
      
      // Fallback: show first 3 and last 3 digits
      if (digits.length >= 6) {
        return `${digits.slice(0, 3)} *** ${digits.slice(-3)}`;
      }
      
      // Very short numbers: mask middle digits
      if (digits.length >= 4) {
        return `${digits.slice(0, 2)} *** ${digits.slice(-2)}`;
      }
      
      // Very short numbers: just show first and last
      if (digits.length >= 3) {
        return `${digits[0]} *** ${digits.slice(-1)}`;
      }
      
      // Too short to mask meaningfully
      return '***';
    }

    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'index.html';
        return false;
      }
      return true;
    }

    // Show/hide loading state
    function showLoading(show = true) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // Show error message
    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error').style.display = 'block';
      setTimeout(() => {
        document.getElementById('error').style.display = 'none';
      }, 5000);
    }

    // Show success message
    function showSuccess(message) {
      document.getElementById('success-message').textContent = message;
      document.getElementById('success').style.display = 'block';
      setTimeout(() => {
        document.getElementById('success').style.display = 'none';
      }, 3000);
    }

    // Load user profile
    async function loadUserProfile() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/user/stats', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Failed to load user profile');
        }

        userProfile = await response.json();
        return userProfile;
      } catch (error) {
        console.error('Error loading user profile:', error);
        showError('Failed to load user profile');
        return null;
      }
    }

    // Load temporary worker status
    async function loadTempWorkerStatus() {
      try {
        console.log('📡 Loading temporary worker status...');
        const token = localStorage.getItem('token');
        const response = await fetch('/api/user/temp-worker-status', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('📡 Response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('❌ API Error:', response.status, errorText);
          throw new Error(`Failed to load temporary worker status: ${response.status} ${errorText}`);
        }

        const tempWorkerData = await response.json();
        console.log('✅ Temp worker data loaded:', tempWorkerData);
        return tempWorkerData;
      } catch (error) {
        console.error('❌ Error loading temp worker status:', error);
        showError('Failed to load temporary worker status: ' + error.message);
        return null;
      }
    }

    // Update UI with temporary worker status
    function updateTempWorkerStatus(data) {
      console.log('🔄 Updating temp worker status:', data);
      
      const tempWorkerSection = document.getElementById('temp-worker-status-section');
      const levelsSection = document.getElementById('levels-section');
      
      if (!tempWorkerSection || !levelsSection) {
        console.error('❌ Required sections not found:', { tempWorkerSection, levelsSection });
        return;
      }
      
      if (data.isTempWorker) {
        console.log('👤 User is temporary worker - showing temp worker section');
        // Show temporary worker status
        tempWorkerSection.style.display = 'block';
        levelsSection.style.display = 'none';
        
        // Update countdown
        const daysEl = document.getElementById('days-remaining');
        const hoursEl = document.getElementById('hours-remaining');
        if (daysEl) daysEl.textContent = data.daysRemaining || 0;
        if (hoursEl) hoursEl.textContent = data.hoursRemaining || 0;
        
        // Start countdown timer
        startTempWorkerCountdown(data.startDate);
      } else {
        console.log('👥 User is regular user - showing levels section');
        // Show team levels for regular users
        tempWorkerSection.style.display = 'none';
        levelsSection.style.display = 'block';
        
        // Update level counts from invitation data
        updateLevelCounts();
      }
      
      console.log('✅ Temp worker status updated successfully');
    }

    // Start countdown timer for temporary workers
    function startTempWorkerCountdown(startDate) {
      const startDateObj = new Date(startDate);
      const totalTrialTime = 5 * 24 * 60 * 60 * 1000; // 5 days in milliseconds (same as home.html)
      
      function updateCountdown() {
        const now = new Date();
        const elapsedTime = now - startDateObj;
        const remainingTime = Math.max(0, totalTrialTime - elapsedTime);

        const daysLeft = Math.floor(remainingTime / (24 * 60 * 60 * 1000));
        const hoursLeft = Math.floor((remainingTime % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const minutesLeft = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
        const secondsLeft = Math.floor((remainingTime % (60 * 1000)) / 1000);

        document.getElementById('days-remaining').textContent = daysLeft;
        document.getElementById('hours-remaining').textContent = hoursLeft;
        document.getElementById('minutes-remaining').textContent = minutesLeft;
        document.getElementById('seconds-remaining').textContent = secondsLeft;

        if (remainingTime <= 0) {
          // Trial period expired
          document.getElementById('temp-worker-status-section').innerHTML = `
            <div class="team-levels">
              <h2 class="section-title">Trial Period Expired</h2>
              <div class="temp-worker-info">
                <div class="temp-worker-card" style="background: linear-gradient(135deg, #f44336, #d32f2f);">
                  <div class="temp-worker-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <div class="temp-worker-content">
                    <div class="temp-worker-title">Trial Period Expired</div>
                    <div class="temp-worker-description">
                      Upgrade to Level 1 to continue earning
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          return;
        }
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);
    }

    // Update level counts from invitation data
    async function updateLevelCounts() {
      try {
        console.log('📊 Loading level counts...');
        const token = localStorage.getItem('token');
        const response = await fetch('/api/user/invitation-users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('📊 Response status:', response.status);

        if (response.ok) {
          const data = await response.json();
          console.log('📊 Invitation data:', data);
          
          const invitedUsers = data.invitedUsers || [];
          console.log('📊 Invited users:', invitedUsers);
          
          // Count users by level (database levels: 0=temporary, 1=level A, 2=level B, 3=level C)
          const levelACount = invitedUsers.filter(user => user.level === 1).length;
          const levelBCount = invitedUsers.filter(user => user.level === 2).length;
          const levelCCount = invitedUsers.filter(user => user.level === 3).length;
          
          console.log('📊 Level counts:', { levelACount, levelBCount, levelCCount });
          
          // Update the display
          const levelAElem = document.getElementById('level-a-count');
          const levelBElem = document.getElementById('level-b-count');
          const levelCElem = document.getElementById('level-c-count');
          
          if (levelAElem) levelAElem.textContent = levelACount;
          if (levelBElem) levelBElem.textContent = levelBCount;
          if (levelCElem) levelCElem.textContent = levelCCount;
          
          console.log('✅ Level counts updated successfully');
        } else {
          const errorText = await response.text();
          console.error('❌ Failed to load invitation data:', response.status, errorText);
        }
      } catch (error) {
        console.error('❌ Error updating level counts:', error);
      }
    }

    // Load daily rewards
    function loadDailyRewards() {
      const rewards = [
        {
          title: 'Invite 1 regular employee today',
          target: 1,
          current: teamStats?.directReferrals || 0,
          icon: 'fas fa-user-plus'
        },
        {
          title: 'Invite 3 regular employees today',
          target: 3,
          current: teamStats?.directReferrals || 0,
          icon: 'fas fa-users'
        },
        {
          title: 'Invite 5 regular employees today',
          target: 5,
          current: teamStats?.directReferrals || 0,
          icon: 'fas fa-user-friends'
        }
      ];

      const container = document.getElementById('rewards-container');
      container.innerHTML = '';

      rewards.forEach(reward => {
        const progress = Math.min((reward.current / reward.target) * 100, 100);
        const isCompleted = reward.current >= reward.target;

        const rewardCard = document.createElement('div');
        rewardCard.className = 'reward-card';
        rewardCard.innerHTML = `
          <div class="reward-icon">
            <i class="${reward.icon}"></i>
          </div>
          <div class="reward-content">
            <div class="reward-title">${reward.title}</div>
            <div class="reward-progress">
              <div class="reward-progress-bar" style="width: 0%"></div>
            </div>
            <div class="reward-status ${isCompleted ? 'completed' : 'pending'}">
              ${isCompleted ? 'Completed' : 'Pending'}
            </div>
          </div>
        `;
        container.appendChild(rewardCard);
        
        // Animate the progress bar
        setTimeout(() => {
          const progressBar = rewardCard.querySelector('.reward-progress-bar');
          if (progressBar) {
            progressBar.style.width = `${progress}%`;
          }
        }, 100 * rewards.indexOf(reward)); // Stagger animations
      });
    }

    // Load invitation tracking data
    async function loadInvitationTracking() {
      try {
        const token = localStorage.getItem('token');
        if (!token) return;

        const response = await fetch('/api/user/invitation-users', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          
          // Update stats
          document.getElementById('total-invited').textContent = data.totalInvited || 0;
          document.getElementById('total-earnings').textContent = `KES ${(data.totalEarnings || 0).toFixed(2)}`;
          document.getElementById('total-pending').textContent = `KES ${(data.totalPendingRewards || 0).toFixed(2)}`;
          
          // Update invited users list
          const container = document.getElementById('invited-users-container');
          if (data.invitedUsers && data.invitedUsers.length > 0) {
            container.innerHTML = `
              <div class="invited-users-table">
                <h3>Invited Users (${data.totalInvited})</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Phone</th>
                      <th>Level</th>
                      <th>Referral Reward</th>
                      <th>Status</th>
                      <th>Joined</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.invitedUsers.map(user => `
                      <tr>
                        <td>${user.name || 'Unknown'}</td>
                        <td>${maskPhoneNumber(user.phone)}</td>
                        <td>Level ${user.level}</td>
                        <td>KES ${parseFloat(user.referral_reward_earned || 0).toFixed(2)}</td>
                        <td>
                          <span class="reward-status ${user.reward_status === 'completed' ? 'completed' : user.reward_status === 'pending' ? 'pending' : 'no-reward'}">
                            ${user.reward_status === 'completed' ? '✅ Completed' : user.reward_status === 'pending' ? '⏳ Pending' : '❌ No Reward'}
                          </span>
                        </td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
          } else {
            container.innerHTML = `
              <div class="no-data">
                <i class="fas fa-users-slash"></i>
                <p>No users have joined using your invitation code yet</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                  Share your invitation code with friends to see them here!
                </p>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Error loading invitation tracking:', error);
        document.getElementById('invited-users-container').innerHTML = `
          <div class="error">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load invitation tracking data</p>
          </div>
        `;
      }
    }



    // Share referral code with embedded invitation code
    function shareReferralCode() {
      if (userProfile?.invitation_code) {
        // Create shareable link with embedded invitation code
        const shareUrl = `${window.location.origin}/signup.html?code=${userProfile.invitation_code}`;
        const shareText = `Join UAI Agency and start earning! Use my invitation code: ${userProfile.invitation_code}\n\nRegister here: ${shareUrl}`;
        
        if (navigator.share) {
          navigator.share({
            title: 'Join UAI Agency',
            text: shareText,
            url: shareUrl
          });
        } else {
          // Fallback: copy to clipboard
          navigator.clipboard.writeText(shareText).then(() => {
            showSuccess('Invitation link copied to clipboard!');
          }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = shareText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccess('Invitation link copied to clipboard!');
          });
        }
      } else {
        showError('Invitation code not available');
      }
    }

    // Initialize page
    async function initializePage() {
      console.log('🚀 Initializing team management page...');
      
      if (!checkAuth()) {
        console.log('❌ Authentication failed');
        return;
      }

      showLoading(true);

      try {
        console.log('📡 Loading user profile and temp worker status...');
        
        // Load user profile and temporary worker status in parallel
        const [profile, tempWorkerStatus] = await Promise.all([
          loadUserProfile(),
          loadTempWorkerStatus()
        ]);

        console.log('📊 Profile loaded:', profile ? '✅' : '❌');
        console.log('👤 Temp worker status loaded:', tempWorkerStatus ? '✅' : '❌');

        if (profile && tempWorkerStatus) {
          console.log('🔄 Updating UI with loaded data...');
          updateTempWorkerStatus(tempWorkerStatus);
          loadDailyRewards();
          await loadInvitationTracking();

          // Show all sections
          const sections = ['tools-section', 'invite-section', 'invitation-tracking-section', 'rewards-section'];
          sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
              section.style.display = 'block';
              console.log(`✅ Showing section: ${sectionId}`);
            } else {
              console.warn(`⚠️ Section not found: ${sectionId}`);
            }
          });
          
          console.log('✅ Page initialization completed successfully');
        } else {
          console.error('❌ Failed to load required data');
          showError('Failed to load user data');
        }
      } catch (error) {
        console.error('❌ Error initializing page:', error);
        showError('Failed to initialize page: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Auto-refresh temporary worker status every 30 seconds
    function startAutoRefresh() {
      setInterval(async () => {
        if (checkAuth()) {
          const tempWorkerStatus = await loadTempWorkerStatus();
          if (tempWorkerStatus) {
            updateTempWorkerStatus(tempWorkerStatus);
            loadDailyRewards();
          }
        }
      }, 30000);
    }

    // Check if Font Awesome icons are loaded
    function checkFontAwesomeIcons() {
      console.log('🔍 Checking Font Awesome icons...');
      
      const testIcon = document.createElement('i');
      testIcon.className = 'fas fa-home';
      testIcon.style.position = 'absolute';
      testIcon.style.left = '-9999px';
      document.body.appendChild(testIcon);
      
      const computedStyle = window.getComputedStyle(testIcon, ':before');
      const fontFamily = computedStyle.getPropertyValue('font-family');
      
      document.body.removeChild(testIcon);
      
      console.log('🔍 Font family detected:', fontFamily);
      
      if (!fontFamily.includes('Font Awesome')) {
        console.warn('⚠️ Font Awesome not loaded, using fallback icons');
        // Add fallback icons using Unicode symbols
        const navItems = document.querySelectorAll('.nav-item i');
        navItems.forEach((icon, index) => {
          const fallbackIcons = ['🏠', '📋', '👥', '📊', '👤'];
          if (fallbackIcons[index]) {
            icon.style.fontFamily = 'Arial, sans-serif';
            icon.textContent = fallbackIcons[index];
            icon.style.fontSize = '1.2rem';
          }
        });
      } else {
        console.log('✅ Font Awesome icons loaded successfully');
      }
      
      // Debug: Check if navigation items exist
      const navItems = document.querySelectorAll('.nav-item');
      console.log('🔍 Navigation items found:', navItems.length);
      navItems.forEach((item, index) => {
        const icon = item.querySelector('i');
        const text = item.querySelector('span');
        console.log(`🔍 Nav item ${index}:`, {
          icon: icon ? icon.className : 'No icon',
          text: text ? text.textContent : 'No text',
          href: item.href
        });
      });
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initializePage();
      startAutoRefresh();
      
      // Check Font Awesome after a short delay
      setTimeout(checkFontAwesomeIcons, 1000);
    });

    // Handle network errors
    window.addEventListener('online', () => {
      showSuccess('Connection restored');
      initializePage();
    });

    window.addEventListener('offline', () => {
      showError('No internet connection');
    });
    
    // Initialize language manager immediately
    (async function() {
      // Load language manager
      const script = document.createElement('script');
      script.src = 'js/language-manager.js';
      document.head.appendChild(script);
      
      script.onload = async function() {
        if (window.languageManager) {
          await window.languageManager.init();
          console.log('🌍 Language manager loaded and initialized on team management page');
        }
      };
    })();
  </script>
</body>
</html>

