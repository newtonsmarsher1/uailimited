<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Account - UAI Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: linear-gradient(to bottom, #2979ff 0%, #e3f0ff 100%); 
      margin: 0; 
    }
    .container { 
      max-width: 1200px; 
      margin: 40px auto; 
      background: #fff; 
      border-radius: 18px; 
      box-shadow: 0 2px 16px #2979ff22; 
      padding: 32px 24px; 
    }
    h1 { 
      color: #2979ff; 
      text-align: center; 
      margin-bottom: 24px; 
    }
    .back-btn {
      background: #2979ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    .back-btn:hover {
      background: #1565c0;
      transform: translateY(-1px);
    }
    
    /* Wallet Section */
    .wallet-section {
      background: linear-gradient(135deg, #2979ff 0%, #ad7ce6 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 25px rgba(41, 121, 255, 0.3);
    }
    .wallet-header {
      text-align: center;
      margin-bottom: 25px;
    }
    .wallet-header h2 {
      margin: 0 0 10px 0;
      font-size: 1.8em;
    }
    .wallet-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1.1em;
    }
    .wallet-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .wallet-stat {
      background: rgba(255, 255, 255, 0.15);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    .wallet-stat h3 {
      margin: 0 0 10px 0;
      font-size: 1.1em;
      opacity: 0.9;
    }
    .wallet-stat .amount {
      font-size: 2.2em;
      font-weight: bold;
      margin: 0;
    }
    .wallet-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .wallet-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }
    .wallet-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      border-bottom: 2px solid #e3f0ff;
      padding-bottom: 10px;
    }
    .tab-btn {
      background: #f8f9ff;
      color: #2979ff;
      border: 2px solid #e3f0ff;
      border-radius: 8px;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .tab-btn.active {
      background: #2979ff;
      color: white;
      border-color: #2979ff;
    }
    .tab-btn:hover {
      background: #2979ff;
      color: white;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    /* Withdrawal Requests Table */
    .withdrawal-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .withdrawal-table th,
    .withdrawal-table td {
      padding: 15px 12px;
      text-align: left;
      border-bottom: 1px solid #e3f0ff;
    }
    .withdrawal-table th {
      background: #2979ff;
      color: white;
      font-weight: 600;
    }
    .withdrawal-table tr:hover {
      background: #f8f9ff;
    }
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    .status-approved {
      background: #d4edda;
      color: #155724;
    }
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    /* Action Buttons */
    .action-btn {
      background: #2979ff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      margin-right: 8px;
      font-size: 0.9em;
      transition: all 0.3s;
    }
    .action-btn:hover {
      background: #1565c0;
      transform: translateY(-1px);
    }
    .action-btn.approve {
      background: #4caf50;
    }
    .action-btn.approve:hover {
      background: #388e3c;
    }
    .action-btn.reject {
      background: #f44336;
    }
    .action-btn.reject:hover {
      background: #d32f2f;
    }
    
    /* Commission Info */
    .commission-info {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }
    .commission-info h3 {
      margin: 0 0 15px 0;
      text-align: center;
    }
    .commission-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .commission-item {
      background: rgba(255, 255, 255, 0.15);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .commission-item h4 {
      margin: 0 0 8px 0;
      font-size: 1.1em;
    }
    .commission-item p {
      margin: 0;
      font-size: 1.2em;
      font-weight: bold;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #e3f0ff;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .modal input:focus, .modal textarea:focus {
      outline: none;
      border-color: #2979ff;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 20px;
    }
    .modal-btn {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .modal-btn.cancel {
      background: #6c757d;
      color: white;
    }
    .modal-btn.cancel:hover {
      background: #5a6268;
    }
    .modal-btn.confirm {
      background: #2979ff;
      color: white;
    }
    .modal-btn.confirm:hover {
      background: #1565c0;
    }
    
    /* Message */
    .message {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-weight: 600;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <button onclick="window.location.href='dashboard.html'" class="back-btn">&larr; Back to Dashboard</button>
    <h1>ðŸ’° Your Account</h1>
    
    <!-- Wallet Section -->
    <div class="wallet-section">
      <div class="wallet-header">
        <h2>Admin Wallet</h2>
        <p>Manage your earnings and withdrawal approvals</p>
      </div>
      
      <div class="wallet-stats">
        <div class="wallet-stat">
          <h3>Current Balance</h3>
          <div class="amount" id="currentBalance">KES 0</div>
        </div>
        <div class="wallet-stat">
          <h3>Total Earnings</h3>
          <div class="amount" id="totalEarnings">KES 0</div>
        </div>
        <div class="wallet-stat">
          <h3>Total Withdrawals</h3>
          <div class="amount" id="totalWithdrawals">KES 0</div>
        </div>
        <div class="wallet-stat">
          <h3>Pending Approvals</h3>
          <div class="amount" id="pendingApprovals">0</div>
        </div>
      </div>
      
      <div class="wallet-actions">
        <button class="wallet-btn" onclick="showWithdrawModal()">Withdraw Funds</button>
        <button class="wallet-btn" onclick="refreshWallet()">Refresh Balance</button>
      </div>
    </div>
    
         <!-- Commission Information -->
     <div class="commission-info">
       <h3>ðŸ’¡ Commission Structure</h3>
       <div class="commission-details">
         <div class="commission-item">
           <h4>Approval Commission</h4>
           <p>3% per approval</p>
         </div>
         <div class="commission-item">
           <h4>Withdrawal Fee</h4>
           <p>10% total</p>
         </div>
         <div class="commission-item">
           <h4>Admin Share</h4>
           <p>3% of withdrawal</p>
         </div>
       </div>
     </div>
    
         <!-- Tabs -->
     <div class="tabs">
       <button class="tab-btn active" onclick="showTab('withdrawals')">Your Approved Withdrawals</button>
       <button class="tab-btn" onclick="showTab('history')">Approval History</button>
       <button class="tab-btn" onclick="showTab('earnings')">Earnings History</button>
     </div>
    
         <!-- Withdrawals Tab -->
     <div id="withdrawals-tab" class="tab-content active">
       <h3>Your Approved Withdrawals</h3>
       <p style="color: #666; margin-bottom: 20px;">This shows withdrawals you have approved. To approve new withdrawals, go to <a href="withdrawals.html" style="color: #2979ff; text-decoration: none; font-weight: bold;">Manage Withdrawals</a>.</p>
       <table class="withdrawal-table" id="withdrawalsTable">
         <thead>
           <tr>
             <th>ID</th>
             <th>User</th>
             <th>Phone</th>
             <th>Amount</th>
             <th>Bank Details</th>
             <th>Commission Earned</th>
             <th>Status</th>
             <th>Date</th>
           </tr>
         </thead>
         <tbody id="withdrawalsTableBody">
           <tr>
             <td colspan="8" class="loading">Loading your approved withdrawals...</td>
           </tr>
         </tbody>
       </table>
     </div>
    
    <!-- History Tab -->
    <div id="history-tab" class="tab-content">
      <h3>Approval History</h3>
      <table class="withdrawal-table" id="historyTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Amount</th>
            <th>Commission Earned</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="historyTableBody">
          <tr>
            <td colspan="6" class="loading">Loading approval history...</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Earnings Tab -->
    <div id="earnings-tab" class="tab-content">
      <h3>Earnings History</h3>
      <table class="withdrawal-table" id="earningsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody id="earningsTableBody">
          <tr>
            <td colspan="4" class="loading">Loading earnings history...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
             <h3>Withdraw Funds</h3>
       <p>Current Balance: <strong id="modalBalance">KES 0</strong></p>
       <p><strong>Note:</strong> 10% fee will be deducted (3% to admin pool, 7% to system)</p>
      
      <label for="withdrawAmount">Amount to Withdraw (KES):</label>
      <input type="number" id="withdrawAmount" placeholder="Enter amount" min="100" step="100">
      
      <label for="withdrawReason">Reason (Optional):</label>
      <textarea id="withdrawReason" placeholder="Enter withdrawal reason" rows="3"></textarea>
      
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeWithdrawModal()">Cancel</button>
        <button class="modal-btn confirm" onclick="processWithdrawal()">Withdraw</button>
      </div>
    </div>
  </div>
  
  
  
  <script>
    let currentTab = 'withdrawals';
    let adminWallet = {
      balance: 0,
      totalEarnings: 0,
      totalWithdrawals: 0,
      pendingApprovals: 0
    };
    
         // Initialize page
     document.addEventListener('DOMContentLoaded', function() {
       // Get admin ID from localStorage - try different possible keys
       let adminId = localStorage.getItem('userId') || 
                    localStorage.getItem('adminId') || 
                    localStorage.getItem('id');
       
       // If still no admin ID, try to get it from the current session
       if (!adminId) {
         // Check if we're logged in by looking for other session data
         const userRole = localStorage.getItem('userRole');
         const userName = localStorage.getItem('userName');
         
         if (userRole && userName) {
           // We're logged in, just need to find the admin ID
           // For now, let's use a default or try to get it from the server
           adminId = '1'; // Default admin ID - you may need to adjust this
         } else {
           showMessage('Please log in to access your account', 'error');
           setTimeout(() => {
             window.location.href = 'index.html';
           }, 2000);
           return;
         }
       }
       
       loadWalletData(adminId);
       loadWithdrawals();
     });
    
    // Tab functions
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      currentTab = tabName;
      
      // Load tab data
      switch(tabName) {
        case 'withdrawals':
          loadWithdrawals();
          break;
        case 'history':
          loadApprovalHistory();
          break;
        case 'earnings':
          loadEarningsHistory();
          break;
      }
    }
    
         // Wallet functions
     async function loadWalletData(adminId) {
       try {
         const response = await fetch(`/api/admin/wallet?adminId=${adminId}`);
         if (!response.ok) throw new Error('Failed to load wallet data');
         
         const data = await response.json();
         adminWallet = data;
         
         updateWalletDisplay();
         
         // Also load approved withdrawals to calculate real-time earnings
         await loadWithdrawals();
       } catch (error) {
         console.error('Error loading wallet data:', error);
         showMessage('Failed to load wallet data', 'error');
       }
     }
    
         function updateWalletDisplay() {
       document.getElementById('currentBalance').textContent = `KES ${adminWallet.balance.toLocaleString()}`;
       document.getElementById('totalEarnings').textContent = `KES ${adminWallet.totalEarnings.toLocaleString()}`;
       document.getElementById('totalWithdrawals').textContent = `KES ${adminWallet.totalWithdrawals.toLocaleString()}`;
       document.getElementById('pendingApprovals').textContent = adminWallet.pendingApprovals;
     }
     
     // Calculate real-time earnings from approved withdrawals
     function calculateRealTimeEarnings(withdrawals) {
       const totalEarnings = withdrawals.reduce((sum, withdrawal) => {
         return sum + (withdrawal.amount * 0.03); // 3% commission
       }, 0);
       
       document.getElementById('totalEarnings').textContent = `KES ${totalEarnings.toLocaleString()}`;
       return totalEarnings;
     }
    
         async function refreshWallet() {
       const adminId = localStorage.getItem('userId');
       await loadWalletData(adminId);
       showMessage('Wallet refreshed successfully', 'success');
     }
    
         // Withdrawal functions
     async function loadWithdrawals() {
       try {
         const adminId = localStorage.getItem('userId') || localStorage.getItem('adminId') || localStorage.getItem('id') || '1';
         const response = await fetch(`/api/admin/approved-withdrawals?adminId=${adminId}`);
         if (!response.ok) throw new Error('Failed to load approved withdrawals');
         
         const withdrawals = await response.json();
         renderWithdrawals(withdrawals);
         
         // Calculate and update real-time earnings
         calculateRealTimeEarnings(withdrawals);
       } catch (error) {
         console.error('Error loading approved withdrawals:', error);
         document.getElementById('withdrawalsTableBody').innerHTML = 
           '<tr><td colspan="8" class="no-data">Failed to load approved withdrawals</td></tr>';
       }
     }
    
         function renderWithdrawals(withdrawals) {
       const tbody = document.getElementById('withdrawalsTableBody');
       tbody.innerHTML = '';
       
       if (withdrawals.length === 0) {
         tbody.innerHTML = '<tr><td colspan="8" class="no-data">No approved withdrawals found</td></tr>';
         return;
       }
       
       withdrawals.forEach(withdrawal => {
         const commission = withdrawal.amount * 0.03; // 3% commission on display amount (90%)
         const tr = document.createElement('tr');
         tr.innerHTML = `
           <td>${withdrawal.id}</td>
           <td>${withdrawal.user_name || `User ${withdrawal.user_id}`}</td>
           <td>${withdrawal.user_phone || 'N/A'}</td>
           <td><strong>KES ${parseFloat(withdrawal.amount).toLocaleString()}</strong></td>
           <td>
             <div style="filter: blur(3px); color: #999;"><strong>${withdrawal.bank_name || 'N/A'}</strong></div>
             <div style="filter: blur(3px); font-size: 0.9em; color: #999;">${withdrawal.account_number || 'N/A'}</div>
           </td>
           <td><strong style="color: #4caf50;">KES ${commission.toLocaleString()}</strong></td>
           <td><span class="status-badge status-approved">Approved</span></td>
           <td>${new Date(withdrawal.approved_at || withdrawal.created_at).toLocaleDateString()}</td>
         `;
         tbody.appendChild(tr);
       });
     }
    
    
    
    // Withdrawal modal functions
    function showWithdrawModal() {
      document.getElementById('modalBalance').textContent = `KES ${adminWallet.balance.toLocaleString()}`;
      document.getElementById('withdrawModal').style.display = 'block';
    }
    
    function closeWithdrawModal() {
      document.getElementById('withdrawModal').style.display = 'none';
      document.getElementById('withdrawAmount').value = '';
      document.getElementById('withdrawReason').value = '';
    }
    
         async function processWithdrawal() {
       const amount = parseFloat(document.getElementById('withdrawAmount').value);
       const reason = document.getElementById('withdrawReason').value;
       const adminId = localStorage.getItem('userId');
       
       if (!amount || amount <= 0) {
         showMessage('Please enter a valid amount', 'error');
         return;
       }
       
       if (amount > adminWallet.balance) {
         showMessage('Insufficient balance', 'error');
         return;
       }
       
       try {
         const response = await fetch('/api/admin/withdraw-funds', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
             amount: amount,
             reason: reason,
             adminId: adminId
           })
         });
         
         if (!response.ok) throw new Error('Failed to process withdrawal');
         
         closeWithdrawModal();
         showMessage('Withdrawal request submitted successfully', 'success');
         loadWalletData(adminId);
       } catch (error) {
         console.error('Error processing withdrawal:', error);
         showMessage('Failed to process withdrawal', 'error');
       }
     }
    
    // History functions
         async function loadApprovalHistory() {
       try {
         const adminId = localStorage.getItem('userId');
         const response = await fetch(`/api/admin/approval-history?adminId=${adminId}`);
         if (!response.ok) throw new Error('Failed to load approval history');
         
         const history = await response.json();
         renderApprovalHistory(history);
       } catch (error) {
         console.error('Error loading approval history:', error);
         document.getElementById('historyTableBody').innerHTML = 
           '<tr><td colspan="6" class="no-data">Failed to load approval history</td></tr>';
       }
     }
    
    function renderApprovalHistory(history) {
      const tbody = document.getElementById('historyTableBody');
      tbody.innerHTML = '';
      
      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No approval history found</td></tr>';
        return;
      }
      
      history.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.withdrawal_id}</td>
          <td>${item.user_name || `User ${item.user_id}`}</td>
          <td><strong>KES ${parseFloat(item.amount).toLocaleString()}</strong></td>
          <td><strong>KES ${parseFloat(item.commission_earned).toLocaleString()}</strong></td>
          <td><span class="status-badge status-approved">Approved</span></td>
          <td>${new Date(item.approved_at).toLocaleDateString()}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
         async function loadEarningsHistory() {
       try {
         const adminId = localStorage.getItem('userId');
         const response = await fetch(`/api/admin/earnings-history?adminId=${adminId}`);
         if (!response.ok) throw new Error('Failed to load earnings history');
         
         const earnings = await response.json();
         renderEarningsHistory(earnings);
       } catch (error) {
         console.error('Error loading earnings history:', error);
         document.getElementById('earningsTableBody').innerHTML = 
           '<tr><td colspan="4" class="no-data">Failed to load earnings history</td></tr>';
       }
     }
    
    function renderEarningsHistory(earnings) {
      const tbody = document.getElementById('earningsTableBody');
      tbody.innerHTML = '';
      
      if (earnings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">No earnings history found</td></tr>';
        return;
      }
      
      earnings.forEach(earning => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(earning.created_at).toLocaleDateString()}</td>
          <td>${earning.type}</td>
          <td><strong>KES ${parseFloat(earning.amount).toLocaleString()}</strong></td>
          <td>${earning.description}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Utility functions
    function showMessage(message, type) {
      // Remove existing messages
      const existingMessage = document.querySelector('.message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // Create new message
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      
      // Insert at top of container
      const container = document.querySelector('.container');
      container.insertBefore(messageDiv, container.firstChild);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      const withdrawModal = document.getElementById('withdrawModal');
      const approvalModal = document.getElementById('approvalModal');
      
      if (event.target === withdrawModal) {
        closeWithdrawModal();
      }
      if (event.target === approvalModal) {
        closeApprovalModal();
      }
    }
  </script>
</body>
</html>
