<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Registration - UAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(to bottom, #2979ff 0%, #e3f0ff 100%); margin: 0; }
    .container { max-width: 420px; margin: 60px auto 0 auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 16px #2979ff22; padding: 32px 24px; }
    .logo-row { display: flex; flex-direction: column; align-items: center; margin-bottom: 32px; }
    .hexagon { width: 60px; height: 60px; background: #bd7de7; clip-path: polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%); margin-bottom: 8px; box-shadow: 0 2px 10px rgba(98, 142, 219, 0.15); position: relative; }
    .uai-in-hex { position: absolute; top: 0; left: 50%; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; transform: translate(-50%, 0); pointer-events: none; z-index: 2; }
    .uai-in-hex span { color: #fff; font-size: 2em; font-weight: 700; letter-spacing: 2px; text-shadow: 0 2px 8px #7a09c577, 0 0 2px #4f2b7c; display: inline-block; }
    h1 { text-align: center; color: #2979ff; font-size: 2em; margin-bottom: 24px; }
    .register-form { display: flex; flex-direction: column; gap: 18px; }
    .input-row { display: flex; align-items: center; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(41,121,255,0.07); padding: 0 12px; border: 1px solid #b3c6ff; position: relative; min-height: 50px; }
    .input-icon { font-size: 1.2em; color: #2979ff; margin-right: 8px; }
    input, select { border: none; outline: none; background: transparent; padding: 14px 0; font-size: 1em; flex: 1; }
    .register-btn { width: 100%; padding: 14px 0; background: linear-gradient(90deg, #2979ff 0%, #1565c0 100%); color: #fff; font-size: 1.08em; font-weight: 600; border: none; border-radius: 24px; margin-top: 10px; box-shadow: 0 2px 8px rgba(41,121,255,0.12); cursor: pointer; transition: background 0.2s; }
    .register-btn:hover:not(:disabled) { background: linear-gradient(90deg, #1565c0 0%, #2979ff 100%); }
    .register-btn:disabled { cursor: not-allowed; opacity: 0.7; }
    .info-message { color: #2979ff; font-size: 0.98em; text-align: center; margin-top: 10px; }
    .error-message { color: #d32f2f; font-size: 0.95em; text-align: center; margin-top: 10px; }
    .success-message { color: #388e3c; font-size: 1em; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-row">
      <div class="hexagon">
        <div class="uai-in-hex"><span>UAI</span></div>
      </div>
    </div>
    <h1>Admin Registration</h1>
    <form class="register-form" id="registerForm">
      <input type="hidden" id="firstLoginMode" value="false">
      <input type="hidden" id="userId" name="userId">
      <div class="input-row" id="usernameRow">
        <span class="input-icon">&#128100;</span>
        <input type="text" name="username" id="username" placeholder="Username" required autocomplete="username">
      </div>
      <div class="input-row">
        <span class="input-icon">&#128274;</span>
        <input type="password" id="password" name="password" placeholder="Password" required autocomplete="new-password">
        <button type="button" id="togglePassword">Show</button>
      </div>
      <div class="input-row">
        <span class="input-icon">&#128221;</span>
        <input type="text" name="name" id="name" placeholder="Full Name" required>
      </div>
      <div class="input-row">
        <span class="input-icon">&#128290;</span>
        <input type="text" name="id_number" id="id_number" placeholder="ID Number" required>
      </div>
      <div class="input-row">
        <span class="input-icon">&#128222;</span>
        <input type="text" name="mobile" id="mobile" placeholder="Mobile Number" required>
      </div>
      <div class="input-row">
        <span class="input-icon">&#128231;</span>
        <input type="email" name="gmail" id="gmail" placeholder="Gmail" required>
      </div>
      
      <div class="input-row" id="roleRow">
        <span class="input-icon">&#128188;</span>
        <label for="roleSelect" style="display:none;">Role</label>
        <select name="role" id="roleSelect" required title="Role">
          <option value="HR Manager">HR Manager</option>
          <option value="Financial Manager">Financial Manager</option>
          <option value="Assistant Manager">Assistant Manager</option>
          <option value="Worker">Worker</option>
          <option value="CEO">C.E.O</option>
        </select>
      </div>
      <button type="submit" class="register-btn" id="registerBtn">Register</button>
             <div class="info-message" id="infoMsg">* Your account must be verified by the CEO before you can log in (except CEO).<br>* Each person can only register once - names, phone numbers, and emails must be unique.</div>
      <div class="error-message" id="errorMsg"></div>
      <div class="success-message" id="successMsg"></div>
    </form>
  </div>
  <script>
    // --- First Login Mode Detection ---
    // If redirected for first login, pass data via localStorage or query params
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const firstLogin = localStorage.getItem('firstLogin') === 'true';
    if (firstLogin) {
      document.getElementById('firstLoginMode').value = 'true';
      document.getElementById('registerBtn').textContent = 'Complete Registration';
      document.getElementById('infoMsg').textContent = 'Set your details and new password to complete registration.';
      // Pre-fill and hide username and role
      const username = localStorage.getItem('firstLoginUsername') || '';
      const role = localStorage.getItem('firstLoginRole') || '';
      const userId = localStorage.getItem('firstLoginUserId') || '';
      document.getElementById('username').value = username;
      document.getElementById('roleSelect').value = role;
      document.getElementById('userId').value = userId;
      document.getElementById('usernameRow').style.display = 'none';
      document.getElementById('roleRow').style.display = 'none';
    }

    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = this;
      const registerBtn = document.getElementById('registerBtn');
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      
      // Clear previous messages
      errorMsg.textContent = '';
      successMsg.textContent = '';
      
      // Prevent duplicate submissions
      registerBtn.disabled = true;
      registerBtn.textContent = 'Processing...';
      
      const isFirstLogin = document.getElementById('firstLoginMode').value === 'true';
      if (isFirstLogin) {
        // Complete registration flow
                 const data = {
           userId: document.getElementById('userId').value,
           password: form.password.value,
           name: form.name.value.trim(),
           id_number: form.id_number.value.trim(),
           mobile: form.mobile.value.trim(),
           gmail: form.gmail.value.trim()
         };
        try {
          const res = await fetch('/api/admin/complete-registration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            successMsg.textContent = 'Registration complete! You can now log in with your new password.';
            localStorage.removeItem('firstLogin');
            localStorage.removeItem('firstLoginUsername');
            localStorage.removeItem('firstLoginRole');
            localStorage.removeItem('firstLoginUserId');
            setTimeout(() => window.location.href = 'index.html', 1500);
          } else {
            const err = await res.json();
            errorMsg.textContent = err.error || 'Failed to complete registration.';
          }
        } catch (err) {
          errorMsg.textContent = 'Failed to complete registration.';
        } finally {
          // Re-enable button
          registerBtn.disabled = false;
          registerBtn.textContent = 'Complete Registration';
        }
      } else {
        // Normal registration flow
                 const data = {
           username: form.username.value.trim(),
           password: form.password.value,
           name: form.name.value.trim(),
           id_number: form.id_number.value.trim(),
           mobile: form.mobile.value.trim(),
           gmail: form.gmail.value.trim(),
           role: form.role.value
         };

        // Basic validation
        if (!data.username || !data.password || !data.name || !data.mobile || !data.gmail) {
          errorMsg.textContent = 'Please fill in all required fields.';
          registerBtn.disabled = false;
          registerBtn.textContent = 'Register';
          return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.gmail)) {
          errorMsg.textContent = 'Please enter a valid email address.';
          registerBtn.disabled = false;
          registerBtn.textContent = 'Register';
          return;
        }

        // Validate mobile number (basic check)
        if (data.mobile.length < 10) {
          errorMsg.textContent = 'Please enter a valid mobile number (at least 10 digits).';
          registerBtn.disabled = false;
          registerBtn.textContent = 'Register';
          return;
        }

        // Validate name (no numbers, minimum length)
        const nameRegex = /^[a-zA-Z\s]+$/;
        if (!nameRegex.test(data.name) || data.name.length < 2) {
          errorMsg.textContent = 'Please enter a valid name (letters only, minimum 2 characters).';
          registerBtn.disabled = false;
          registerBtn.textContent = 'Register';
          return;
        }
        try {
          const res = await fetch('/api/admin/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            successMsg.textContent = 'Registration successful! Please wait for CEO verification before logging in.';
            form.reset();
          } else {
            const err = await res.json();
            errorMsg.textContent = err.error || 'Registration failed.';
          }
        } catch (err) {
          errorMsg.textContent = 'Registration failed. Please check your connection and try again.';
        } finally {
          // Re-enable button
          registerBtn.disabled = false;
          registerBtn.textContent = 'Register';
        }
      }
    });

    const passwordInput = document.getElementById('password');
    const toggleButton = document.getElementById('togglePassword');
    toggleButton.addEventListener('click', function () {
      const type = passwordInput.type === 'password' ? 'text' : 'password';
      passwordInput.type = type;
      this.textContent = type === 'password' ? 'Show' : 'Hide';
    });
  </script>
</body>
</html> 
