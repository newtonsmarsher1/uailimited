<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CEO Control Panel - UAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
      min-height: 100vh;
      color: #333;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 20px;
    }
    .header {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
    }
    .logo-row { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .hexagon { width: 60px; height: 60px; background: #bd7de7; clip-path: polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%); margin-bottom: 8px; box-shadow: 0 2px 10px rgba(98, 142, 219, 0.15); position: relative; }
    .uai-in-hex { position: absolute; top: 0; left: 50%; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; transform: translate(-50%, 0); pointer-events: none; z-index: 2; }
    .uai-in-hex span { color: #fff; font-size: 2em; font-weight: 700; letter-spacing: 2px; text-shadow: 0 2px 8px #7a09c577, 0 0 2px #4f2b7c; display: inline-block; }
    h1 { color: #2979ff; font-size: 2.5em; margin-bottom: 10px; }
    .subtitle { color: #666; font-size: 1.1em; }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .card:hover { transform: translateY(-5px); }
    
    .card h2 {
      color: #2979ff;
      font-size: 1.5em;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .input-row { 
      display: flex; 
      align-items: center; 
      background: #f8f9fa; 
      border-radius: 10px; 
      padding: 0 15px; 
      border: 2px solid #e9ecef; 
      position: relative; 
      min-height: 50px;
      margin-bottom: 15px;
      transition: border-color 0.3s;
    }
    .input-row:focus-within { border-color: #2979ff; }
    
    .input-icon { font-size: 1.2em; color: #2979ff; margin-right: 10px; }
    
    input, select, textarea { 
      border: none; 
      outline: none; 
      background: transparent; 
      padding: 12px 0; 
      font-size: 1em; 
      flex: 1;
      color: #333;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }
    
    .btn-primary { background: linear-gradient(45deg, #2979ff, #1565c0); color: white; }
    .btn-primary:hover { background: linear-gradient(45deg, #1565c0, #2979ff); }
    
    .btn-success { background: linear-gradient(45deg, #4caf50, #2e7d32); color: white; }
    .btn-success:hover { background: linear-gradient(45deg, #2e7d32, #4caf50); }
    
    .btn-warning { background: linear-gradient(45deg, #ff9800, #f57c00); color: white; }
    .btn-warning:hover { background: linear-gradient(45deg, #f57c00, #ff9800); }
    
    .btn-danger { background: linear-gradient(45deg, #f44336, #d32f2f); color: white; }
    .btn-danger:hover { background: linear-gradient(45deg, #d32f2f, #f44336); }
    
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }
    
    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2979ff;
    }
    
    .data-table tr:hover {
      background: #f8f9fa;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-online { background: #4caf50; }
    .status-offline { background: #f44336; }
    .status-suspended { background: #ff9800; }
    
    .notification-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #2979ff;
    }
    
    .notification-item.unread {
      background: #e3f2fd;
      border-left-color: #2196f3;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .success {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="toast" style="display:none;position:fixed;top:32px;left:50%;transform:translateX(-50%);min-width:220px;max-width:90vw;padding:12px 28px;border-radius:8px;font-size:1.08em;z-index:9999;box-shadow:0 2px 12px #2979ff22;opacity:0;transition:opacity 0.4s, top 0.4s;"></div>
  
  <div class="container">
    <button onclick="window.location.href='dashboard.html'" class="btn btn-primary" style="margin-bottom:20px;">&larr; Back to Dashboard</button>
    
    <div class="header">
    <div class="logo-row">
      <div class="hexagon">
        <div class="uai-in-hex"><span>UAI</span></div>
      </div>
    </div>
      <h1>CEO Control Panel</h1>
      <p class="subtitle">Complete administrative control and system management</p>
    </div>

    <div class="grid">
      <!-- Password Management -->
      <div class="card">
        <h2>üîê Password Management</h2>
        <div class="form-group">
      <div class="input-row">
        <span class="input-icon">üë§</span>
            <select id="adminSelect" required>
              <option value="">Select Admin to Manage</option>
        </select>
      </div>
      <div class="input-row">
            <span class="input-icon">üîí</span>
            <input type="password" id="newPassword" placeholder="New Password" required>
          </div>
          <div class="input-row">
            <span class="input-icon">üîí</span>
            <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
          </div>
          <button onclick="changeAdminPassword()" class="btn btn-primary">Change Admin Password</button>
        </div>
        
        <h3 style="margin-top: 30px; color: #2979ff;">Change CEO Password</h3>
        <div class="form-group">
          <div class="input-row">
            <span class="input-icon">üîí</span>
            <input type="password" id="ceoOldPassword" placeholder="Current CEO Password" required>
          </div>
          <div class="input-row">
            <span class="input-icon">üîí</span>
            <input type="password" id="ceoNewPassword" placeholder="New CEO Password" required>
          </div>
          <div class="input-row">
            <span class="input-icon">üîí</span>
            <input type="password" id="ceoConfirmPassword" placeholder="Confirm New Password" required>
          </div>
          <button onclick="changeCEOPassword()" class="btn btn-warning">Change CEO Password</button>
        </div>
      </div>

      <!-- Admin Management -->
      <div class="card">
        <h2>üë• Admin Management</h2>
        <div id="adminsList" class="loading">Loading admins...</div>
        <button onclick="loadAdmins()" class="btn btn-primary">Refresh Admins</button>
      </div>

      <!-- Server Management -->
      <div class="card">
        <h2>üñ•Ô∏è Server Management</h2>
        <div id="serverStatus" class="loading">Checking server status...</div>
        <div style="margin-top: 15px;">
          <button onclick="startAllServers()" class="btn btn-success">Start All Servers</button>
          <button onclick="restartAllServers()" class="btn btn-warning">Restart All Servers</button>
          <button onclick="checkServerStatus()" class="btn btn-primary">Check Status</button>
        </div>
      </div>

      <!-- Notification Center -->
      <div class="card">
        <h2>üîî Notification Center</h2>
        <div id="notificationsList" class="loading">Loading notifications...</div>
        <button onclick="loadNotifications()" class="btn btn-primary">Refresh Notifications</button>
      </div>

      <!-- Financial Overview -->
      <div class="card">
        <h2>üí∞ Financial Overview</h2>
        <div id="financialData" class="loading">Loading financial data...</div>
        <button onclick="loadFinancialData()" class="btn btn-primary">Refresh Data</button>
      </div>

      <!-- System Statistics -->
      <div class="card">
        <h2>üìä System Statistics</h2>
        <div id="systemStats" class="loading">Loading statistics...</div>
        <button onclick="loadSystemStats()" class="btn btn-primary">Refresh Stats</button>
      </div>

      <!-- Data Management -->
      <div class="card">
        <h2>üßπ Data Management</h2>
        <p style="color: #666; margin-bottom: 20px;">Clear outdated recharge and withdrawal requests to keep the system clean and organized.</p>
        
        <div style="margin-bottom: 20px;">
          <h3 style="color: #2979ff; margin-bottom: 15px;">üìã Current Records</h3>
          <div id="recordsStats" class="loading">Loading records statistics...</div>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="color: #2979ff; margin-bottom: 15px;">‚öôÔ∏è Clear Options</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px;">
              <h4 style="color: #856404; margin-bottom: 10px;">üîÑ Recharge Records</h4>
              <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="clear-recharge-pending" style="margin-right: 8px;">
                  <span>Pending Recharges</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="clear-recharge-approved" style="margin-right: 8px;">
                  <span>Approved Recharges</span>
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" id="clear-recharge-rejected" style="margin-right: 8px;">
                  <span>Rejected Recharges</span>
                </label>
              </div>
            </div>
            
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px;">
              <h4 style="color: #0c5460; margin-bottom: 10px;">üí∏ Withdrawal Records</h4>
              <div style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="clear-withdrawal-pending" style="margin-right: 8px;">
                  <span>Pending Withdrawals</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="clear-withdrawal-approved" style="margin-right: 8px;">
                  <span>Approved Withdrawals</span>
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" id="clear-withdrawal-rejected" style="margin-right: 8px;">
                  <span>Rejected Withdrawals</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <button onclick="clearSelectedRecords()" class="btn btn-warning">üßπ Clear Selected Records</button>
          <button onclick="clearAllRecords()" class="btn btn-danger">‚ö†Ô∏è Clear All Records</button>
          <button onclick="loadRecordsStats()" class="btn btn-primary">üîÑ Refresh Stats</button>
        </div>

        <div id="clearResults" style="display: none; margin-top: 20px; padding: 15px; border-radius: 8px;"></div>
      </div>
    </div>
  </div>
  <script>
    // Redirect non-CEO users to dashboard
    if (localStorage.getItem('userRole') !== 'CEO') {
      window.location.replace('dashboard.html');
    }

    // Toast notification system
    function showToast(message, color = '#2979ff') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = color;
      toast.style.color = '#fff';
      toast.style.display = 'block';
      toast.style.opacity = '1';
      toast.style.top = '32px';
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.top = '12px';
      }, 3000);
      setTimeout(() => {
        toast.style.display = 'none';
        toast.style.top = '32px';
      }, 3500);
    }

    // Load admins and populate dropdown
    async function loadAdmins() {
      try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();
        
        if (Array.isArray(data)) {
          const adminSelect = document.getElementById('adminSelect');
          const adminsList = document.getElementById('adminsList');
          
          // Clear existing options
          adminSelect.innerHTML = '<option value="">Select Admin to Manage</option>';
          
          if (data.length === 0) {
            // No admins found
            adminsList.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #666;">
                <h3>No Admin Users Found</h3>
                <p>There are currently no admin users in the system.</p>
                <p>All users in the database have regular user privileges.</p>
                <div style="margin-top: 20px;">
                  <button onclick="createAdminUsers()" class="btn btn-primary">Create Sample Admin Users</button>
                </div>
              </div>
            `;
            return;
          }
          
          // Populate dropdown
          data.forEach(admin => {
            const option = document.createElement('option');
            option.value = admin.id;
            option.textContent = `${admin.name} (${admin.role})`;
            adminSelect.appendChild(option);
          });
          
          // Display admins table
          let tableHTML = '<table class="data-table"><thead><tr><th>Name</th><th>Role</th><th>Position</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
          data.forEach(admin => {
            const statusClass = admin.is_active ? 'status-online' : 'status-suspended';
            const statusText = admin.is_active ? 'Active' : 'Suspended';
            const actionBtn = admin.is_active ? 
              `<button onclick="suspendAdmin(${admin.id})" class="btn btn-danger">Suspend</button>` :
              `<button onclick="activateAdmin(${admin.id})" class="btn btn-success">Activate</button>`;
            
            tableHTML += `
              <tr>
                <td>${admin.name}</td>
                <td>${admin.role}</td>
                <td>${admin.position || 'N/A'}</td>
                <td><span class="status-indicator ${statusClass}"></span>${statusText}</td>
                <td>${actionBtn}</td>
              </tr>
            `;
          });
          tableHTML += '</tbody></table>';
          adminsList.innerHTML = tableHTML;
        } else {
          showToast('Failed to load admins: ' + (data.error || 'Unknown error'), '#d32f2f');
        }
      } catch (error) {
        showToast('Error loading admins: ' + error.message, '#d32f2f');
      }
    }

    // Function to create sample admin users
    async function createAdminUsers() {
      if (!confirm('This will create sample admin users. Continue?')) return;
      
      try {
        const response = await fetch('/api/admin/create-sample-admins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        if (data.success) {
          showToast('Sample admin users created successfully', '#2e7d32');
          loadAdmins(); // Refresh the list
        } else {
          showToast('Failed to create admin users: ' + data.error, '#d32f2f');
        }
      } catch (error) {
        showToast('Error creating admin users: ' + error.message, '#d32f2f');
      }
    }

    // Change admin password
    async function changeAdminPassword() {
      const adminId = document.getElementById('adminSelect').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!adminId) {
        showToast('Please select an admin', '#d32f2f');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showToast('Passwords do not match', '#d32f2f');
        return;
      }
      
      if (newPassword.length < 6) {
        showToast('Password must be at least 6 characters', '#d32f2f');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminId, newPassword })
        });
        
        const data = await response.json();
        if (data.success) {
          showToast('Admin password changed successfully', '#2e7d32');
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
        } else {
          showToast('Failed to change password: ' + data.error, '#d32f2f');
        }
      } catch (error) {
        showToast('Error changing password: ' + error.message, '#d32f2f');
      }
    }

    // Change CEO password
    async function changeCEOPassword() {
      const oldPassword = document.getElementById('ceoOldPassword').value;
      const newPassword = document.getElementById('ceoNewPassword').value;
      const confirmPassword = document.getElementById('ceoConfirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        showToast('Passwords do not match', '#d32f2f');
        return;
      }
      
      if (newPassword.length < 6) {
        showToast('Password must be at least 6 characters', '#d32f2f');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/change-ceo-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword: oldPassword, newPassword })
        });
        
        const data = await response.json();
        if (data.success) {
          showToast('CEO password changed successfully', '#2e7d32');
          document.getElementById('ceoOldPassword').value = '';
          document.getElementById('ceoNewPassword').value = '';
          document.getElementById('ceoConfirmPassword').value = '';
        } else {
          showToast('Failed to change password: ' + data.error, '#d32f2f');
        }
      } catch (error) {
        showToast('Error changing password: ' + error.message, '#d32f2f');
      }
    }

    // Suspend admin
    async function suspendAdmin(adminId) {
      if (!confirm('Are you sure you want to suspend this admin?')) return;
      
      try {
        const response = await fetch('/api/admin/suspend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminIds: [adminId] })
        });
        
        const data = await response.json();
        if (data.success) {
          showToast('Admin suspended successfully', '#2e7d32');
          loadAdmins(); // Refresh the list
        } else {
          showToast('Failed to suspend admin: ' + data.error, '#d32f2f');
        }
      } catch (error) {
        showToast('Error suspending admin: ' + error.message, '#d32f2f');
      }
    }

    // Activate admin
    async function activateAdmin(adminId) {
      try {
        const response = await fetch('/api/admin/activate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminIds: [adminId] })
        });
        
        const data = await response.json();
        if (data.success) {
          showToast('Admin activated successfully', '#2e7d32');
          loadAdmins(); // Refresh the list
        } else {
          showToast('Failed to activate admin: ' + data.error, '#d32f2f');
        }
      } catch (error) {
        showToast('Error activating admin: ' + error.message, '#d32f2f');
      }
    }

    // Server management functions
    async function startAllServers() {
      try {
        const response = await fetch('/api/admin/start-servers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        if (data.success) {
          showToast('All servers started successfully', '#2e7d32');
          checkServerStatus();
        } else {
          showToast('Failed to start servers: ' + data.error, '#d32f2f');
        }
      } catch (error) {
        showToast('Error starting servers: ' + error.message, '#d32f2f');
      }
    }

    async function restartAllServers() {
      if (!confirm('Are you sure you want to restart all servers? This will cause temporary downtime.')) return;
      
      try {
        const response = await fetch('/api/admin/restart-servers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        if (data.success) {
          showToast('All servers restarted successfully', '#2e7d32');
          checkServerStatus();
        } else {
          showToast('Failed to restart servers: ' + data.error, '#d32f2f');
        }
      } catch (error) {
        showToast('Error restarting servers: ' + error.message, '#d32f2f');
      }
    }

    async function checkServerStatus() {
      try {
        // For now, show a simple status since we don't have a specific endpoint
        const statusHTML = `
          <table class="data-table">
            <thead>
              <tr><th>Server</th><th>Status</th><th>Port</th><th>Uptime</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Main Backend Server</td>
                <td><span class="status-indicator status-online"></span>Running</td>
                <td>3000</td>
                <td>Active</td>
              </tr>
              <tr>
                <td>Messaging Server</td>
                <td><span class="status-indicator status-online"></span>Running</td>
                <td>3001</td>
                <td>Active</td>
              </tr>
            </tbody>
          </table>
        `;
        document.getElementById('serverStatus').innerHTML = statusHTML;
      } catch (error) {
        document.getElementById('serverStatus').innerHTML = '<div class="error">Error checking server status</div>';
      }
    }

    // Load notifications
    async function loadNotifications() {
      try {
        const response = await fetch('/api/admin/notifications');
        const data = await response.json();
        
        if (Array.isArray(data)) {
          let notificationsHTML = '';
          if (data.length === 0) {
            notificationsHTML = '<div class="loading">No notifications available</div>';
          } else {
            data.forEach(notification => {
              notificationsHTML += `
                <div class="notification-item">
                  <strong>${notification.type}</strong><br>
                  <small>${new Date(notification.timestamp).toLocaleString()}</small><br>
                  ${notification.message}
                </div>
              `;
            });
          }
          document.getElementById('notificationsList').innerHTML = notificationsHTML;
        } else {
          document.getElementById('notificationsList').innerHTML = '<div class="error">Failed to load notifications</div>';
        }
      } catch (error) {
        document.getElementById('notificationsList').innerHTML = '<div class="error">Error loading notifications</div>';
      }
    }

    // Load financial data
    async function loadFinancialData() {
      try {
        // Load financial details
        const financialResponse = await fetch('/api/admin/financial-details');
        const financialData = await financialResponse.json();
        
        // Load withdrawal stats
        const withdrawalResponse = await fetch('/api/admin/withdrawals');
        const withdrawalData = await withdrawalResponse.json();
        
        // Load recharge stats
        const rechargeResponse = await fetch('/api/admin/recharge-requests');
        const rechargeData = await rechargeResponse.json();
        
        let financialHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #2979ff; margin: 0;">${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'approved').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Approved Withdrawals</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #ff9800; margin: 0;">${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'pending').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Pending Withdrawals</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #f44336; margin: 0;">${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'rejected').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Rejected Withdrawals</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #4caf50; margin: 0;">${rechargeData.requests ? rechargeData.requests.filter(r => r.status === 'approved').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Approved Recharges</p>
            </div>
          </div>
        `;
        
        financialHTML += `
          <table class="data-table">
            <thead>
              <tr><th>Type</th><th>Approved</th><th>Pending</th><th>Rejected</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Withdrawals</td>
                <td>${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'approved').length : 0}</td>
                <td>${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'pending').length : 0}</td>
                <td>${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'rejected').length : 0}</td>
              </tr>
              <tr>
                <td>Recharges</td>
                <td>${rechargeData.requests ? rechargeData.requests.filter(r => r.status === 'approved').length : 0}</td>
                <td>${rechargeData.requests ? rechargeData.requests.filter(r => r.status === 'pending').length : 0}</td>
                <td>${rechargeData.requests ? rechargeData.requests.filter(r => r.status === 'rejected').length : 0}</td>
              </tr>
            </tbody>
          </table>
        `;
        
        document.getElementById('financialData').innerHTML = financialHTML;
      } catch (error) {
        console.error('Error loading financial data:', error);
        document.getElementById('financialData').innerHTML = '<div class="error">Error loading financial data: ' + error.message + '</div>';
      }
    }

    // Load system statistics
    async function loadSystemStats() {
      try {
        // This would typically come from a system stats API
        const stats = {
          totalUsers: 150,
          activeAdmins: 8,
          totalMessages: 1250,
          systemUptime: '99.9%',
          lastBackup: '2 hours ago'
        };
        
        let statsHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #2979ff; margin: 0;">${stats.totalUsers}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Total Users</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #2979ff; margin: 0;">${stats.activeAdmins}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Active Admins</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #2979ff; margin: 0;">${stats.totalMessages}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Total Messages</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h3 style="color: #2979ff; margin: 0;">${stats.systemUptime}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">System Uptime</p>
            </div>
          </div>
        `;
        
        document.getElementById('systemStats').innerHTML = statsHTML;
      } catch (error) {
        document.getElementById('systemStats').innerHTML = '<div class="error">Error loading system statistics</div>';
      }
    }

    // Data Management Functions
    async function loadRecordsStats() {
      try {
        // Load recharge records stats
        const rechargeResponse = await fetch('/api/admin/recharge-requests');
        const rechargeData = await rechargeResponse.json();
        
        // Load withdrawal records stats
        const withdrawalResponse = await fetch('/api/admin/withdrawals');
        const withdrawalData = await withdrawalResponse.json();
        
        let statsHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; text-align: center;">
              <h3 style="color: #856404; margin: 0;">${rechargeData.requests ? rechargeData.requests.filter(r => r.status === 'pending').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Pending Recharges</p>
            </div>
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; text-align: center;">
              <h3 style="color: #155724; margin: 0;">${rechargeData.requests ? rechargeData.requests.filter(r => r.status === 'approved').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Approved Recharges</p>
            </div>
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; text-align: center;">
              <h3 style="color: #721c24; margin: 0;">${rechargeData.requests ? rechargeData.requests.filter(r => r.status === 'rejected').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Rejected Recharges</p>
            </div>
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; text-align: center;">
              <h3 style="color: #0c5460; margin: 0;">${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'pending').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Pending Withdrawals</p>
            </div>
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; text-align: center;">
              <h3 style="color: #155724; margin: 0;">${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'approved').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Approved Withdrawals</p>
            </div>
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; text-align: center;">
              <h3 style="color: #721c24; margin: 0;">${Array.isArray(withdrawalData) ? withdrawalData.filter(w => w.status === 'rejected').length : 0}</h3>
              <p style="margin: 5px 0 0 0; color: #666;">Rejected Withdrawals</p>
            </div>
          </div>
        `;
        
        document.getElementById('recordsStats').innerHTML = statsHTML;
      } catch (error) {
        console.error('Error loading records stats:', error);
        document.getElementById('recordsStats').innerHTML = '<div class="error">Error loading records statistics: ' + error.message + '</div>';
      }
    }

    async function clearSelectedRecords() {
      const options = {
        clearRechargePending: document.getElementById('clear-recharge-pending').checked,
        clearRechargeApproved: document.getElementById('clear-recharge-approved').checked,
        clearRechargeRejected: document.getElementById('clear-recharge-rejected').checked,
        clearWithdrawalPending: document.getElementById('clear-withdrawal-pending').checked,
        clearWithdrawalApproved: document.getElementById('clear-withdrawal-approved').checked,
        clearWithdrawalRejected: document.getElementById('clear-withdrawal-rejected').checked
      };

      // Check if any option is selected
      const hasSelection = Object.values(options).some(checked => checked);
      if (!hasSelection) {
        showToast('Please select at least one record type to clear', '#d32f2f');
        return;
      }

      // Confirm action
      const confirmMessage = 'Are you sure you want to clear the selected records? This action cannot be undone!';
      if (!confirm(confirmMessage)) {
        return;
      }

      const resultsDiv = document.getElementById('clearResults');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div class="loading">Clearing selected records...</div>';

      try {
        // Get admin info from localStorage
        const adminId = localStorage.getItem('adminId');
        const adminName = localStorage.getItem('adminName');
        
        if (!adminId || !adminName) {
          throw new Error('Admin information not found. Please log in again.');
        }

        let totalCleared = 0;
        let messages = [];

        // Clear recharge records if any recharge options are selected
        const rechargeOptions = {
          clearRechargePending: options.clearRechargePending,
          clearRechargeApproved: options.clearRechargeApproved,
          clearRechargeRejected: options.clearRechargeRejected
        };

        if (rechargeOptions.clearRechargePending || rechargeOptions.clearRechargeApproved || rechargeOptions.clearRechargeRejected) {
          const rechargeRequestData = {
            ...rechargeOptions,
            adminId: parseInt(adminId),
            adminName: adminName
          };

          const rechargeResponse = await fetch('/api/admin/clear-recharge-records', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(rechargeRequestData)
          });

          const rechargeResult = await rechargeResponse.json();

          if (rechargeResponse.ok) {
            totalCleared += rechargeResult.clearedCount || 0;
            messages.push(rechargeResult.message);
          } else {
            throw new Error(`Recharge clearing failed: ${rechargeResult.error}`);
          }
        }

        // Clear withdrawal records if any withdrawal options are selected
        const withdrawalOptions = {
          clearWithdrawalPending: options.clearWithdrawalPending,
          clearWithdrawalApproved: options.clearWithdrawalApproved,
          clearWithdrawalRejected: options.clearWithdrawalRejected
        };

        if (withdrawalOptions.clearWithdrawalPending || withdrawalOptions.clearWithdrawalApproved || withdrawalOptions.clearWithdrawalRejected) {
          const withdrawalRequestData = {
            ...withdrawalOptions,
            adminId: parseInt(adminId),
            adminName: adminName
          };

          const withdrawalResponse = await fetch('/api/admin/clear-withdrawal-records', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(withdrawalRequestData)
          });

          const withdrawalResult = await withdrawalResponse.json();

          if (withdrawalResponse.ok) {
            totalCleared += withdrawalResult.clearedCount || 0;
            messages.push(withdrawalResult.message);
          } else {
            throw new Error(`Withdrawal clearing failed: ${withdrawalResult.error}`);
          }
        }

        // Show success message
        if (totalCleared > 0) {
          resultsDiv.innerHTML = `<div class="success">‚úÖ Successfully cleared ${totalCleared} records total!</div>`;
          showToast(`Successfully cleared ${totalCleared} records`, '#2e7d32');
          loadRecordsStats(); // Refresh stats
        } else {
          resultsDiv.innerHTML = `<div class="success">‚úÖ No records found matching the selected criteria.</div>`;
          showToast('No records found matching criteria', '#2e7d32');
        }

      } catch (error) {
        console.error('‚ùå Error clearing records:', error);
        resultsDiv.innerHTML = `<div class="error">‚ùå Error clearing records: ${error.message}</div>`;
        showToast('Error clearing records: ' + error.message, '#d32f2f');
      }
    }

    async function clearAllRecords() {
      const confirmMessage = 'Are you sure you want to clear ALL records? This will delete all recharge and withdrawal records. This action cannot be undone!';
      if (!confirm(confirmMessage)) {
        return;
      }

      const doubleConfirm = confirm('This is your final warning. ALL records will be permanently deleted. Are you absolutely sure?');
      if (!doubleConfirm) {
        return;
      }

      const resultsDiv = document.getElementById('clearResults');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div class="loading">Clearing ALL records...</div>';

      try {
        // Get admin info from localStorage
        const adminId = localStorage.getItem('adminId');
        const adminName = localStorage.getItem('adminName');
        
        if (!adminId || !adminName) {
          throw new Error('Admin information not found. Please log in again.');
        }

        let totalCleared = 0;

        // Clear ALL recharge records
        const allRechargeOptions = {
          clearRechargePending: true,
          clearRechargeApproved: true,
          clearRechargeRejected: true,
          adminId: parseInt(adminId),
          adminName: adminName
        };

        const rechargeResponse = await fetch('/api/admin/clear-recharge-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(allRechargeOptions)
        });

        const rechargeResult = await rechargeResponse.json();

        if (rechargeResponse.ok) {
          totalCleared += rechargeResult.clearedCount || 0;
        } else {
          throw new Error(`Recharge clearing failed: ${rechargeResult.error}`);
        }

        // Clear ALL withdrawal records
        const allWithdrawalOptions = {
          clearWithdrawalPending: true,
          clearWithdrawalApproved: true,
          clearWithdrawalRejected: true,
          adminId: parseInt(adminId),
          adminName: adminName
        };

        const withdrawalResponse = await fetch('/api/admin/clear-withdrawal-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(allWithdrawalOptions)
        });

        const withdrawalResult = await withdrawalResponse.json();

        if (withdrawalResponse.ok) {
          totalCleared += withdrawalResult.clearedCount || 0;
        } else {
          throw new Error(`Withdrawal clearing failed: ${withdrawalResult.error}`);
        }

        resultsDiv.innerHTML = `<div class="success">‚úÖ All records cleared successfully! Total: ${totalCleared} records deleted.</div>`;
        showToast(`All records cleared! Total: ${totalCleared} records`, '#2e7d32');
        loadRecordsStats(); // Refresh stats
      } catch (error) {
        console.error('‚ùå Error clearing all records:', error);
        resultsDiv.innerHTML = `<div class="error">‚ùå Error clearing records: ${error.message}</div>`;
        showToast('Error clearing records: ' + error.message, '#d32f2f');
      }
    }

    // Initialize the control panel when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadAdmins();
      checkServerStatus();
      loadNotifications();
      loadFinancialData();
      loadSystemStats();
      loadRecordsStats();
    });
  </script>
</body>
</html> 