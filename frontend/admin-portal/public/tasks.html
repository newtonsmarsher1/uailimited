<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Tasks - UAI Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: linear-gradient(to bottom, #2979ff 0%, #e3f0ff 100%); 
      margin: 0; 
    }
    .container { 
      max-width: 1200px; 
      margin: 40px auto; 
      background: #fff; 
      border-radius: 18px; 
      box-shadow: 0 2px 16px #2979ff22; 
      padding: 32px 24px; 
    }
    h1 { color: #2979ff; text-align: center; margin-bottom: 24px; }
    .task-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .task-card {
      border: 1px solid #e3f0ff;
      border-radius: 12px;
      padding: 20px;
      background: #f9fbff;
      box-shadow: 0 2px 8px #2979ff11;
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .task-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #2979ff;
      margin: 0;
    }
    .task-reward {
      background: #43e97b;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
    }
    .task-details {
      margin-bottom: 15px;
    }
    .task-detail {
      margin-bottom: 8px;
      font-size: 0.95em;
    }
    .task-detail strong {
      color: #2979ff;
    }
    .task-actions {
      display: flex;
      gap: 10px;
    }
    .action-btn { 
      background: #2979ff; 
      color: #fff; 
      border: none; 
      border-radius: 8px; 
      padding: 8px 16px; 
      font-size: 0.9em; 
      cursor: pointer; 
      transition: background 0.2s;
    }
    .action-btn:hover { background: #1565c0; }
    .delete-btn { background: #e32f2f; }
    .delete-btn:hover { background: #c62828; }
    .add-btn {
      background: #43e97b;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px #43e97b22;
      margin-bottom: 20px;
    }
    .add-btn:hover { background: #2ecc71; }
    .back-btn {
      background: #2979ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px #2979ff22;
      margin-bottom: 20px;
    }
    .info-note {
      background: #e3f0ff;
      border-left: 4px solid #2979ff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      color: #2979ff;
      font-size: 0.95em;
    }
    .video-preview {
      max-width: 100%;
      height: 150px;
      background: #f0f0f0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      color: #666;
      font-size: 0.9em;
    }
    .download-preview {
      max-width: 100%;
      height: 150px;
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      color: white;
      font-size: 1.1em;
      font-weight: 600;
    }
    .question-section {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
    }
    .question-section strong {
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <button onclick="window.location.href='dashboard.html'" class="back-btn">&larr; Back to Dashboard</button>
    <h1>Manage Tasks</h1>
    <div class="info-note">
      <strong>Task Management:</strong> All app downloads, questions, and expected answers are editable and stored in the database. 
      Deleting a task will remove it from the database. App downloads can be repeated but will be reshuffled randomly for users.
    </div>
    <button onclick="createTask()" class="add-btn">+ Add New Task</button>
    
    <div class="task-grid" id="taskGrid">
      <!-- Tasks will be loaded here -->
    </div>
  </div>

  <script>
    const userRole = localStorage.getItem('userRole');
    const adminId = localStorage.getItem('adminId');
    const adminName = localStorage.getItem('adminName');
    
    // Check if user is logged in
    if (!userRole || !adminId || !adminName) {
      window.location.href = 'index.html';
    }

    async function fetchTasks() {
      try {
        // Use legacy route for now since new routes require authentication
        const res = await fetch('/api/admin/tasks');
        if (!res.ok) throw new Error('Failed to fetch tasks');
        return await res.json();
      } catch (error) {
        console.error('Error fetching tasks:', error);
        return [];
      }
    }

    function renderTasks(tasks) {
      const grid = document.getElementById('taskGrid');
      grid.innerHTML = '';
      
      if (tasks.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">No tasks found. Create your first task!</div>';
        return;
      }

      tasks.forEach(task => {
        const card = document.createElement('div');
        card.className = 'task-card';
        
        const downloadPreview = task.videoUrl 
          ? `<div class="download-preview">ðŸ“± Download App Available</div>`
          : `<div class="download-preview">ðŸ“± App Download Task</div>`;
        
        const questionSection = task.question 
          ? `<div class="question-section">
               <strong>Question:</strong> ${task.question}<br>
               <strong>Expected Answer:</strong> ${task.expected_answer || 'Any answer'}
             </div>`
          : '';

        card.innerHTML = `
          <div class="task-header">
            <h3 class="task-title">${task.title}</h3>
            <span class="task-reward">KES ${task.reward}</span>
          </div>
          <div class="task-details">
            <div class="task-detail"><strong>Bond Level Required:</strong> ${task.bond_level_required}</div>
            <div class="task-detail"><strong>Status:</strong> ${task.is_active ? 'Active' : 'Inactive'}</div>
            <div class="task-detail"><strong>Created:</strong> ${new Date(task.created_at).toLocaleDateString()}</div>
          </div>
          ${downloadPreview}
          ${questionSection}
          <div class="task-actions">
            <button class="action-btn" onclick="editTask(${task.id})">Edit</button>
            <button class="action-btn delete-btn" onclick="deleteTask(${task.id})">Delete</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    async function loadTasks() {
      const tasks = await fetchTasks();
      renderTasks(tasks);
    }

    function editTask(id) {
      window.location.href = `edit-task.html?id=${id}`;
    }

    function createTask() {
      window.location.href = 'edit-task.html';
    }

    async function deleteTask(id) {
      if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/delete-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to delete task');
        }
        
        alert('Task deleted successfully.');
        loadTasks();
      } catch (error) {
        console.error('Error deleting task:', error);
        alert(error.message || 'Failed to delete task.');
      }
    }

    // Load tasks on page load
    loadTasks();
  </script>
</body>
</html> 