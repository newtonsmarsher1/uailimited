<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Recharges - UAI Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: linear-gradient(to bottom, #2979ff 0%, #e3f0ff 100%); 
      margin: 0; 
    }
    .container { 
      max-width: 1200px; 
      margin: 40px auto; 
      background: #fff; 
      border-radius: 18px; 
      box-shadow: 0 2px 16px #2979ff22; 
      padding: 32px 24px; 
    }
    h1 { 
      color: #2979ff; 
      text-align: center; 
      margin-bottom: 24px; 
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #2979ff 0%, #ad7ce6 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(41, 121, 255, 0.3);
    }
    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
    }
    .stat-card .number {
      font-size: 2em;
      font-weight: bold;
      margin: 0;
    }
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: #e3f0ff;
      color: #2979ff;
      border: 2px solid #2979ff;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .filter-btn.active {
      background: #2979ff;
      color: white;
    }
    .filter-btn:hover {
      background: #2979ff;
      color: white;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 12px; 
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { 
      padding: 12px 8px; 
      border-bottom: 1px solid #e3f0ff; 
      text-align: left; 
    }
    th { 
      background: #2979ff; 
      color: #fff; 
      font-weight: 600; 
    }
    tr:hover { 
      background: #f8f9ff; 
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .verification-message {
      background: #e8f5e8;
      border: 1px solid #4caf50;
      border-radius: 8px;
      padding: 10px;
      margin: 5px 0;
      font-size: 0.9em;
      color: #2e7d32;
    }
    .verification-message:empty {
      display: none;
    }
    .action-btn {
      background: #2979ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 1em;
      cursor: pointer;
      margin-right: 6px;
      transition: all 0.3s;
    }
    .action-btn:hover {
      background: #1565c0;
      transform: translateY(-1px);
    }
    .action-btn.approve {
      background: #4caf50;
    }
    .action-btn.approve:hover {
      background: #388e3c;
    }
    .action-btn.reject {
      background: #f44336;
    }
    .action-btn.reject:hover {
      background: #d32f2f;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #e3f0ff;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .modal input:focus, .modal textarea:focus {
      outline: none;
      border-color: #2979ff;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 20px;
    }
    .modal-btn {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .modal-btn.cancel {
      background: #6c757d;
      color: white;
    }
    .modal-btn.cancel:hover {
      background: #5a6268;
    }
    .modal-btn.confirm {
      background: #2979ff;
      color: white;
    }
    .modal-btn.confirm:hover {
      background: #1565c0;
    }
    .message {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-weight: 600;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .back-btn {
      background: #2979ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    .back-btn:hover {
      background: #1565c0;
      transform: translateY(-1px);
    }
      font-weight: 600;
    }
    .status-approved {
      background: #d4edda;
      color: #155724;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
      font-weight: 600;
    }
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
      font-weight: 600;
    }
    .action-btn { 
      background: #2979ff; 
      color: #fff; 
      border: none; 
      border-radius: 8px; 
      padding: 6px 14px; 
      font-size: 0.9em; 
      cursor: pointer; 
      margin-right: 6px; 
      transition: background 0.3s;
    }
    .action-btn.reject { 
      background: #e32f2f; 
    }
    .action-btn.reject:hover { 
      background: #b71c1c; 
    }
    .action-btn:hover { 
      background: #1565c0; 
    }
    .method-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      color: white;
    }
    .method-1 { background: #ff6b35; }
    .method-2 { background: #4ecdc4; }
    .method-3 { background: #45b7d1; }
    .method-4 { background: #96ceb4; }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
    .ceo-only {
      display: none;
    }
    .ceo-only.show {
      display: block;
    }
    
    /* Financial Notice Styles */
    .financial-notice {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
      border-left: 5px solid #d32f2f;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3); }
      50% { box-shadow: 0 4px 20px rgba(255, 107, 107, 0.5); }
      100% { box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3); }
    }
    
    .financial-notice h3 {
      margin: 0 0 15px 0;
      font-size: 1.3em;
      text-align: center;
    }
    
    .financial-notice-section {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .financial-notice-section:last-child {
      margin-bottom: 0;
    }
    
    .financial-notice-section h4 {
      margin: 0 0 10px 0;
      color: #fff;
    }
    
    .financial-notice-section p,
    .financial-notice-section ul {
      margin: 8px 0;
      line-height: 1.6;
    }
    
    .financial-notice-section ul {
      padding-left: 20px;
    }
    
    .financial-notice-footer {
      text-align: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .financial-notice-footer p {
      margin: 0;
      font-weight: bold;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <button onclick="window.location.href='dashboard.html'" style="margin-bottom:18px;background:#2979ff;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:1em;cursor:pointer;box-shadow:0 2px 8px #2979ff22;">&larr; Back</button>
    <h1>üí∞ Manage Recharge Requests <span id="refreshIndicator" style="font-size: 0.6em; color: #4caf50; margin-left: 10px;">üîÑ Auto-refreshing...</span></h1>
    
    <!-- Financial Management Notice for All Financial Managers -->
    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3); border-left: 5px solid #d32f2f;">
      <h3 style="margin: 0 0 15px 0; font-size: 1.3em; text-align: center;">‚ö†Ô∏è IMPORTANT FINANCIAL MANAGEMENT NOTICE ‚ö†Ô∏è</h3>
      
      <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #fff;">üìã MANDATORY PROCEDURE FOR ALL FINANCIAL MANAGERS:</h4>
        <p style="margin: 8px 0; line-height: 1.6;"><strong>When receiving money from users:</strong></p>
        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
          <li>üí∞ <strong>IMMEDIATELY DEPOSIT</strong> all received money to the company's KCB Bank account</li>
          <li>üè¶ <strong>Paybill:</strong> 522522</li>
          <li>üì± <strong>Account Number:</strong> 1329688481</li>
        </ul>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #fff;">üìÖ AUDIT SCHEDULE:</h4>
        <p style="margin: 8px 0; line-height: 1.6;"><strong>Audit Day:</strong> Every Saturday or Sunday</p>
        <p style="margin: 8px 0; line-height: 1.6;"><em>This ensures all money is collected in one place for proper accounting and auditing.</em></p>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; color: #fff;">üí≥ WORKER PAYMENT PROCEDURE:</h4>
        <p style="margin: 8px 0; line-height: 1.6;">Every amount needed for paying workers will be deposited to CEO-added admin phone numbers only. Self-registered admins will not receive payments. When you receive the money, you will start sending and approving the withdrawal after sending the money to the user.</p>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #fff;">üìû HR MANAGER REQUIREMENT:</h4>
        <p style="margin: 8px 0; line-height: 1.6;"><strong>All CEO-Added HR Managers MUST:</strong></p>
        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
          <li>üì± Contact the CEO immediately</li>
          <li>üìû Provide their Airtel number</li>
          <li>üîÑ This prevents reversal from users</li>
          <li>‚ö†Ô∏è Only CEO-added admins will receive payment assignments</li>
        </ul>
      </div>
      
      <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255, 255, 255, 0.3);">
        <p style="margin: 0; font-weight: bold; font-size: 1.1em;">üö® ALL ADMINS MUST READ THIS MESSAGE CAREFULLY üö®</p>
      </div>
    </div>
    
    <div class="stats-container ceo-only" id="stats-container">
      <div class="stat-card">
        <h3>Total Requests</h3>
        <div class="number" id="total-requests">0</div>
      </div>
      <div class="stat-card">
        <h3>Pending</h3>
        <div class="number" id="pending-requests">0</div>
      </div>
      <div class="stat-card">
        <h3>Approved</h3>
        <div class="number" id="approved-requests">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Amount</h3>
        <div class="number" id="total-amount">KES 0</div>
      </div>
    </div>

    <div class="filters ceo-only" id="filters-container">
              <button class="filter-btn active" onclick="filterRequests('all', event)">All Requests</button>
        <button class="filter-btn" onclick="filterRequests('pending', event)">Pending</button>
        <button class="filter-btn" onclick="filterRequests('approved', event)">Approved</button>
        <button class="filter-btn" onclick="filterRequests('rejected', event)">Rejected</button>
        <button class="filter-btn" onclick="forceRefreshRecharges()" style="background: #ff9800; color: white;">üîÑ Force Refresh</button>
        <button class="filter-btn" onclick="clearAllCache()" style="background: #f44336; color: white;">üßπ Clear All Cache</button>
    </div>

    <table id="rechargesTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Phone</th>
          <th>Amount</th>
          <th>Method</th>
          <th>HR Manager</th>
          <th>Transaction</th>
          <th>Reference Code</th>
          <th>User Message</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    let allRecharges = [];
    let currentFilter = 'all';
    const userRole = localStorage.getItem('userRole');

    // Show CEO-only features
    if (userRole === 'CEO') {
      document.getElementById('stats-container').classList.add('show');
      document.getElementById('filters-container').classList.add('show');
    }

    async function fetchRecharges() {
      try {
        const res = await fetch('/api/admin/recharge-requests');
        if (!res.ok) throw new Error('Failed to fetch recharge requests');
        const data = await res.json();
        return data.requests || [];
      } catch (error) {
        console.error('Error fetching recharges:', error);
        return [];
      }
    }

    function updateStats(recharges) {
      if (userRole !== 'CEO') return;
      
      const total = recharges.length;
      const pending = recharges.filter(r => r.status === 'pending').length;
      const approved = recharges.filter(r => r.status === 'approved').length;
      const totalAmount = recharges
        .filter(r => r.status === 'approved')
        .reduce((sum, r) => sum + parseFloat(r.amount || 0), 0);

      document.getElementById('total-requests').textContent = total;
      document.getElementById('pending-requests').textContent = pending;
      document.getElementById('approved-requests').textContent = approved;
      document.getElementById('total-amount').textContent = `KES ${totalAmount.toLocaleString()}`;
    }

    function getMethodBadge(paymentMethod) {
      if (paymentMethod.includes('method1')) return '<span style="background:#ff6b35;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Method 1</span>';
      if (paymentMethod.includes('method2')) return '<span style="background:#4ecdc4;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Method 2</span>';
      if (paymentMethod.includes('method3')) return '<span style="background:#45b7d1;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Method 3</span>';
      if (paymentMethod.includes('method4')) return '<span style="background:#96ceb4;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">Method 4</span>';
      return '<span style="background:#45b7d1;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">HR Manager</span>';
    }

    function getReferenceCode(paymentMethod, verificationMessage) {
      // Extract reference code from user's verification message
      if (verificationMessage) {
        // Look for reference code patterns in user's message
        const refMatch = verificationMessage.match(/Reference:\s*(UAI-RECHARGE[-\d]*)/i);
        if (refMatch) {
          return `<code style="background:#f8f9fa;padding:2px 6px;border-radius:4px;font-size:0.8em;color:#2979ff;">${refMatch[1]}</code>`;
        } else {
          // Fallback: try to find any UAI-RECHARGE pattern
          const fallbackMatch = verificationMessage.match(/(UAI-RECHARGE[-\d]*)/i);
          if (fallbackMatch) {
            return `<code style="background:#f8f9fa;padding:2px 6px;border-radius:4px;font-size:0.8em;color:#2979ff;">${fallbackMatch[1]}</code>`;
          }
        }
      }
      
      // Fallback to payment method based code
      if (paymentMethod && paymentMethod.includes('method')) {
        const methodNumber = paymentMethod.match(/method(\d+)/);
        if (methodNumber) {
          return `<code style="background:#f8f9fa;padding:2px 6px;border-radius:4px;font-size:0.8em;color:#2979ff;">UAI-RECHARGE-${methodNumber[1]}</code>`;
        }
      }
      return '<code style="background:#f8f9fa;padding:2px 6px;border-radius:4px;font-size:0.8em;color:#2979ff;">UAI-RECHARGE</code>';
    }

    function getStatusBadge(status) {
      switch(status) {
        case 'pending': return '<span style="background:#fff3cd;color:#856404;padding:2px 6px;border-radius:4px;font-size:0.9em;">Pending</span>';
        case 'approved': return '<span style="background:#d4edda;color:#155724;padding:2px 6px;border-radius:4px;font-size:0.9em;">Approved</span>';
        case 'rejected': return '<span style="background:#f8d7da;color:#721c24;padding:2px 6px;border-radius:4px;font-size:0.9em;">Rejected</span>';
        default: return '<span style="background:#fff3cd;color:#856404;padding:2px 6px;border-radius:4px;font-size:0.9em;">Pending</span>';
      }
    }

    function renderRecharges(recharges) {
      const tbody = document.querySelector('#rechargesTable tbody');
      tbody.innerHTML = '';
      
      if (recharges.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;color:#666;">No recharge requests found</td></tr>';
        return;
      }

      recharges.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.user_name || `User ${r.user_id}`}</td>
          <td>${r.user_phone || 'N/A'}</td>
          <td><strong>KES ${parseFloat(r.amount || 0).toLocaleString()}</strong></td>
          <td>${getMethodBadge(r.payment_method)}</td>
          <td>
            ${r.hr_manager_name ? 
              `<div><strong>${r.hr_manager_name}</strong></div>
               <div style="font-size:0.8em;color:#666;">${r.hr_manager_phone || 'N/A'}</div>` : 
              'N/A'
            }
          </td>
          <td><code>${r.transaction_number || 'N/A'}</code></td>
          <td>
            ${getReferenceCode(r.payment_method, r.verification_message)}
          </td>
          <td>
            ${r.verification_message ? 
              `<div class="verification-message" style="background:#f8f9fa;padding:8px;border-radius:4px;border-left:3px solid #2979ff;max-width:200px;word-wrap:break-word;">
                <strong>User Message:</strong><br>
                ${r.verification_message}
              </div>` : 
              '<span style="color:#999;font-style:italic;">No message</span>'
            }
          </td>
          <td>${getStatusBadge(r.status)}</td>
          <td>${new Date(r.created_at).toLocaleDateString()}</td>
          <td>
            ${r.status === 'pending' ? `
              <button class="action-btn" onclick="approveRecharge(${r.id}, ${r.amount})">Approve</button>
              <button class="action-btn reject" onclick="rejectRecharge(${r.id})">Reject</button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterRequests(filter, event) {
      if (userRole !== 'CEO') return;
      
      currentFilter = filter;
      
      // Update filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (event && event.target) {
        event.target.classList.add('active');
      }

      // Filter recharges
      let filteredRecharges = allRecharges;
      if (filter !== 'all') {
        filteredRecharges = allRecharges.filter(r => r.status === filter);
      }

      renderRecharges(filteredRecharges);
    }

    async function loadRecharges() {
      allRecharges = await fetchRecharges();
      updateStats(allRecharges);
      
      if (userRole === 'CEO') {
        filterRequests(currentFilter);
      } else {
        renderRecharges(allRecharges);
      }
    }

    async function approveRecharge(id, amount) {
      // Find the recharge data to get the user's message
      const recharge = allRecharges.find(r => r.id === id);
      if (!recharge) {
        alert('Recharge data not found!');
        return;
      }

      // Extract reference code from user's verification message
      let referenceCode = 'UAI-RECHARGE';
      if (recharge.verification_message) {
        // Look for reference code patterns in user's message
        const refMatch = recharge.verification_message.match(/Reference:\s*(UAI-RECHARGE[-\d]*)/i);
        if (refMatch) {
          referenceCode = refMatch[1];
        } else {
          // Fallback: try to find any UAI-RECHARGE pattern
          const fallbackMatch = recharge.verification_message.match(/(UAI-RECHARGE[-\d]*)/i);
          if (fallbackMatch) {
            referenceCode = fallbackMatch[1];
          }
        }
      }

      const verificationMessage = prompt(
        `Enter verification message for recharge ID ${id} (amount: KES ${amount})\n\n` +
        `User's Reference Code: ${referenceCode}\n\n` +
        `Please enter the exact reference code from the user's message:`
      );
      
      if (!verificationMessage) return;

      // Validate that the verification message matches the reference code from user's message
      if (verificationMessage.trim() !== referenceCode) {
        alert(`Verification failed! You must enter the exact reference code from the user's message: ${referenceCode}`);
        return;
      }

      try {
        const res = await fetch('/api/admin/approve-recharge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            rechargeId: id, 
            amount: amount,
            verificationMessage: verificationMessage 
          })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Failed to approve recharge');
        }
        
        alert('Recharge approved successfully!');
        loadRecharges();
      } catch (error) {
        console.error('Error approving recharge:', error);
        alert(`Failed to approve recharge: ${error.message}`);
      }
    }

    async function rejectRecharge(id) {
      const reason = prompt('Enter rejection reason:');
      if (!reason) return;

      try {
        const res = await fetch('/api/admin/reject-recharge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            rechargeId: id, 
            reason: reason 
          })
        });

        if (!res.ok) throw new Error('Failed to reject recharge');
        
        alert('Recharge rejected successfully!');
        loadRecharges();
      } catch (error) {
        console.error('Error rejecting recharge:', error);
        alert('Failed to reject recharge. Please try again.');
      }
    }
    
    async function forceRefreshRecharges() {
      try {
        console.log('üßπ Force refreshing recharge data...');
        
        // Clear all cached data
        allRecharges = [];
        
        // Clear ALL localStorage cache
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('recharge') || key.includes('cache') || key.includes('data'))) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Clear ALL sessionStorage cache
        const sessionKeysToRemove = [];
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          if (key && (key.includes('recharge') || key.includes('cache') || key.includes('data'))) {
            sessionKeysToRemove.push(key);
          }
        }
        sessionKeysToRemove.forEach(key => sessionStorage.removeItem(key));
        
        // Clear table immediately
        const tbody = document.querySelector('#rechargesTable tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="12" class="no-data">Loading...</td></tr>';
        }
        
        // Reset stats immediately
        document.getElementById('total-requests').textContent = '0';
        document.getElementById('pending-requests').textContent = '0';
        document.getElementById('approved-requests').textContent = '0';
        document.getElementById('total-amount').textContent = 'KES 0';
        
        // Force fetch fresh data with cache busting
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/admin/recharge-requests?t=${timestamp}`, {
          method: 'GET',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        const data = await response.json();
        console.log('üìä Fresh API Response:', data);
        
        allRecharges = data.requests || [];
        console.log('üìã Fresh recharges loaded:', allRecharges.length);
        
        updateStats(allRecharges);
        
        if (userRole === 'CEO') {
          filterRequests(currentFilter);
        } else {
          renderRecharges(allRecharges);
        }
        
        alert('‚úÖ Recharge data refreshed successfully!');
        console.log('‚úÖ Force refresh completed');
        
      } catch (error) {
        console.error('‚ùå Error during force refresh:', error);
        alert('Failed to refresh recharge data');
      }
    }
    
    function clearAllCache() {
      try {
        console.log('üßπ Clearing ALL cache...');
        
        // Clear ALL localStorage
        localStorage.clear();
        console.log('‚úÖ localStorage cleared');
        
        // Clear ALL sessionStorage
        sessionStorage.clear();
        console.log('‚úÖ sessionStorage cleared');
        
        // Clear all recharge data
        allRecharges = [];
        
        // Clear table immediately
        const tbody = document.querySelector('#rechargesTable tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="12" class="no-data">No data</td></tr>';
        }
        
        // Reset all stats
        document.getElementById('total-requests').textContent = '0';
        document.getElementById('pending-requests').textContent = '0';
        document.getElementById('approved-requests').textContent = '0';
        document.getElementById('total-amount').textContent = 'KES 0';
        
        alert('‚úÖ All cache cleared! Page will reload...');
        
        // Reload the page after a short delay
        setTimeout(() => {
          window.location.reload(true);
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå Error clearing cache:', error);
        alert('Failed to clear cache');
      }
    }
    
    // Auto-refresh functionality
    let refreshInterval;
    
    function startAutoRefresh() {
      // Refresh every 1 second
      refreshInterval = setInterval(() => {
        console.log('üîÑ Auto-refreshing recharge data...');
        document.getElementById('refreshIndicator').style.display = 'inline';
        loadRecharges();
        // Hide indicator after a short delay
        setTimeout(() => {
          document.getElementById('refreshIndicator').style.display = 'none';
        }, 500);
      }, 1000);
    }
    
    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
        console.log('‚èπÔ∏è Auto-refresh stopped');
        document.getElementById('refreshIndicator').style.display = 'none';
      }
    }
    
    // Start auto-refresh when page loads
    loadRecharges();
    startAutoRefresh();
    
    // Stop auto-refresh when page is hidden (user switches tabs)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        stopAutoRefresh();
      } else {
        startAutoRefresh();
      }
    });
    
    // Stop auto-refresh when page is about to unload
    window.addEventListener('beforeunload', function() {
      stopAutoRefresh();
    });
  </script>
</body>
</html> 