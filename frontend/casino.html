<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Casino</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      background: #f5faff;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #222;
      margin: 0;
      padding-bottom: 70px;
    }
    
    .casino-header {
      background: linear-gradient(135deg, #2979ff 60%, #1565c0 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 18px rgba(41, 121, 255, 0.3);
    }
    
    .casino-title {
      font-size: 2em;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .casino-subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .casino-wheel-section {
      margin: 30px 20px;
      text-align: center;
    }
    
    .casino-wheel-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 20px auto;
    }
    
    .casino-wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        #ff4444 0deg 30deg,
        #ffdd44 30deg 60deg,
        #ff4444 60deg 90deg,
        #ffdd44 90deg 120deg,
        #ff4444 120deg 150deg,
        #ffdd44 150deg 180deg,
        #ff4444 180deg 210deg,
        #ffdd44 210deg 240deg,
        #ff4444 240deg 270deg,
        #ffdd44 270deg 300deg,
        #ff4444 300deg 330deg,
        #ffdd44 330deg 360deg
      );
      position: relative;
      transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .casino-wheel-segments {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      pointer-events: none;
    }
    
    .casino-wheel-segment {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 50%;
      background: #333;
      transform-origin: 50% 0%;
      margin-left: -1px;
    }
    
    .casino-wheel-segment span {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) rotate(90deg);
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      white-space: nowrap;
    }
    
    .casino-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-radius: 50%;
      border: 6px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #333;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    
    .casino-pointer {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 35px solid #ff4444;
      z-index: 10;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .casino-spin-btn {
      background: linear-gradient(135deg, #ff4444, #cc0000);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 15px 40px;
      font-size: 1.2em;
      font-weight: 700;
      cursor: pointer;
      margin: 20px 0;
      box-shadow: 0 4px 16px rgba(255, 68, 68, 0.4);
      transition: all 0.3s ease;
    }
    
    .casino-spin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 68, 68, 0.6);
    }
    
    .casino-spin-btn:active {
      transform: translateY(0);
    }
    
    .casino-joiners-bar {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      color: #1a3231;
      border-radius: 15px;
      padding: 15px 20px;
      margin: 20px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(67, 233, 123, 0.3);
      border: 2px solid #fff;
      font-weight: 600;
      overflow: hidden;
      position: relative;
    }
    
    .casino-joiners-title {
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1a3231;
    }
    
    .casino-joiners-count {
      font-size: 1.8em;
      font-weight: 800;
      color: #2979ff;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }
    
    .casino-joiners-subtitle {
      font-size: 0.9em;
      color: #1a3231;
      margin-top: 5px;
      opacity: 0.8;
    }
    
    .casino-joiners-scroll {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      padding: 4px 0;
      margin: 10px -40px;
      overflow: hidden;
      position: relative;
      height: 24px;
      display: flex;
      align-items: center;
      width: calc(100% + 80px);
    }
    
    .casino-joiners-scroll-content {
      display: flex;
      gap: 12px;
      white-space: nowrap;
      animation: scrollLeft 300s linear infinite;
    }
    
    @keyframes scrollLeft {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    
    .casino-joiner-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.65em;
      font-weight: 600;
      color: #2979ff;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 12px;
      border: 1px solid #e3f0ff;
    }
    
    .casino-joiner-phone {
      color: #ff4444;
      font-weight: 700;
    }
    
    .casino-joiner-name {
      color: #1a3231;
    }
    
    .casino-winners-section {
      margin: 20px -20px;
      position: relative;
      height: 150px;
      overflow: hidden;
    }
    
    .casino-winners-title {
      font-size: 1.1em;
      font-weight: 700;
      color: #ff4444;
      text-align: center;
      margin-bottom: 10px;
      text-shadow: 1px 1px 2px rgba(255,68,68,0.3);
    }
    
    .casino-winners-scroll {
      position: relative;
      height: 120px;
      overflow: hidden;
    }
    
    .casino-winners-scroll::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(to bottom, rgba(255,255,255,1) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%);
      z-index: 2;
      pointer-events: none;
    }
    
    .casino-winners-scroll::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(to top, rgba(255,255,255,1) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%);
      z-index: 2;
      pointer-events: none;
    }
    
    .casino-winners-scroll-content {
      animation: scrollUp 60s linear infinite;
    }
    
    @keyframes scrollUp {
      0% { transform: translateY(100%); }
      100% { transform: translateY(-100%); }
    }
    
    .casino-winner-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      margin: 3px 0;
      background: linear-gradient(90deg, #fff5f5, #fff);
      border-radius: 8px;
      border-left: 4px solid #ff4444;
      font-size: 0.8em;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: opacity 0.3s ease;
    }
    
    .casino-winner-name {
      color: #1a3231;
      font-weight: 700;
    }
    
    .casino-winner-prize {
      color: #ff4444;
      font-weight: 800;
      text-shadow: 0 1px 2px rgba(255,68,68,0.3);
    }
    
    .casino-winner-time {
      color: #666;
      font-size: 0.7em;
      font-weight: 500;
    }
    
    @keyframes highlightWinner {
      0% { 
        background: linear-gradient(90deg, #ffeb3b, #fff);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(255, 235, 59, 0.5);
      }
      50% { 
        background: linear-gradient(90deg, #ffeb3b, #fff);
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(255, 235, 59, 0.3);
      }
      100% { 
        background: linear-gradient(90deg, #fff5f5, #fff);
        transform: scale(1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .casino-result {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      text-align: center;
      display: none;
    }
    
    .casino-result.show {
      display: block;
    }
    
    .casino-result-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #2979ff;
      margin-bottom: 10px;
    }
    
    .casino-result-prize {
      font-size: 2em;
      font-weight: 700;
      color: #ff4444;
      margin: 10px 0;
    }
    
    .casino-back-btn {
      background: #2979ff;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 30px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      margin: 20px;
      box-shadow: 0 4px 16px rgba(41, 121, 255, 0.3);
      transition: all 0.3s ease;
    }
    
    .casino-back-btn:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }
    
    nav.bottom-nav {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 58px;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 8px #2979ff22;
      z-index: 1000;
      border-top: 1.5px solid #e3f2fd;
    }
    
    nav.bottom-nav a {
      color: #2979ff;
      font-size: 0.98em;
      font-weight: 600;
      text-align: center;
      padding: 2px 2px 0 2px;
      border-radius: 7px;
      display: flex; flex-direction: column; align-items: center;
      text-decoration: none;
      flex: 1;
      transition: background 0.2s, color 0.2s;
    }
    
    nav.bottom-nav a.active, nav.bottom-nav a:focus {
      background: #e3f2fd;
      color: #ff9900;
      font-weight: 700;
    }
    
    nav.bottom-nav a svg {
      width: 23px; height: 23px;
      margin: 0 auto 2px auto;
      fill: currentColor;
    }
    
    nav.bottom-nav a span {
      font-size: 0.75em;
      line-height: 1;
    }
    
    /* Lottery Modal Styles */
    .lottery-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }
    
    .lottery-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .lottery-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }
    
    .lottery-modal-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .lottery-modal-header h2 {
      color: #2979ff;
      font-size: 1.5em;
      margin-bottom: 8px;
    }
    
    .lottery-modal-header p {
      color: #666;
      font-size: 0.9em;
    }
    
    .lottery-trial-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
    }
    
    .trial-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .trial-option:hover {
      border-color: #2979ff;
      background: #f8f9ff;
    }
    
    .trial-option.selected {
      border-color: #2979ff;
      background: #e3f2fd;
    }
    
    .trial-number {
      font-size: 1.2em;
      font-weight: 700;
      color: #2979ff;
      margin-bottom: 5px;
    }
    
    .trial-cost {
      font-size: 1.1em;
      font-weight: 600;
      color: #ff4444;
      margin-bottom: 3px;
    }
    
    .trial-description {
      font-size: 0.8em;
      color: #666;
    }
    
    .lottery-modal-footer {
      display: flex;
      gap: 12px;
    }
    
    .lottery-cancel-btn, .lottery-confirm-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .lottery-cancel-btn {
      background: #f5f5f5;
      color: #666;
    }
    
    .lottery-cancel-btn:hover {
      background: #e0e0e0;
    }
    
    .lottery-confirm-btn {
      background: #2979ff;
      color: white;
    }
    
    .lottery-confirm-btn:hover {
      background: #1565c0;
    }
    
    .lottery-confirm-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Confirmation Modal Styles */
    .confirmation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      animation: fadeIn 0.3s ease;
    }
    
    .confirmation-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .confirmation-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }
    
    .confirmation-modal-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .confirmation-modal-header h3 {
      color: #2979ff;
      font-size: 1.3em;
      margin: 0;
    }
    
    .confirmation-details {
      margin-bottom: 25px;
    }
    
    .confirmation-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .confirmation-item:last-child {
      border-bottom: none;
    }
    
    .confirmation-item span:first-child {
      color: #666;
      font-weight: 500;
    }
    
    .confirmation-item span:last-child {
      color: #2979ff;
      font-weight: 600;
    }
    
    .confirmation-modal-footer {
      display: flex;
      gap: 12px;
    }
    
    .confirmation-cancel-btn, .confirmation-proceed-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .confirmation-cancel-btn {
      background: #f5f5f5;
      color: #666;
    }
    
    .confirmation-cancel-btn:hover {
      background: #e0e0e0;
    }
    
    .confirmation-proceed-btn {
      background: #4CAF50;
      color: white;
    }
    
    .confirmation-proceed-btn:hover {
      background: #45a049;
    }
    
    .confirmation-proceed-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Result prize styles */
    .result-prize.win {
      color: #4CAF50;
      font-weight: bold;
      font-size: 1.2em;
    }
    
    .result-prize.lose {
      color: #f44336;
      font-weight: bold;
      font-size: 1.2em;
    }
    
    .result-prize.consolation {
      color: #FF9800;
      font-weight: bold;
      font-size: 1.2em;
      background: linear-gradient(45deg, #FF9800, #FFC107);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .result-prize.jackpot {
      color: #FFD700;
      font-weight: bold;
      font-size: 1.3em;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    
    @media (max-width: 600px) {
      .casino-wheel-container {
        width: 250px;
        height: 250px;
      }
      
      .casino-center {
        width: 60px;
        height: 60px;
        font-size: 12px;
      }
      
      .casino-title {
        font-size: 1.6em;
      }
    }
  </style>
</head>
<body>
  <div class="casino-header">
    <div class="casino-title">üé∞ Casino</div>
    <div class="casino-subtitle">Spin the wheel and win prizes!</div>
  </div>
  
  <!-- Lottery Trial Selection Modal -->
  <div class="lottery-modal" id="lottery-modal">
    <div class="lottery-modal-content">
      <div class="lottery-modal-header">
        <h2>üé∞ Choose Your Lottery Trial</h2>
        <p>Select the number of trials you want to play</p>
      </div>
      
      <div class="lottery-trial-options">
        <div class="trial-option" data-trials="3" data-cost="500">
          <div class="trial-number">3 Trials</div>
          <div class="trial-cost">‚Ç¶500</div>
          <div class="trial-description">Basic package</div>
        </div>
        
        <div class="trial-option" data-trials="7" data-cost="1000">
          <div class="trial-number">7 Trials</div>
          <div class="trial-cost">‚Ç¶1,000</div>
          <div class="trial-description">Popular choice</div>
        </div>
        
        <div class="trial-option" data-trials="15" data-cost="4000">
          <div class="trial-number">15 Trials</div>
          <div class="trial-cost">‚Ç¶4,000</div>
          <div class="trial-description">Premium package</div>
        </div>
      </div>
      
      <div class="lottery-modal-footer">
        <button class="lottery-cancel-btn" onclick="closeLotteryModal()">Cancel</button>
        <button class="lottery-confirm-btn" id="lottery-confirm-btn" onclick="confirmLotteryPurchase()">Confirm Purchase</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="confirmation-modal" id="confirmation-modal">
    <div class="confirmation-modal-content">
      <div class="confirmation-modal-header">
        <h3>üí∞ Confirm Purchase</h3>
      </div>
      
      <div class="confirmation-details">
        <div class="confirmation-item">
          <span>Selected Trials:</span>
          <span id="confirm-trials">3</span>
        </div>
        <div class="confirmation-item">
          <span>Cost:</span>
          <span id="confirm-cost">‚Ç¶500</span>
        </div>
        <div class="confirmation-item">
          <span>Current Balance:</span>
          <span id="confirm-balance">‚Ç¶0</span>
        </div>
        <div class="confirmation-item">
          <span>Balance After:</span>
          <span id="confirm-balance-after">‚Ç¶0</span>
        </div>
      </div>
      
      <div class="confirmation-modal-footer">
        <button class="confirmation-cancel-btn" onclick="closeConfirmationModal()">Cancel</button>
        <button class="confirmation-proceed-btn" onclick="proceedWithPurchase()">Proceed</button>
      </div>
    </div>
  </div>

  <div class="casino-wheel-section">
    <div class="casino-wheel-container">
      <div class="casino-wheel" id="casino-wheel">
        <!-- Wheel segments will be created by JavaScript -->
      </div>
      <div class="casino-pointer"></div>
    </div>
    
    <button class="casino-spin-btn" id="spin-btn" onclick="showLotteryModal()">ENTER LOTTERY</button>
    
    <div class="casino-joiners-bar">
      <div class="casino-joiners-title">üéâ People Joining Today</div>
      <div class="casino-joiners-count" id="joiners-count">1,247</div>
      <div class="casino-joiners-scroll">
        <div class="casino-joiners-scroll-content" id="joiners-scroll-content">
          <!-- Joiner items will be added by JavaScript -->
        </div>
      </div>
      <div class="casino-joiners-subtitle">Join the excitement and spin to win!</div>
    </div>
    
    <div class="casino-winners-section">
      <div class="casino-winners-title">üèÜ Recent Winners</div>
      <div class="casino-winners-scroll">
        <div class="casino-winners-scroll-content" id="winners-scroll-content">
          <!-- Winner items will be added by JavaScript -->
        </div>
      </div>
    </div>
    
    <div class="casino-result" id="casino-result">
      <div class="casino-result-title">üéâ Congratulations!</div>
      <div class="casino-result-prize" id="result-prize">JACKPOT</div>
      <div>You won this prize!</div>
    </div>
  </div>
  
  <button class="casino-back-btn" onclick="goBack()">‚Üê Back to Home</button>
  
  <nav class="bottom-nav" aria-label="Bottom Navigation">
    <a href="home.html" id="nav-home">
      <svg viewBox="0 0 24 24"><path d="M3 21v-7.5l9-6.5 9 6.5V21H3z"/></svg>
      <span id="nav-home-label">Home</span>
    </a>
    <a href="task.html" id="nav-task">
      <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 10h8M8 14h4"/></svg>
      <span id="nav-task-label">Task</span>
    </a>
    <a href="team management.html" id="nav-team">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="3"/><path d="M12 15c-4 0-8 2-8 4v1h16v-1c0-2-4-4-8-4z"/></svg>
      <span id="nav-team-label">Team Management</span>
    </a>
    <a href="level.html" id="nav-level">
      <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 7v10l10 5 10-5V7"/></svg>
      <span id="nav-level-label">Level</span>
    </a>
    <a href="profile.html" id="nav-profile">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M2 20v-2a8 8 0 0 1 16 0v2"/></svg>
      <span id="nav-profile-label">Profile</span>
    </a>
  </nav>

  <script>
    // Global variables for lottery
    let selectedTrials = 0;
    let selectedCost = 0;
    let userBalance = 0;
    
    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'index.html';
        return false;
      }
      return true;
    }
    
    // Show lottery modal
    function showLotteryModal() {
      const modal = document.getElementById('lottery-modal');
      modal.classList.add('show');
      
      // Add click handlers for trial options
      const trialOptions = document.querySelectorAll('.trial-option');
      trialOptions.forEach(option => {
        option.addEventListener('click', function() {
          // Remove selected class from all options
          trialOptions.forEach(opt => opt.classList.remove('selected'));
          // Add selected class to clicked option
          this.classList.add('selected');
          
          // Store selected values
          selectedTrials = parseInt(this.dataset.trials);
          selectedCost = parseInt(this.dataset.cost);
          
          // Enable confirm button
          document.getElementById('lottery-confirm-btn').disabled = false;
        });
      });
    }
    
    // Close lottery modal
    function closeLotteryModal() {
      const modal = document.getElementById('lottery-modal');
      modal.classList.remove('show');
      
      // Reset selection
      selectedTrials = 0;
      selectedCost = 0;
      document.querySelectorAll('.trial-option').forEach(opt => opt.classList.remove('selected'));
      document.getElementById('lottery-confirm-btn').disabled = true;
    }
    
    // Confirm lottery purchase
    async function confirmLotteryPurchase() {
      if (selectedTrials === 0 || selectedCost === 0) {
        showMessage('Please select a trial package first', 'error');
        return;
      }
      
      try {
        // Get user balance
        const token = localStorage.getItem('token');
        const response = await fetch('/api/user-stats', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const responseText = await response.text();
          let userData;
          
          try {
            userData = JSON.parse(responseText);
          } catch (jsonError) {
            console.error('Invalid JSON response for user data:', responseText);
            console.error('JSON parse error:', jsonError);
            showMessage('Error fetching user data - invalid response', 'error');
            return;
          }
          
          userBalance = parseFloat(userData.wallet_balance || userData.balance || 0);
          
          // Check if user has enough balance
          if (userBalance < selectedCost) {
            showMessage('Insufficient balance. Please recharge your account.', 'error');
            return;
          }
          
          // Show confirmation modal
          showConfirmationModal();
        } else {
          showMessage('Error fetching user balance', 'error');
        }
      } catch (error) {
        console.error('Error fetching user data:', error);
        showMessage('Error fetching user data', 'error');
      }
    }
    
    // Show confirmation modal
    function showConfirmationModal() {
      const modal = document.getElementById('confirmation-modal');
      
      // Update confirmation details
      document.getElementById('confirm-trials').textContent = selectedTrials;
      document.getElementById('confirm-cost').textContent = `‚Ç¶${selectedCost.toLocaleString()}`;
      document.getElementById('confirm-balance').textContent = `‚Ç¶${userBalance.toLocaleString()}`;
      document.getElementById('confirm-balance-after').textContent = `‚Ç¶${(userBalance - selectedCost).toLocaleString()}`;
      
      modal.classList.add('show');
    }
    
    // Close confirmation modal
    function closeConfirmationModal() {
      const modal = document.getElementById('confirmation-modal');
      modal.classList.remove('show');
    }
    
    // Proceed with purchase
    async function proceedWithPurchase() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/casino/purchase-trials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            trials: selectedTrials,
            cost: selectedCost
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showMessage(`Successfully purchased ${selectedTrials} trials!`, 'success');
          closeConfirmationModal();
          closeLotteryModal();
          
          // Update button text to show remaining trials
          document.getElementById('spin-btn').textContent = `SPIN (${selectedTrials} left)`;
          
          // Enable spinning
          enableSpinning();
        } else {
          showMessage(data.error || 'Purchase failed', 'error');
        }
      } catch (error) {
        console.error('Error processing purchase:', error);
        showMessage('Error processing purchase', 'error');
      }
    }
    
    // Enable spinning after purchase
    function enableSpinning() {
      const spinBtn = document.getElementById('spin-btn');
      spinBtn.onclick = spinCasinoWheel;
    }

    // Casino Wheel functionality
    let consecutiveLosses = 0; // Track consecutive losses
    let totalSpins = 0; // Track total spins
    
    function createCasinoWheel() {
      const wheel = document.getElementById('casino-wheel');
      if (!wheel) return;
      
      // Create wheel with mostly LOSE segments and some winning prizes
      const prizes = [
        'LOSE', 'LOSE', 'LOSE', 'LOSE', 'LOSE', 'LOSE',
        'LOSE', 'LOSE', 'LOSE', 'LOSE', 'LOSE', 'LOSE'
      ];
      
      // Add a few winning prizes randomly
      const winningPrizes = ['JACKPOT', '1000', '500', '200', '100', '50', '25', '10'];
      const numWinningSegments = 1; // Only 1 winning segment out of 12 (8.33% chance)
      
      for (let i = 0; i < numWinningSegments; i++) {
        const randomIndex = Math.floor(Math.random() * 12);
        const randomPrize = winningPrizes[Math.floor(Math.random() * winningPrizes.length)];
        prizes[randomIndex] = randomPrize;
      }
      
      // Create wheel segments
      const segmentsContainer = document.createElement('div');
      segmentsContainer.className = 'casino-wheel-segments';
      
      prizes.forEach((prize, index) => {
        const segment = document.createElement('div');
        segment.className = 'casino-wheel-segment';
        segment.style.transform = `rotate(${index * 30}deg)`;
        
        const span = document.createElement('span');
        span.textContent = prize;
        segment.appendChild(span);
        segmentsContainer.appendChild(segment);
      });
      
      // Add center hub
      const center = document.createElement('div');
      center.className = 'casino-center';
      center.textContent = 'SPIN';
      
      wheel.appendChild(segmentsContainer);
      wheel.appendChild(center);
    }

    function spinCasinoWheel() {
      const wheel = document.getElementById('casino-wheel');
      const spinBtn = document.getElementById('spin-btn');
      const result = document.getElementById('casino-result');
      const resultPrize = document.getElementById('result-prize');
      
      if (!wheel || wheel.classList.contains('spinning')) return;
      
      // Disable button during spin
      spinBtn.disabled = true;
      spinBtn.textContent = 'Spinning...';
      wheel.classList.add('spinning');
      
      // Hide previous result
      result.classList.remove('show');
      
      // Calculate random spin
      const spins = Math.floor(Math.random() * 4) + 5; // 5-8 spins
      const segmentAngle = Math.floor(Math.random() * 12) * 30; // Random segment
      const totalRotation = -(spins * 360 + segmentAngle);
      
      // Apply rotation
      wheel.style.transform = `rotate(${totalRotation}deg)`;
      
      // Determine prize with consolation system
      const winChance = Math.random(); // 0 to 1
      let prize;
      let isConsolationPrize = false;
      
      // Check if user deserves consolation prize (after 3 consecutive losses)
      if (consecutiveLosses >= 3) {
        // Guaranteed consolation prize (less than what they paid)
        const consolationPrizes = ['50', '25', '10', '5']; // Small prizes
        prize = consolationPrizes[Math.floor(Math.random() * consolationPrizes.length)];
        isConsolationPrize = true;
        consecutiveLosses = 0; // Reset counter
      } else if (winChance <= 0.1) { // 10% chance to win normally
        // Randomly select a winning prize
        const winningPrizes = ['JACKPOT', '1000', '500', '200', '100', '50', '25', '10'];
        prize = winningPrizes[Math.floor(Math.random() * winningPrizes.length)];
        consecutiveLosses = 0; // Reset counter on win
      } else {
        // 90% chance to lose
        prize = 'LOSE';
        consecutiveLosses++; // Increment consecutive losses
      }
      
      // Show result after animation
      setTimeout(async () => {
        wheel.classList.remove('spinning');
        spinBtn.disabled = false;
        spinBtn.textContent = 'SPIN THE WHEEL';
        
        // Display result with appropriate message
        if (prize === 'LOSE') {
          resultPrize.textContent = 'Better luck next time!';
          resultPrize.className = 'result-prize lose';
        } else if (isConsolationPrize) {
          resultPrize.textContent = `üéÅ Consolation Prize! You won ‚Ç¶${prize} after 3 losses! üéÅ`;
          resultPrize.className = 'result-prize consolation';
        } else if (prize === 'JACKPOT') {
          resultPrize.textContent = `üéâ JACKPOT! You won ‚Ç¶10,000! üéâ`;
          resultPrize.className = 'result-prize jackpot';
        } else {
          resultPrize.textContent = `Congratulations! You won ‚Ç¶${prize}!`;
          resultPrize.className = 'result-prize win';
        }
        
        result.classList.add('show');
        
        // Send win to server if not LOSE
        if (prize !== 'LOSE') {
          try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/casino/spin', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ prize: prize })
            });
            
            const data = await response.json();
            
            if (data.success) {
              // Add winner to the scrolling list
              addWinnerToList(prize);
              
              // Update user balance display if available
              if (data.newBalance !== undefined) {
                updateUserBalance(data.newBalance);
              }
              
              // Show success message
              showMessage(data.message, 'success');
            }
          } catch (error) {
            console.error('Error processing win:', error);
            showMessage('Error processing win. Please try again.', 'error');
          }
        }
      }, 3000);
    }
    
    // Function to update user balance display
    function updateUserBalance(newBalance) {
      // Update balance in localStorage if available
      try {
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        userInfo.balance = newBalance;
        localStorage.setItem('userInfo', JSON.stringify(userInfo));
      } catch (e) {
        console.error('Error updating balance in localStorage:', e);
      }
    }
    
    // Function to show messages
    function showMessage(message, type = 'info') {
      // Create a temporary message element
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      
      if (type === 'success') {
        messageDiv.style.background = '#4CAF50';
      } else if (type === 'error') {
        messageDiv.style.background = '#f44336';
      } else {
        messageDiv.style.background = '#2196F3';
      }
      
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      // Remove after 3 seconds
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }
    
    // Function to add real winner to the scrolling list
    function addWinnerToList(prize) {
      const winnersContent = document.getElementById('winners-scroll-content');
      if (!winnersContent) return;
      
      // Get current user info from localStorage or generate a name
      let winnerName = 'You';
      try {
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        if (userInfo && userInfo.name) {
          winnerName = userInfo.name;
        }
      } catch (e) {
        // Use default name if no user info
      }
      
      // Create winner item with current time
      const now = new Date();
      const timeAgo = 'just now';
      
      const winnerItem = `
        <div class="casino-winner-item" style="background: linear-gradient(90deg, #fff5f5, #fff); border-left: 4px solid #ff4444; animation: highlightWinner 2s ease;">
          <span class="casino-winner-name">${winnerName}</span>
          <span class="casino-winner-prize">${prize}</span>
          <span class="casino-winner-time">${timeAgo}</span>
        </div>
      `;
      
      // Add to the beginning of the list (top)
      winnersContent.insertAdjacentHTML('afterbegin', winnerItem);
      
      // Remove old items if too many
      const items = winnersContent.querySelectorAll('.casino-winner-item');
      if (items.length > 200) {
        items[items.length - 1].remove();
      }
    }

    function goBack() {
      window.location.href = 'home.html';
    }

    // African country codes and names
    const africanCountryCodes = [
      '+234', '+27', '+20', '+254', '+251', '+255', '+256', '+257',
      '+260', '+261', '+262', '+263', '+264', '+265', '+266', '+267',
      '+268', '+269', '+291', '+297', '+298', '+299', '+30', '+31',
      '+32', '+33', '+34', '+351', '+352', '+353', '+354', '+355'
    ];
    
    const africanNames = [
      'Aisha', 'Fatima', 'Zainab', 'Mariam', 'Hassan', 'Ahmed', 'Mohammed', 'Ali',
      'Kemi', 'Tunde', 'Ade', 'Bisi', 'Chika', 'Ngozi', 'Chioma', 'Uche',
      'Amadou', 'Fatou', 'Moussa', 'Aissatou', 'Mamadou', 'Aminata', 'Ibrahima', 'Mariama',
      'Kwame', 'Akosua', 'Kofi', 'Abena', 'Kwesi', 'Adwoa', 'Yaw', 'Afua',
      'Thabo', 'Lerato', 'Tshepo', 'Naledi', 'Kagiso', 'Dineo', 'Tumelo', 'Boipelo',
      'Juma', 'Amina', 'Hassan', 'Fatima', 'Ali', 'Zainab', 'Omar', 'Mariam'
    ];
    
    // Generate random phone number with African country code
    function generateAfricanPhone() {
      const countryCode = africanCountryCodes[Math.floor(Math.random() * africanCountryCodes.length)];
      const phoneNumber = Math.floor(Math.random() * 900000000) + 100000000;
      return countryCode + ' ' + phoneNumber.toString().substring(0, 3) + '***' + phoneNumber.toString().substring(6);
    }
    
    // Generate random African name
    function generateAfricanName() {
      return africanNames[Math.floor(Math.random() * africanNames.length)];
    }
    
    // Create joiner item HTML
    function createJoinerItem() {
      const phone = generateAfricanPhone();
      const name = generateAfricanName();
      
      return `
        <div class="casino-joiner-item">
          <span class="casino-joiner-phone">${phone}</span>
          <span class="casino-joiner-name">${name} joined</span>
        </div>
      `;
    }
    
    // Prize options for winners
    const prizeOptions = [
      'JACKPOT', '1000', '500', '200', '100', '50', '25', '10',
      'BONUS', 'FREE SPIN', 'DOUBLE', 'TRIPLE', 'MEGA WIN'
    ];
    
    // Generate random time ago
    function generateTimeAgo() {
      const times = ['2 min ago', '5 min ago', '8 min ago', '12 min ago', '15 min ago', '20 min ago', '25 min ago', '30 min ago'];
      return times[Math.floor(Math.random() * times.length)];
    }
    
    // Create winner item HTML
    function createWinnerItem() {
      const name = generateAfricanName();
      const prize = prizeOptions[Math.floor(Math.random() * prizeOptions.length)];
      const timeAgo = generateTimeAgo();
      
      return `
        <div class="casino-winner-item">
          <span class="casino-winner-name">${name}</span>
          <span class="casino-winner-prize">${prize}</span>
          <span class="casino-winner-time">${timeAgo}</span>
        </div>
      `;
    }
    
    // Update joiners count and scroll
    function updateJoinersCount() {
      const joinersCount = document.getElementById('joiners-count');
      const scrollContent = document.getElementById('joiners-scroll-content');
      const winnersContent = document.getElementById('winners-scroll-content');
      if (!joinersCount || !scrollContent) return;
      
      // Simulate real-time updates
      let currentCount = Math.floor(Math.random() * 2900) + 100; // Random between 100-3000
      
      // Create initial joiner items (duplicated for seamless loop)
      let joinerItems = '';
      for (let i = 0; i < 150; i++) {
        joinerItems += createJoinerItem();
      }
      scrollContent.innerHTML = joinerItems + joinerItems; // Duplicate for seamless loop
      
      // Create winners items (duplicated for seamless upward scroll)
      if (winnersContent) {
        let winnerItems = '';
        for (let i = 0; i < 100; i++) {
          winnerItems += createWinnerItem();
        }
        winnersContent.innerHTML = winnerItems + winnerItems; // Duplicate for seamless loop
      }
      
      // Function to start scrolling (now starts immediately)
      window.startJoinersScroll = function() {
        // Animation already starts automatically
        console.log('Joiners scrolling started!');
      };
      
      // Update count immediately
      joinersCount.textContent = currentCount.toLocaleString();
      
      setInterval(() => {
        // Random change between -50 and +100
        const change = Math.floor(Math.random() * 151) - 50;
        currentCount += change;
        
        // Keep count between 100 and 3000
        if (currentCount < 100) currentCount = 100;
        if (currentCount > 3000) currentCount = 3000;
        
        // Format number with commas
        joinersCount.textContent = currentCount.toLocaleString();
        
        // Add a brief highlight effect based on change
        joinersCount.style.transform = 'scale(1.1)';
        if (change > 0) {
          joinersCount.style.color = '#ff4444'; // Red for increase
        } else if (change < 0) {
          joinersCount.style.color = '#ff8800'; // Orange for decrease
        } else {
          joinersCount.style.color = '#2979ff'; // Blue for no change
        }
        
        setTimeout(() => {
          joinersCount.style.transform = 'scale(1)';
          joinersCount.style.color = '#2979ff';
        }, 300);
        
        // Add new joiner item
        const newJoiner = createJoinerItem();
        scrollContent.innerHTML += newJoiner;
        
        // Remove old items to prevent too many
        const items = scrollContent.querySelectorAll('.casino-joiner-item');
        if (items.length > 500) {
          items[0].remove();
        }
      }, 8000); // Update every 8 seconds for slower changes
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuth()) return;
      
      createCasinoWheel();
      updateJoinersCount();
      
      // Add event listeners
      const wheel = document.getElementById('casino-wheel');
      const spinBtn = document.getElementById('spin-btn');
      
      if (wheel) {
        wheel.addEventListener('click', spinCasinoWheel);
      }
      
      if (spinBtn) {
        spinBtn.addEventListener('click', spinCasinoWheel);
      }
    });
  </script>
</body>
</html> 