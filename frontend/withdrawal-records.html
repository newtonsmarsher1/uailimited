<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Withdrawal Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #2979ff 0%, #ad7ce6 100%);
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
    }
    .container {
      background: rgba(255,255,255,0.95);
      margin-top: 60px;
      padding: 36px 24px 28px 24px;
      border-radius: 22px;
      max-width: 800px;
      width: 95vw;
      box-shadow: 0 2px 24px #ad7ce62a;
      text-align: center;
      position: relative;
    }
    .uai-logo {
      position: absolute;
      left: 50%; top: -38px;
      transform: translateX(-50%);
      width: 70px; height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ad7ce6 0%, #2979ff 100%);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 18px #7a09c555;
      border: 4px solid #fff;
    }
    .uai-logo span {
      color: #fff;
      font-size: 2em;
      font-weight: 800;
      letter-spacing: 3px;
      text-shadow: 0 2px 8px #7a09c577, 0 0 2px #4f2b7c;
    }
    h2 { color: #2979ff; margin-bottom: 1.25em;}
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stat-card.total {
      border-color: #2979ff;
    }
    
    .stat-card.approved {
      border-color: #4caf50;
    }
    
    .stat-card.pending {
      border-color: #ff9800;
    }
    
    .stat-card.rejected {
      border-color: #f44336;
    }
    
    .stat-card.amount {
      border-color: #4caf50;
    }
    
    .stat-card.fees {
      border-color: #ff9800;
    }
    
    .stat-number {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #666;
      font-weight: 600;
    }
    
    .records-container {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .records-title {
      font-size: 1.2em;
      font-weight: 700;
      color: #2979ff;
    }
    
    .refresh-btn {
      background: linear-gradient(90deg, #ff9800 0%, #ff5722 100%);
      color: #fff; border: none; border-radius: 8px; font-size: 0.9em;
      padding: 8px 16px; font-weight: 600; cursor: pointer; transition: background .18s;
      box-shadow: 0 2px 8px #ff980055;
    }
    .refresh-btn:hover { background: linear-gradient(90deg, #ff5722 0%, #ff9800 100%); }
    
    .record-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #e0e0e0;
      transition: all 0.3s ease;
    }
    
    .record-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .record-item.approved {
      border-left-color: #4caf50;
    }
    
    .record-item.pending {
      border-left-color: #ff9800;
    }
    
    .record-item.rejected {
      border-left-color: #f44336;
    }
    
    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .record-amount {
      font-size: 1.3em;
      font-weight: 700;
      color: #2979ff;
    }
    
    .record-status {
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .record-status.approved {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .record-status.pending {
      background: #fff3e0;
      color: #e65100;
    }
    
    .record-status.rejected {
      background: #ffebee;
      color: #c62828;
    }
    
    .record-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 0.9em;
      color: #666;
    }
    
    .record-detail {
      display: flex;
      justify-content: space-between;
    }
    
    .record-detail-label {
      font-weight: 600;
    }
    
    .record-detail-value {
      color: #333;
    }
    
    .no-records {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .no-records-icon {
      font-size: 3em;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .no-records-text {
      font-size: 1.1em;
      margin-bottom: 10px;
    }
    
    .no-records-subtext {
      font-size: 0.9em;
      opacity: 0.7;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2979ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #ffebee;
      border: 1px solid #f44336;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      color: #c62828;
      text-align: center;
    }
    
    .back-btn {
      background: linear-gradient(90deg, #2979ff 0%, #ad7ce6 100%);
      color: #fff; border: none; border-radius: 14px; font-size: 1.09em;
      padding: 13px 22px; font-weight: 700; cursor: pointer; transition: background .18s;
      min-width: 110px;
      outline: none;
      margin-top: 16px;
      box-shadow: 0 2px 10px #ad7ce655;
      text-decoration: none;
      display: inline-block;
    }
    .back-btn:hover {
      background: linear-gradient(90deg, #ad7ce6 0%, #2979ff 100%);
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 10px;
    }
    
    .pagination-btn {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pagination-btn:hover {
      background: #e9ecef;
    }
    
    .pagination-btn.active {
      background: #2979ff;
      color: white;
      border-color: #2979ff;
    }
    
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 23px 5vw 19px 5vw;
        max-width: 95vw;
      }
      
      .uai-logo { width: 48px; height: 48px; top: -28px; }
      .uai-logo span { font-size: 1.15em;}
      h2 { font-size: 1.1em;}
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .record-details {
        grid-template-columns: 1fr;
        gap: 5px;
      }
      
      .record-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="uai-logo"><span>UAI</span></div>
    <h2>üìã Withdrawal Records</h2>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card total">
        <div class="stat-number" id="totalWithdrawals">0</div>
        <div class="stat-label">Total Withdrawals</div>
      </div>
      <div class="stat-card approved">
        <div class="stat-number" id="approvedWithdrawals">0</div>
        <div class="stat-label">Approved</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-number" id="pendingWithdrawals">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card rejected">
        <div class="stat-number" id="rejectedWithdrawals">0</div>
        <div class="stat-label">Rejected</div>
      </div>
      <div class="stat-card amount">
        <div class="stat-number" id="totalAmount">KES 0</div>
        <div class="stat-label">Total Amount (90%)</div>
      </div>
      <div class="stat-card fees">
        <div class="stat-number" id="totalFees">KES 0</div>
        <div class="stat-label">Total Processing Fees</div>
      </div>
    </div>
    
    <!-- Records Container -->
    <div class="records-container">
      <div class="records-header">
        <div class="records-title">Withdrawal History</div>
        <button class="refresh-btn" onclick="loadWithdrawalRecords()">üîÑ Refresh</button>
      </div>
      
      <div id="recordsContent">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading withdrawal records...</div>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination" style="display: none;">
        <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">‚Üê Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
      </div>
    </div>
    
    <a href="withdrawal.html" class="back-btn">
      ‚Üê Back to Withdrawal
    </a>
  </div>

  <script>
    const userToken = localStorage.getItem('token');
    let currentPage = 1;
    let totalPages = 1;
    let withdrawalRecords = [];

    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'index.html';
        return false;
      }
      return true;
    }

    // Load withdrawal records
    async function loadWithdrawalRecords() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/user/withdrawal-records', {
          headers: { Authorization: "Bearer " + token }
        });
        
        if (!res.ok) {
          showError('Failed to load withdrawal records');
          return;
        }
        
        const data = await res.json();
        withdrawalRecords = data.records || [];
        
        // Show all records (users see full amounts they requested)
        const recordsToShow = withdrawalRecords;
        
        updateStatistics(recordsToShow);
        displayRecords(recordsToShow);
        
      } catch (error) {
        console.error('Error loading withdrawal records:', error);
        showError('Network error! Please try again.');
      }
    }

    // Update statistics
    function updateStatistics(records) {
      const total = records.length;
      const approved = records.filter(r => r.status === 'approved').length;
      const pending = records.filter(r => r.status === 'pending').length;
      const rejected = records.filter(r => r.status === 'rejected').length;
      
      // Calculate total amounts using display amounts (90% of original)
      const totalDisplayAmount = records.reduce((sum, r) => sum + parseFloat(r.display_amount || r.amount * 0.9), 0);
      const totalProcessingFees = records.reduce((sum, r) => sum + parseFloat(r.processing_fee || r.amount * 0.1), 0);
      
      document.getElementById('totalWithdrawals').textContent = total;
      document.getElementById('approvedWithdrawals').textContent = approved;
      document.getElementById('pendingWithdrawals').textContent = pending;
      document.getElementById('rejectedWithdrawals').textContent = rejected;
      
      // Update amount displays if they exist
      const totalAmountElement = document.getElementById('totalAmount');
      const totalFeesElement = document.getElementById('totalFees');
      
      if (totalAmountElement) {
        totalAmountElement.textContent = `KES ${totalDisplayAmount.toLocaleString()}`;
      }
      if (totalFeesElement) {
        totalFeesElement.textContent = `KES ${totalProcessingFees.toLocaleString()}`;
      }
    }

    // Display records
    function displayRecords(records) {
      const recordsContent = document.getElementById('recordsContent');
      
      if (records.length === 0) {
        recordsContent.innerHTML = `
          <div class="no-records">
            <div class="no-records-icon">üìã</div>
            <div class="no-records-text">No Withdrawal Records Found</div>
            <div class="no-records-subtext">You haven't made any withdrawal requests yet</div>
          </div>
        `;
        return;
      }
      
      const recordsHTML = records.map(record => {
        const requestedAt = new Date(record.requested_at);
        const processedAt = record.processed_at ? new Date(record.processed_at) : null;
        
        return `
          <div class="record-item ${record.status}">
            <div class="record-header">
              <div class="record-amount">KES ${parseFloat(record.display_amount || record.amount * 0.9).toLocaleString()}</div>
              <div class="record-status ${record.status}">${record.status}</div>
            </div>
            <div class="record-details">
              <div class="record-detail">
                <span class="record-detail-label">Original Amount:</span>
                <span class="record-detail-value">KES ${parseFloat(record.original_amount || record.amount).toLocaleString()}</span>
              </div>
              <div class="record-detail">
                <span class="record-detail-label">Processing Fee:</span>
                <span class="record-detail-value">KES ${parseFloat(record.processing_fee || record.amount * 0.1).toLocaleString()}</span>
              </div>
              <div class="record-detail">
                <span class="record-detail-label">Requested:</span>
                <span class="record-detail-value">${requestedAt.toLocaleDateString()}</span>
              </div>
              <div class="record-detail">
                <span class="record-detail-label">Time:</span>
                <span class="record-detail-value">${requestedAt.toLocaleTimeString()}</span>
              </div>
              ${processedAt ? `
              <div class="record-detail">
                <span class="record-detail-label">Processed:</span>
                <span class="record-detail-value">${processedAt.toLocaleDateString()}</span>
              </div>
              <div class="record-detail">
                <span class="record-detail-label">Processed Time:</span>
                <span class="record-detail-value">${processedAt.toLocaleTimeString()}</span>
              </div>
              ` : ''}
              ${record.approved_by ? `
              <div class="record-detail">
                <span class="record-detail-label">Approved by:</span>
                <span class="record-detail-value">${record.approved_by}</span>
              </div>
              ` : ''}
              ${record.rejected_by ? `
              <div class="record-detail">
                <span class="record-detail-label">Rejected by:</span>
                <span class="record-detail-value">${record.rejected_by}</span>
              </div>
              ` : ''}
              ${record.admin_notes ? `
              <div class="record-detail" style="grid-column: 1 / -1;">
                <span class="record-detail-label">Notes:</span>
                <span class="record-detail-value">${record.admin_notes}</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      recordsContent.innerHTML = recordsHTML;
    }

    // Show error message
    function showError(message) {
      const recordsContent = document.getElementById('recordsContent');
      recordsContent.innerHTML = `
        <div class="error-message">
          <div style="font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Error</div>
          <div>${message}</div>
        </div>
      `;
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuth()) return;
      
      // Load records immediately
      loadWithdrawalRecords();
    });
  </script>
</body>
</html>

