<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UAI Profile - No PWA</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- Explicitly prevent PWA installation -->
  <meta name="mobile-web-app-capable" content="no">
  <meta name="apple-mobile-web-app-capable" content="no">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="application-name" content="">
  <meta name="msapplication-TileColor" content="">
  <meta name="msapplication-config" content="">
  <style>
    :root {
      --brand-yellow:#2979ff ;
      --brand-dark: #282828;
      --brand-accent: #2979ff;
      --icon-bg: #fff200;
      --icon-color: #282828;
      --menu-bg: #fff;
      --menu-icon-active: var(--brand-accent);
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #2979ff 0%, #ad7ce6 100%);
      min-height: 100vh;
    }
    #top-notifications {
      position: fixed;
      top: 0; left: 0; width: 100%; z-index: 999;
    }
    #system-notification-bar {
      min-height: 2px;
      padding: -21px 9px;
      background: #2979ff;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 2px 8px #2979ff33;
      font-size: 1.03em;
      display: none;
      letter-spacing: 0.03em;
    }
    .top-nav {
      position: fixed;
      top: 35px;
      left: 0;
      right: 0;
      height: 62px;
      background: rgba(255,255,255,0.12);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 100;
      box-shadow: 0 2px 18px #7a09c515;
      margin-bottom: 0;
    }
    .logo-nav {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .hexagon-mini {
      width: 44px;
      height: 44px;
      background: #bd7de7;
      clip-path: polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 2px 10px #ad7ce658;
    }
    .hexagon-mini span {
      color: #fff;
      font-size: 1.5em;
      font-weight: 700;
      letter-spacing: 2px;
      text-shadow: 0 2px 7px #7a09c577, 0 0 2px #4f2b7c;
    }
    .user-level-pill {
      margin-left: 8px;
      background: #e3f0ffbb;
      color: #2979ff;
      font-weight: 600;
      font-size: 1.05em;
      padding: 4px 17px;
      border-radius: 15px;
      border: 1px solid #bd7de7;
      box-shadow: 0 1px 8px #bd7de748;
      letter-spacing: 0.5px;
    }


    .main-content {
      margin: 112px 0 80px 0;
      min-height: calc(100vh - 160px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      padding: 0 16px;
      box-sizing: border-box;
    }
    .profile-avatar {
      width: 92px;
      height: 92px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ad7ce6 0%, #2979ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.7em;
      color: #fff;
      box-shadow: 0 2px 18px #7a09c555;
      margin-top: 8px;
      border: 5px solid #fff4;
    }
    .profile-name {
      color: #fff;
      font-size: 1.24em;
      font-weight: 600;
      text-shadow: 0 2px 8px #0003;
      margin-top: 10px;
      letter-spacing: 0.5px;
    }
    .profile-phone {
      color: #e3f0ff;
      font-size: 1.08em;
      font-weight: 500;
      margin-top: 3px;
      margin-bottom: 6px;
    }
    .earnings-row {
      display: flex;
      gap: 14px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .earn-block {
      background: rgba(255,255,255,0.23);
      border-radius: 18px;
      box-shadow: 0 2px 18px #ad7ce62b;
      padding: 18px 22px 13px 22px;
      text-align: center;
      color: #fff;
      font-weight: 600;
      min-width: 110px;
      margin-bottom: 8px;
      -webkit-backdrop-filter: blur(1.5px);
      backdrop-filter: blur(1.5px);
      border: 2px solid #ad7ce63a;
    }
    .earn-block .value {
      display: block;
      font-size: 1.15em;
      margin-top: 5px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .earn-block.profit { color: #43e97b; }
    .earn-block.wallet { color: #fffb88; background: rgba(41,121,255,0.36);}
    .earn-block.loss { color: #ff5858; }
    .earn-block.bond { color: #ad7ce6; }
    .earn-block.tasks { color: #1565c0; }
    .actions-row {
      display: flex;
      gap: 18px;
      margin: 7px 0 8px 0;
      justify-content: center;
      width: 100%;
    }
    .action-btn {
      padding: 13px 25px;
      background: linear-gradient(90deg, #2979ff 0%, #ad7ce6 100%);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 24px;
      font-size: 1.1em;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.17s;
      box-shadow: 0 2px 12px #ad7ce621;
    }
    .action-btn:active { background: #1565c0; }
    .security-btn {
      margin: 24px 0 0 0;
      background: #fffbe6;
      color: #c62828;
      border: 1px solid #ffe082;
      font-weight: 600;
      font-size: 1.08em;
      border-radius: 16px;
      padding: 13px 14px;
      width: 100%;
      cursor: pointer;
      box-shadow: 0 1px 4px #ffe08246;
      transition: background 0.18s;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      text-decoration: none;
    }
    .security-btn:active { background: #fff2c0; }
    
    .download-app-btn {
      margin: 16px 0 0 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border: none;
      font-weight: 600;
      font-size: 1.08em;
      border-radius: 16px;
      padding: 13px 14px;
      width: 100%;
      cursor: pointer;
      text-decoration: none;
      display: block;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .download-app-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .download-app-btn:active { 
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    /* Session Management Styles */
    .session-management-section {
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .session-management-section h3 {
      color: #fff;
      font-size: 1.2em;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .session-info p {
      color: #e0e0e0;
      font-size: 0.95em;
      margin-bottom: 15px;
      text-align: center;
      line-height: 1.4;
    }
    
    .session-btn {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: #ffffff;
      border: none;
      font-weight: 600;
      font-size: 0.95em;
      border-radius: 12px;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
    }
    
    .session-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }
    
    .logout-all-btn {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
    }
    
    .logout-all-btn:hover {
      box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
    }
    
    .sessions-list, .security-events {
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sessions-header, .security-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .sessions-header h4, .security-header h4 {
      color: #fff;
      font-size: 1.1em;
      margin: 0;
    }
    
    .close-sessions-btn, .close-security-btn {
      background: #666;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-sessions-btn:hover, .close-security-btn:hover {
      background: #888;
    }
    
    .session-item, .security-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 3px solid #4caf50;
    }
    
    .session-item.current {
      border-left-color: #2196f3;
      background: rgba(33, 150, 243, 0.1);
    }
    
    .session-item.logged-out {
      border-left-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
      opacity: 0.7;
    }
    
    .session-device-info, .security-event-info {
      color: #e0e0e0;
      font-size: 0.9em;
      margin-bottom: 8px;
    }
    
    .session-device-type, .security-event-type {
      font-weight: 600;
      color: #fff;
      margin-bottom: 5px;
    }
    
    .session-actions {
      margin-top: 10px;
    }
    
    .session-logout-btn {
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.8em;
      cursor: pointer;
      margin-right: 8px;
    }
    
    .session-logout-btn:hover {
      background: #d32f2f;
    }
    
    .session-logout-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    .session-time {
      color: #bbb;
      font-size: 0.8em;
    }
    
    .security-event-time {
      color: #bbb;
      font-size: 0.8em;
      margin-top: 5px;
    }
    
    .loading-sessions, .loading-security {
      text-align: center;
      color: #bbb;
      font-style: italic;
      padding: 20px;
    }
    
    .no-sessions, .no-events {
      text-align: center;
      color: #bbb;
      font-style: italic;
      padding: 20px;
    }
    
    .policy-link {
      color: #fff;
      text-decoration: underline;
      font-size: 1.07em;
      cursor: pointer;
      font-weight: 500;
      display: block;
      margin-top: 19px;
      text-align: center;
      opacity: .84;
      letter-spacing: .05em;
    }
    .exit-btn {
      margin: 18px 0 0 0;
      display: block;
      width: 100%;
      background: linear-gradient(135deg, #ff4757, #c62828);
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 14px;
      font-size: 1.1em;
      padding: 16px 0;
      cursor: pointer;
      box-shadow: 0 4px 15px #c6282840;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .exit-btn:hover {
      background: linear-gradient(135deg, #ff3742, #b71c1c);
      box-shadow: 0 6px 20px #c6282860;
      transform: translateY(-2px);
    }
    .exit-btn:active { 
      background: linear-gradient(135deg, #ff2e3a, #a01515);
      transform: translateY(0);
    }
    .exit-btn::before {
      content: '🚪';
      margin-right: 8px;
      font-size: 1.2em;
    }
    @media (max-width: 480px) {
      .main-content { 
        gap: 12px; 
        margin: 100px 8px 80px 8px;
        padding: 0 4px;
      }
      
      .profile-avatar { 
        width: 65px; 
        height: 65px; 
        font-size: 2.2em;
      }
      
      .profile-name {
        font-size: 1.1em;
        margin-top: 8px;
      }
      
      .profile-phone {
        font-size: 0.95em;
        margin-top: 2px;
      }
      
      .earnings-row { 
        gap: 8px; 
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .earn-block { 
        padding: 8px 6px 4px 6px; 
        min-width: 80px;
        font-size: 0.9em;
        border-radius: 12px;
      }
      
      .earn-block .value {
        font-size: 1.05em;
        margin-top: 3px;
      }
      
      .actions-row { 
        gap: 8px;
        flex-wrap: wrap;
        padding: 0 4px;
      }
      
      .action-btn { 
        padding: 10px 8px; 
        font-size: 0.9em;
        border-radius: 20px;
        min-width: 80px;
        flex: 1;
        max-width: 120px;
      }
      
      .security-btn { 
        font-size: 0.9em;
        padding: 10px 8px;
        border-radius: 12px;
        margin: 16px 4px 0 4px;
      }
      
      .download-app-btn {
        font-size: 0.9em;
        padding: 10px 8px;
        border-radius: 12px;
        margin: 12px 4px 0 4px;
      }
      
      .exit-btn {
        font-size: 1em;
        padding: 14px 0;
        border-radius: 12px;
        margin: 14px 4px 0 4px;
      }
      
      .policy-link {
        font-size: 0.95em;
        margin-top: 16px;
      }
      
      /* Mobile-friendly countdown styles */
      #temp-worker-countdown {
        font-size: 0.7em !important;
        padding: 6px 8px !important;
        margin: 4px 4px !important;
        line-height: 1.2;
        word-wrap: break-word;
        overflow-wrap: break-word;
        border-radius: 6px !important;
        position: relative !important;
        z-index: 1 !important;
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3) !important;
      }
      
      /* Prevent multiple countdowns */
      #temp-worker-countdown + #temp-worker-countdown {
        display: none !important;
      }
      
      .user-info-row {
        font-size: 0.85em;
        padding: 6px 8px;
        margin: 6px 4px 2px 4px;
        border-radius: 10px;
      }
      
      .user-info-label {
        font-size: 0.8em;
        margin-right: 5px;
      }
      
      .user-info-val {
        font-size: 0.85em;
      }
      
      /* Task history mobile optimization */
      .task-history-section {
        margin: 12px 4px;
        padding: 16px 12px;
        border-radius: 12px;
      }
      
      .task-history-section h3 {
        font-size: 1.1em;
        margin-bottom: 12px;
      }
      
      .task-history-stats {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 16px;
      }
      
      .stat-item {
        padding: 8px;
        border-radius: 8px;
      }
      
      .stat-label {
        font-size: 0.75em;
        margin-bottom: 3px;
      }
      
      .stat-value {
        font-size: 1em;
      }
      
      .task-history-list {
        max-height: 250px;
      }
      
      .task-history-item {
        padding: 10px;
        margin-bottom: 6px;
        border-radius: 6px;
      }
      
      .task-name {
        font-size: 0.9em;
        margin-bottom: 3px;
      }
      
      .task-details {
        font-size: 0.8em;
        flex-wrap: wrap;
        gap: 4px;
      }
      
      .task-level {
        font-size: 0.7em;
        padding: 1px 4px;
      }
      
      .pagination-btn {
        padding: 6px 12px;
        font-size: 0.8em;
        border-radius: 4px;
      }
      
      .page-info {
        font-size: 0.8em;
      }
      
      /* Top navigation mobile optimization */
      .top-nav {
        top: 25px;
        height: 55px;
        padding: 0 12px;
      }
      
      .hexagon-mini {
        width: 38px;
        height: 38px;
      }
      
      .hexagon-mini span {
        font-size: 1.3em;
      }
      
      .user-level-pill {
        font-size: 0.9em;
        padding: 3px 12px;
        margin-left: 6px;
      }
      
      .top-logout-btn {
        padding: 6px 12px;
        font-size: 0.8em;
        border-radius: 16px;
      }
      
      /* Bottom navigation mobile optimization */
      nav.bottom-nav {
        height: 52px;
      }
      
      nav.bottom-nav a {
        font-size: 0.8em;
        padding: 1px 2px;
      }
      
      nav.bottom-nav a svg {
        width: 20px;
        height: 20px;
        margin-bottom: 1px;
      }
    }
    
    /* Extra small screens (very small Android phones) */
    @media (max-width: 360px) {
      .main-content {
        margin: 95px 4px 75px 4px;
        gap: 10px;
      }
      
      .earn-block {
        min-width: 70px;
        padding: 6px 4px 3px 4px;
        font-size: 0.8em;
      }
      
      .earn-block .value {
        font-size: 0.95em;
      }
      
      .action-btn {
        padding: 8px 6px;
        font-size: 0.85em;
        min-width: 70px;
      }
      
      .profile-avatar {
        width: 60px;
        height: 60px;
        font-size: 2em;
      }
      
      .profile-name {
        font-size: 1em;
      }
      
      .profile-phone {
        font-size: 0.9em;
      }
    }
    .fade-in {
      animation: fadein 1.2s;
    }
    @keyframes fadein { from {opacity:0;} to {opacity:1;} }
    /* Bottom nav */
    nav.bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 1px solid #e3f0ff;
      z-index: 1000;
    }
    nav.bottom-nav a {
      background: transparent;
      border: none;
      color: #282828;
      font-size: 0.85em;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-user-select: none;
      user-select: none;
      transition: color 0.3s;
      padding: 2px 4px;
      flex-shrink: 0;
      text-decoration: none;
    }
    nav.bottom-nav a.active,
    nav.bottom-nav a:focus {
      color: var(--menu-icon-active);
    }
    nav.bottom-nav a svg {
      width: 22px;
      height: 22px;
      margin-bottom: 2px;
      fill: currentColor;
    }

    
    .top-logout-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      margin-left: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ff4757;
    }
    .top-logout-btn:hover {
      background: #ff4757;
      color: white;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
    }
    .top-logout-btn:active {
      transform: scale(0.95);
    }
    .user-info-row {
      width: 99%;
      background: #fffbe6;
      color: #2979ff;
      border-radius: 13px;
      padding: 8px 10px;
      font-size: 1em;
      margin: 10px auto 2px auto;
      box-shadow: 0 1px 8px #ad7ce633;
      text-align: left;
      font-weight: 600;
      letter-spacing: .04em;
    }
    
    /* Invitation Code Styles */
    .invitation-code-section {
      background: linear-gradient(135deg, #2979ff, #1e5bb8);
      color: white;
      border: 2px solid #2979ff;
      box-shadow: 0 4px 12px rgba(41, 121, 255, 0.3);
    }
    
    .invitation-code-display {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .invitation-code-text {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 1.1em;
      color: #2979ff;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #2979ff;
      min-width: 80px;
      text-align: center;
    }
    
    .copy-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .copy-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }
    
    .copy-btn:active {
      transform: translateY(0);
    }
    
    .copy-btn.copied {
      background: #4caf50;
      border-color: #4caf50;
    }
    .user-info-label {
      color: #ad7ce6; font-weight: 700; margin-right: 7px;
    }
    .user-info-val {
      color: #2979ff; font-weight: 600;
    }
    
    /* Task History Styles */
    .task-history-section {
      width: 99%;
      background: #fff;
      border-radius: 13px;
      padding: 20px;
      margin: 15px auto;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    
    .task-history-section h3 {
      color: #2979ff;
      font-size: 1.2em;
      font-weight: 700;
      margin: 0 0 15px 0;
      text-align: center;
    }
    
    .task-history-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: linear-gradient(135deg, #e3f0ff, #f8fbff);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #d1e7ff;
    }
    
    .stat-label {
      display: block;
      color: #666;
      font-size: 0.85em;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .stat-value {
      display: block;
      color: #2979ff;
      font-size: 1.1em;
      font-weight: 700;
    }
    
    .task-history-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    
    .task-history-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #2979ff;
    }
    
    .task-history-item:last-child {
      margin-bottom: 0;
    }
    
    .task-name {
      color: #2979ff;
      font-weight: 600;
      font-size: 0.95em;
      margin-bottom: 4px;
    }
    
    .task-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85em;
    }
    
    .task-reward {
      color: #28a745;
      font-weight: 600;
    }
    
    .task-date {
      color: #666;
    }
    
    .task-level {
      background: #e3f0ff;
      color: #2979ff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: 600;
    }
    
    .loading-message {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }
    
    .task-history-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }
    
    .pagination-btn {
      background: #2979ff;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .pagination-btn:hover {
      background: #1565c0;
    }
    
    .pagination-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .page-info {
      color: #666;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    /* Mobile-specific optimizations for Android phones */
    @media (max-width: 480px) {
      body {
        font-size: 14px;
        overflow-x: hidden;
        width: 100%;
        position: relative;
      }
      
      .main-content {
        margin: 100px 0 70px 0;
        gap: 16px;
        padding: 0 12px;
      }
      
      .profile-avatar {
        width: 80px;
        height: 80px;
        font-size: 2.5em;
      }
      
      .profile-name {
        font-size: 1.4em;
        margin-bottom: 4px;
      }
      
      .profile-phone {
        font-size: 1em;
        margin-bottom: 12px;
      }
      
      .user-level-pill {
        font-size: 0.9em;
        padding: 3px 12px;
      }
      
      .earn-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin: 16px 0;
      }
      
      .earn-block {
        padding: 16px 12px;
        border-radius: 12px;
      }
      
      .earn-block .label {
        font-size: 0.85em;
        margin-bottom: 6px;
      }
      
      .earn-block .value {
        font-size: 1.2em;
        font-weight: 700;
      }
      
      .profile-section {
        width: 100%;
        padding: 16px 12px;
        border-radius: 12px;
        margin-bottom: 12px;
      }
      
      .section-title {
        font-size: 1.1em;
        margin-bottom: 12px;
      }
      
      .info-row {
        padding: 8px 0;
        font-size: 0.9em;
      }
      
      .info-row .label {
        font-size: 0.85em;
      }
      
      .info-row .value {
        font-size: 0.9em;
      }
      
      .top-nav {
        top: 30px;
        height: 56px;
        padding: 0 16px;
      }
      
      .hexagon-mini {
        width: 40px;
        height: 40px;
      }
      
      .hexagon-mini span {
        font-size: 1.3em;
      }
      
      .user-level-pill {
        margin-left: 6px;
        font-size: 0.9em;
        padding: 3px 10px;
      }
      
      #system-notification-bar {
        font-size: 0.9em;
        padding: 8px 12px;
      }
      
      /* Prevent horizontal scrolling */
      .profile-avatar,
      .earn-grid,
      .profile-section,
      .main-content {
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      /* Ensure proper spacing */
      .earn-grid {
        margin-left: 0;
        margin-right: 0;
      }
      
      /* Optimize for touch */
      .earn-block,
      .profile-section {
        touch-action: manipulation;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 360px) {
      .main-content {
        padding: 0 8px;
        gap: 12px;
      }
      
      .earn-grid {
        gap: 8px;
      }
      
      .earn-block {
        padding: 12px 8px;
      }
      
      .profile-section {
        padding: 12px 8px;
      }
      
      .profile-name {
        font-size: 1.3em;
      }
      
      .earn-block .value {
        font-size: 1.1em;
      }
    }
    
    /* Hide only specific installation-related elements */
    [class*="install-btn"], [id*="install-btn"], [class*="download-btn"], [id*="download-btn"] {
      display: none !important;
    }
  </style>
</head>
<body>
    <script>
      // Check authentication status
      console.log('🔍 Checking authentication status...');
      const token = localStorage.getItem('token');
      if (token) {
        console.log('✅ Authentication token found');
      } else {
        console.log('❌ No authentication token found');
      }
    </script>

  <!-- Top Notification bar -->
  <div id="top-notifications">
    <div id="system-notification-bar"></div>
  </div>

  <script src="js/logout-utility.js"></script>
  <!-- Top Navigation -->
  <div class="top-nav fade-in">
    <div class="logo-nav">
      <div class="hexagon-mini"><span>UAI</span></div>
      <span class="user-level-pill" id="user-level-pill">Level --</span>
    </div>
    <button class="top-logout-btn" id="top-logout-btn" title="Logout" onclick="logoutUser()">
      🚪 Log Out
    </button>
  </div>

  <div class="main-content fade-in">
    <div class="profile-avatar" id="profile-avatar">👤</div>
    <div class="profile-name" id="profile-name">--</div>
    <div class="profile-phone" id="profile-phone">--</div>
    <div class="earnings-row">
      <div class="earn-block">
        <span id="today-earning-label" data-translate="today-earning-label">Today's Earnings</span>
        <span class="value" id="today-earning">KES 0</span>
      </div>
      <div class="earn-block">
        <span id="month-earning-label" data-translate="month-earning-label">This Month</span>
        <span class="value" id="month-earning">KES 0</span>
      </div>
      <div class="earn-block">
        <span id="total-revenue-label" data-translate="total-revenue-label">Total Revenue</span>
        <span class="value" id="total-revenue">KES 0</span>
      </div>
      <div class="earn-block loss">
        <span id="total-withdrawal-label" data-translate="total-withdrawal-label">Total Withdrawn</span>
        <span class="value" id="total-withdrawal">KES 0</span>
      </div>
      <div class="earn-block wallet">
        <span id="wallet-balance-label" data-translate="wallet-balance-label">Wallet Balance</span>
        <span class="value" id="wallet-balance">KES 0</span>
      </div>
      <div class="earn-block bond">
        <span id="bond-label" data-translate="bond-label">Bond</span>
        <span class="value" id="bond-amount">Level --</span>
      </div>
      <div class="earn-block profit">
        <span id="profit-label" data-translate="profit-label">Profit</span>
        <span class="value" id="profit">KES 0</span>
      </div>
      <div class="earn-block tasks">
        <span id="tasks-done-label" data-translate="tasks-done-label">Tasks Done</span>
        <span class="value" id="tasks-done">0</span>
      </div>
    </div>
    <!-- User Information Section -->
    <div class="user-info-row">
      <div class="user-info-label">Task Progress:</div>
      <div class="user-info-val" id="task-progress-info">Loading...</div>
    </div>
    
    <div class="user-info-row invitation-code-section">
      <span class="user-info-label">Your Invitation Code:</span>
      <div class="invitation-code-display">
        <span class="user-info-val invitation-code-text" id="referral-code">--</span>
        <button class="copy-btn" onclick="copyInvitationCode()" title="Copy invitation code">
          📋 Copy
        </button>
      </div>
    </div>
    
    <div class="user-info-row">
      <span class="user-info-label">Referred By:</span>
      <span class="user-info-val" id="referred-by">--</span>
    </div>
    
    <div class="user-info-row">
      <span class="user-info-label">Member Since:</span>
      <span class="user-info-val" id="member-since">--</span>
    </div>
    
    <div class="user-info-row" id="temp-worker-info" style="display: none;">
      <span class="user-info-label">Status:</span>
      <span class="user-info-val" style="color: #ff9800; font-weight: 700;">Temporary Worker</span>
    </div>
    
    <div class="user-info-row" id="temp-worker-start-date" style="display: none;">
      <span class="user-info-label">Started:</span>
      <span class="user-info-val" id="temp-worker-date">--</span>
    </div>
    
    <!-- Task History Section -->
    <div class="task-history-section">
      <h3 id="task-history-title" data-translate="task-history-title">Recent Task History</h3>
      <div class="task-history-stats">
        <div class="stat-item">
          <span class="stat-label" data-translate="total-tasks-label">Total Tasks</span>
          <span class="stat-value" id="total-tasks-completed">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label" data-translate="active-days-label">Active Days</span>
          <span class="stat-value" id="active-days">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label" data-translate="longest-streak-label">Longest Streak</span>
          <span class="stat-value" id="longest-streak">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label" data-translate="avg-reward-label">Avg Reward</span>
          <span class="stat-value" id="average-reward">KES 0</span>
        </div>
      </div>
      <div class="task-history-list" id="task-history-list">
        <div class="loading-message">Loading task history...</div>
      </div>
      <div class="task-history-pagination" id="task-history-pagination" style="display: none;">
        <button class="pagination-btn" id="prev-page-btn" data-translate="prev-page">Previous</button>
        <span class="page-info" id="page-info">Page 1</span>
        <button class="pagination-btn" id="next-page-btn" data-translate="next-page">Next</button>
      </div>
    </div>
    <div class="actions-row">
      <button class="action-btn" onclick="window.location.href='recharge.html'">
        💰 Recharge
      </button>
      <button class="action-btn" onclick="window.location.href='withdrawal.html'">
        🏦 Withdraw
      </button>
      <button class="action-btn" onclick="loadProfileData()" style="background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); color: #1a3231; font-weight: 600;">
        🔄 Refresh Now
      </button>
    </div>
    <a class="security-btn" href="binddetails.html">
      🔒 Account Security: Bind Withdrawal Details
    </a>
    <a class="download-app-btn" href="/download/UAI.apk" download="UAI.apk">
      📱 Download Mobile App
    </a>
    
    <!-- Session Management Section -->
    <div class="session-management-section">
      <h3>🔐 Active Sessions</h3>
      <div class="session-info">
        <p>Single device login is enabled for security. Only one device can be logged in at a time.</p>
        <button class="session-btn" id="view-sessions-btn">View Active Sessions</button>
        <button class="session-btn logout-all-btn" id="logout-all-btn">Logout All Devices</button>
      </div>
      
      <div class="sessions-list" id="sessions-list" style="display: none;">
        <div class="sessions-header">
          <h4>Your Active Sessions</h4>
          <button class="close-sessions-btn" id="close-sessions-btn">✕</button>
        </div>
        <div class="sessions-content" id="sessions-content">
          <!-- Sessions will be loaded here -->
        </div>
      </div>
      
      <div class="security-events" id="security-events" style="display: none;">
        <div class="security-header">
          <h4>Recent Security Events</h4>
          <button class="close-security-btn" id="close-security-btn">✕</button>
        </div>
        <div class="security-content" id="security-content">
          <!-- Security events will be loaded here -->
        </div>
      </div>
    </div>
    <a class="policy-link" href="privacy.html" target="_blank">
      Privacy Policy
    </a>
    <button class="exit-btn" id="exit-btn">Exit & Log Out</button>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Bottom Navigation">
    <a href="home.html" id="nav-home">
      <svg viewBox="0 0 24 24"><path d="M3 21v-7.5l9-6.5 9 6.5V21H3z"/></svg>
      <span id="nav-home-label" data-translate="nav-home-label">Home</span>
    </a>
    <a href="task.html" id="nav-task">
      <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 10h8M8 14h4"/></svg>
      <span id="nav-task-label" data-translate="nav-task-label">Task</span>
    </a>
    <a href="team management.html" id="nav-team">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="3"/><path d="M12 15c-4 0-8 2-8 4v1h16v-1c0-2-4-4-8-4z"/></svg>
      <span id="nav-team-label" data-translate="nav-team-label">Team Management</span>
    </a>
    <a href="level.html" id="nav-level">
      <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 7v10l10 5 10-5V7"/></svg>
      <span id="nav-level-label" data-translate="nav-level-label">Level</span>
    </a>
    <a href="profile.html" class="active" aria-current="page" id="nav-profile">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M2 20v-2a8 8 0 0 1 16 0v2"/></svg>
      <span id="nav-profile-label" data-translate="nav-profile-label">Profile</span>
    </a>
  </nav>

  <script>
    
    // --- Notifications System (top left area) ---
    async function loadNotifications() {
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('❌ No token for notifications');
        return;
      }
      
      try {
        console.log('🔄 Loading notifications...');
        const res = await fetch('/api/notifications', {
          headers: { Authorization: "Bearer " + token }
        });
        
        console.log('📊 Notifications response status:', res.status);
        
        if (!res.ok) {
          console.error('❌ Notifications API error:', res.status);
          return;
        }
        
        const notes = await res.json();
        console.log('✅ Notifications loaded:', notes);
        
        const bar = document.getElementById('system-notification-bar');
        if (notes && notes.length > 0) {
          // Filter out any installation-related notifications
          const filteredNotes = notes.filter(note => {
            const message = note.message.toLowerCase();
            return !message.includes('install') && 
                   !message.includes('download') && 
                   !message.includes('add to home') && 
                   !message.includes('pwa') && 
                   !message.includes('progressive web app') &&
                   !message.includes('app installation') &&
                   !message.includes('install app');
          });
          
          if (filteredNotes.length > 0) {
            bar.innerHTML = filteredNotes.map(n =>
              `<span style="margin-right:22px;color:${n.type==='success'?'#43e97b':n.type==='error'?'#ff5858':'#fff'};">${n.message}</span>`
            ).join('');
            bar.style.display = "block";
          } else {
            bar.style.display = "none";
          }
        } else {
          bar.style.display = "none";
        }
      } catch (err) {
        console.error('❌ Error loading notifications:', err);
        // If API fails, hide notification bar
        document.getElementById('system-notification-bar').style.display = "none";
      }
    }





    // --- Profile Data ---
    // Function to update level display
    function updateLevelDisplay(data) {
      if (data.is_temporary_worker) {
        document.getElementById('user-level-pill').textContent = "Temporary Worker";
        document.getElementById('user-level-pill').style.background = "#ff9800";
        document.getElementById('user-level-pill').style.color = "#fff";
        document.getElementById('user-level-pill').style.border = "1px solid #f57c00";
      } else {
        document.getElementById('user-level-pill').textContent = "Level " + (data.level || '--');
        document.getElementById('user-level-pill').style.background = "#e3f0ffbb";
        document.getElementById('user-level-pill').style.color = "#2979ff";
        document.getElementById('user-level-pill').style.border = "1px solid #bd7de7";
      }
    }

    async function loadProfileData() {
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('❌ No authentication token found, redirecting to login');
        window.location.href = "index.html";
        return;
      }

      // Show loading state
      document.getElementById('profile-name').textContent = "Loading...";
      document.getElementById('profile-phone').textContent = "Loading...";
      document.getElementById('user-level-pill').textContent = "Loading...";
      
      try {
        console.log('🔄 Loading profile data...');
        console.log('🔑 Using token:', token.substring(0, 20) + '...');
        console.log('🚫 Cache-busting enabled with timestamp:', Date.now());
        
        const res = await fetch('/api/user/stats?' + Date.now(), { 
          headers: { 
            Authorization: "Bearer " + token,
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          } 
        });
        
        console.log('📊 Response status:', res.status);
        console.log('📊 Response headers:', Object.fromEntries(res.headers.entries()));
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('❌ API Error:', res.status, errorText);
          
          // Show detailed error information
          const notificationBar = document.getElementById('system-notification-bar');
          notificationBar.innerHTML = `<span style="color:#ff5858;">API Error ${res.status}: ${errorText}</span>`;
          notificationBar.style.display = "block";
          
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('✅ Profile data received:', data);
        
        // User info display - all data from database
        console.log('📊 Profile data from API:', data);
        
        // Update profile information
        document.getElementById('profile-phone').textContent = data.phone || "--";
        
        // Create personalized avatar from name
        let avatar = "👤";
        if (data.name) {
          const initials = data.name.split(' ').map(word => word.charAt(0).toUpperCase()).join('').slice(0, 2);
          avatar = initials || "👤";
        }
        document.getElementById('profile-avatar').textContent = avatar;
        
        updateLevelDisplay(data);
        
        // Fetch user name from bound details
        await loadUserNameFromBoundDetails();
        
        // Update financial information with proper formatting
        // Today's Earning: Use backend data that resets at midnight via daily reset service
        document.getElementById('today-earning').textContent = "KES " + parseFloat(data.today_earning || 0).toFixed(2);
        
        // Month's Earning: Use backend data that resets at new month
        document.getElementById('month-earning').textContent = "KES " + parseFloat(data.month_earning || 0).toFixed(2);
        // Total Revenue: Total amount earned from all completed tasks since account creation
        document.getElementById('total-revenue').textContent = "KES " + parseFloat(data.total_revenue || 0).toFixed(2);
        
        // Total Withdrawal: Total amount withdrawn from the account
        document.getElementById('total-withdrawal').textContent = "KES " + parseFloat(data.total_withdrawal || 0).toFixed(2);
        
        // Current Wallet Balance: Available balance in the account
        document.getElementById('wallet-balance').textContent = "KES " + parseFloat(data.wallet_balance || 0).toFixed(2);
        document.getElementById('bond-amount').textContent = "Level " + (data.level || '--');
        
        // Profit: Total Revenue + Referral Earnings + Awards
        // This represents the total amount earned including all sources
        const totalRevenue = parseFloat(data.total_revenue || 0);
        const referralEarnings = parseFloat(data.referral_earnings_total || 0);
        const profit = totalRevenue + referralEarnings; // Total revenue + referral earnings
        
        // Update profit display with proper styling
        const profitElement = document.getElementById('profit');
        profitElement.textContent = "KES " + profit.toFixed(2);
        
        // Apply appropriate styling based on profit value
        if (profit > 0) {
          profitElement.parentElement.className = 'earn-block profit';
        } else {
          profitElement.parentElement.className = 'earn-block';
        }
        
        // Store profile data globally for use in other functions
        window.lastProfileData = data;
        
        // Update task information
        document.getElementById('tasks-done').textContent = data.tasks_done || 0;
        
        // Update referral information
        document.getElementById('referral-code').textContent = data.invitation_code || "--";
        
        // Show referrer's invitation code (not name)
        const referredByText = data.referred_by || "--";
        document.getElementById('referred-by').textContent = referredByText;
        
        // Update member since date
        if (data.created_at) {
          const createdDate = new Date(data.created_at);
          const formattedDate = createdDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          document.getElementById('member-since').textContent = formattedDate;
        } else {
          document.getElementById('member-since').textContent = "--";
        }
        
        // Handle temporary worker status display
        const tempWorkerInfo = document.getElementById('temp-worker-info');
        const tempWorkerStartDate = document.getElementById('temp-worker-start-date');
        
        if (data.is_temporary_worker) {
          tempWorkerInfo.style.display = 'block';
          tempWorkerStartDate.style.display = 'block';
          
          // Format and display start date
          if (data.temp_worker_start_date) {
            const startDate = new Date(data.temp_worker_start_date);
            const formattedDate = startDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            document.getElementById('temp-worker-date').textContent = formattedDate;
          } else {
            document.getElementById('temp-worker-date').textContent = 'Recently';
          }
          
          // Load temporary worker countdown
          loadTempWorkerCountdown();
        } else {
          tempWorkerInfo.style.display = 'none';
          tempWorkerStartDate.style.display = 'none';
        }
        
        console.log('✅ Profile updated with latest data from database');
        console.log('💰 Financial Summary:', {
          todayEarning: data.today_earning,
          monthEarning: data.month_earning,
          totalRevenue: data.total_revenue,
          totalWithdrawal: data.total_withdrawal,
          walletBalance: data.wallet_balance,
          profit: profit,
          calculation: 'Profit = Total Revenue - Total Withdrawals'
        });
        console.log('👤 User Status:', {
          isTemporaryWorker: data.is_temporary_worker,
          level: data.level,
          startDate: data.temp_worker_start_date
        });
        
        // Load task history and progress (with error handling)
        try {
          await loadTaskHistory();
        } catch (taskError) {
          console.error('⚠️ Task history loading failed:', taskError);
          // Don't fail the entire profile load for task history issues
        }
        
        // Start real-time balance updates
        startRealTimeBalanceUpdates();
        
        // Show success notification
        const notificationBar = document.getElementById('system-notification-bar');
        notificationBar.innerHTML = `<span style="color:#43e97b;">✅ Profile data loaded successfully!</span>`;
        notificationBar.style.display = "block";
        setTimeout(() => {
          notificationBar.style.display = "none";
        }, 3000);
        
      } catch (error) {
        console.error('❌ Error loading profile data:', error);
        document.getElementById('profile-name').textContent = "Error loading data";
        document.getElementById('profile-phone').textContent = "Please try again";
        document.getElementById('user-level-pill').textContent = "Level --";
        
        // Show detailed error notification
        const notificationBar = document.getElementById('system-notification-bar');
        notificationBar.innerHTML = `<span style="color:#ff5858;">Error loading profile data: ${error.message}</span>`;
        notificationBar.style.display = "block";
        
        // If it's an authentication error, redirect to login
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
          console.log('🔐 Authentication error, redirecting to login');
          setTimeout(() => {
            localStorage.removeItem('token');
            window.location.href = "index.html";
          }, 2000);
        }
      }
    }

    // Flag to prevent multiple countdown creations
    let countdownCreated = false;
    
    // Load temporary worker countdown
    async function loadTempWorkerCountdown() {
      // Prevent multiple countdown creations
      if (countdownCreated) {
        return;
      }
      try {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        const res = await fetch('/api/user/temp-worker-status', {
          headers: { Authorization: "Bearer " + token }
        });
        
        if (res.ok) {
          const data = await res.json();
          
          if (data.isTempWorker) {
            // Remove any existing countdown to prevent duplicates
            const existingCountdown = document.getElementById('temp-worker-countdown');
            if (existingCountdown) {
              existingCountdown.remove();
            }
            
            // Create countdown display matching home.html style
            const countdownDiv = document.createElement('div');
            countdownDiv.id = 'temp-worker-countdown';
            countdownDiv.style.cssText = `
              background: linear-gradient(90deg, #ff6b35, #f7931e);
              color: white;
              padding: 6px 12px;
              border-radius: 8px;
              font-size: 0.8em;
              font-weight: 600;
              margin: 8px 0;
              display: block;
              text-align: center;
              box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
              width: 100%;
              max-width: 100%;
              box-sizing: border-box;
              position: relative;
              z-index: 1;
            `;
            
            countdownDiv.innerHTML = `
              <span id="countdown-timer">Loading...</span>
            `;
            
            // Insert countdown after the user info row for better mobile layout
            const userInfoRow = document.querySelector('.user-info-row');
            if (userInfoRow && userInfoRow.parentNode) {
              userInfoRow.parentNode.insertBefore(countdownDiv, userInfoRow.nextSibling);
            } else {
              // Fallback: insert at the beginning of main content
              const mainContent = document.querySelector('.main-content');
              if (mainContent) {
                mainContent.insertBefore(countdownDiv, mainContent.firstChild);
              }
            }
            
            // Start countdown timer (no parameters needed, uses same calculation as home.html)
            startCountdownTimer();
            
            // Mark countdown as created to prevent duplicates
            countdownCreated = true;
          }
        }
      } catch (error) {
        console.error('Error loading temp worker countdown:', error);
      }
    }

    // Variable to store the countdown interval
    let countdownInterval = null;
    
    // Start countdown timer matching home.html format and calculation
    function startCountdownTimer() {
      // Clear any existing interval to prevent multiple timers
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      // Get trial start date from localStorage (same as home.html)
      const trialStartDateStr = localStorage.getItem('trialStartDate');
      const trialStartDate = trialStartDateStr ? new Date(trialStartDateStr) : new Date();
      const totalTrialTime = 5 * 24 * 60 * 60 * 1000; // 5 days in milliseconds
      
      function updateTimer() {
        const now = new Date();
        const elapsedTime = now - trialStartDate;
        const remainingTime = Math.max(0, totalTrialTime - elapsedTime);

        const daysLeft = Math.floor(remainingTime / (24 * 60 * 60 * 1000));
        const hoursLeft = Math.floor((remainingTime % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const minutesLeft = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
        const secondsLeft = Math.floor((remainingTime % (60 * 1000)) / 1000);

        const countdownElement = document.getElementById('countdown-timer');
        if (countdownElement) {
          if (remainingTime <= 0) {
            countdownElement.textContent = '⏰ Trial Period Expired! Upgrade to Level 1 to continue earning';
            countdownElement.style.color = '#ff4757';
          } else {
            countdownElement.textContent = `🎯 Trial Worker - Task 1/5 (4 tasks remaining) | ${daysLeft}d ${hoursLeft}h ${minutesLeft}m ${secondsLeft}s`;
          }
        }
      }
      
      updateTimer();
      countdownInterval = setInterval(updateTimer, 1000);
    }

    // Load user name from bound details
    async function loadUserNameFromBoundDetails() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          document.getElementById('profile-name').textContent = "User";
          return;
        }
        
        console.log('🔄 Loading user name from bound details...');
        const res = await fetch('/api/user/binding-status', {
          headers: { Authorization: "Bearer " + token }
        });
        
        console.log('📊 Binding status response:', res.status);
        
        if (res.ok) {
          const data = await res.json();
          console.log('📊 Binding status data:', data);
          
          if (data.isBound && data.fullName) {
            document.getElementById('profile-name').textContent = data.fullName;
            console.log('✅ User name loaded from bound details:', data.fullName);
          } else {
            console.log('ℹ️ User not bound or no full name, using fallback');
            // Fallback to phone number if no bound name
            const userStatsRes = await fetch('/api/user/stats?' + Date.now(), {
              headers: { Authorization: "Bearer " + token }
            });
            if (userStatsRes.ok) {
              const userData = await userStatsRes.json();
              document.getElementById('profile-name').textContent = userData.phone || "User";
            } else {
              document.getElementById('profile-name').textContent = "User";
            }
          }
        } else {
          console.log('⚠️ Binding status failed, using fallback');
          // Fallback to phone number if binding status fails
          const userStatsRes = await fetch('/api/user/stats?' + Date.now(), {
            headers: { Authorization: "Bearer " + token }
          });
          if (userStatsRes.ok) {
            const userData = await userStatsRes.json();
            document.getElementById('profile-name').textContent = userData.phone || "User";
          } else {
            document.getElementById('profile-name').textContent = "User";
          }
        }
      } catch (error) {
        console.error('❌ Error loading user name from bound details:', error);
        // Fallback to phone number
        try {
          const token = localStorage.getItem('token');
          if (token) {
            const userStatsRes = await fetch('/api/user/stats?' + Date.now(), {
              headers: { Authorization: "Bearer " + token }
            });
            if (userStatsRes.ok) {
              const userData = await userStatsRes.json();
              document.getElementById('profile-name').textContent = userData.phone || "User";
            } else {
              document.getElementById('profile-name').textContent = "User";
            }
          } else {
            document.getElementById('profile-name').textContent = "User";
          }
        } catch (fallbackError) {
          console.error('❌ Fallback error:', fallbackError);
          document.getElementById('profile-name').textContent = "User";
        }
      }
    }

    // Load task history and progress
    async function loadTaskHistory(page = 1) {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      try {
        console.log('🔄 Loading task history...');
        const response = await fetch(`/api/tasks/task-history?page=${page}&limit=5`, {
          headers: { Authorization: "Bearer " + token }
        });
        
        console.log('📊 Task history response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('❌ Task history API error:', response.status, errorText);
          
          // Show error in task history section
          const listContainer = document.getElementById('task-history-list');
          if (listContainer) {
            listContainer.innerHTML = `<div class="loading-message" style="color: #ff5858;">Error loading task history: ${response.status} - ${errorText}</div>`;
          }
          
          throw new Error(`Task history failed: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('✅ Task history loaded:', data);
        
        // Update task progress info
        updateTaskProgressInfo(data.summary);
        
        // Update task history stats
        updateTaskHistoryStats(data.summary);
        
        // Render task history list
        renderTaskHistoryList(data.taskHistory);
        
        // Update pagination
        updateTaskHistoryPagination(data.pagination);
        
      } catch (error) {
        console.error('❌ Error loading task history:', error);
        // Show a user-friendly message instead of failing silently
        const listContainer = document.getElementById('task-history-list');
        if (listContainer) {
          listContainer.innerHTML = `<div class="loading-message" style="color: #ff5858;">Unable to load task history: ${error.message}</div>`;
        }
      }
    }
    
    // Update task progress information
    function updateTaskProgressInfo(summary) {
      const progressInfo = document.getElementById('task-progress-info');
      if (progressInfo) {
        const totalTasks = summary.totalTasksCompleted || 0;
        const activeDays = summary.activeDays || 0;
        const longestStreak = summary.longestStreak || 0;
        
        progressInfo.textContent = `${totalTasks} tasks completed • ${activeDays} active days • ${longestStreak} day streak`;
      }
    }
    
    // Update task history statistics
    function updateTaskHistoryStats(summary) {
      document.getElementById('total-tasks-completed').textContent = summary.totalTasksCompleted || 0;
      document.getElementById('active-days').textContent = summary.activeDays || 0;
      document.getElementById('longest-streak').textContent = summary.longestStreak || 0;
      document.getElementById('average-reward').textContent = `KES ${parseFloat(summary.averageReward || 0).toFixed(2)}`;
    }
    
    // Render task history list
    function renderTaskHistoryList(taskHistory) {
      const listContainer = document.getElementById('task-history-list');
      
      if (!taskHistory || taskHistory.length === 0) {
        listContainer.innerHTML = '<div class="loading-message">No task history available</div>';
        return;
      }
      
      const historyHTML = taskHistory.map(task => `
        <div class="task-history-item">
          <div class="task-name">${task.task_name}</div>
          <div class="task-details">
            <span class="task-reward">+KES ${parseFloat(task.reward_amount).toFixed(2)}</span>
            <span class="task-level">Level ${task.user_level_at_completion}</span>
            <span class="task-date">${formatDate(task.completion_date)}</span>
          </div>
        </div>
      `).join('');
      
      listContainer.innerHTML = historyHTML;
    }
    
    // Update task history pagination
    function updateTaskHistoryPagination(pagination) {
      const paginationContainer = document.getElementById('task-history-pagination');
      const prevBtn = document.getElementById('prev-page-btn');
      const nextBtn = document.getElementById('next-page-btn');
      const pageInfo = document.getElementById('page-info');
      
      if (pagination.totalItems > 0) {
        paginationContainer.style.display = 'flex';
        pageInfo.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages}`;
        prevBtn.disabled = !pagination.hasPrevPage;
        nextBtn.disabled = !pagination.hasNextPage;
        
        // Add event listeners for pagination
        prevBtn.onclick = () => loadTaskHistory(pagination.currentPage - 1);
        nextBtn.onclick = () => loadTaskHistory(pagination.currentPage + 1);
      } else {
        paginationContainer.style.display = 'none';
      }
    }
    
    // Format date for display
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      });
    }
    
    // Real-time balance updates
    function startRealTimeBalanceUpdates() {
      // Update balance every 15 seconds with automatic notification
      setInterval(async () => {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        try {
          const res = await fetch('/api/user/stats?' + Date.now(), {
            headers: { 
              Authorization: "Bearer " + token,
              'Cache-Control': 'no-cache, no-store, must-revalidate',
              'Pragma': 'no-cache',
              'Expires': '0'
            }
          });
          if (res.ok) {
            const data = await res.json();
            
            // Update all profile data, not just balance
            document.getElementById('profile-phone').textContent = data.phone || "--";
            
            // Update personalized avatar
            let avatar = "👤";
            if (data.name) {
              const initials = data.name.split(' ').map(word => word.charAt(0).toUpperCase()).join('').slice(0, 2);
              avatar = initials || "👤";
            }
            document.getElementById('profile-avatar').textContent = avatar;
            
            updateLevelDisplay(data);
            
            // Update user name from bound details
            await loadUserNameFromBoundDetails();
            
            // Update financial information
            // Today's Earning: Use backend data that resets at midnight via daily reset service
            document.getElementById('today-earning').textContent = "KES " + parseFloat(data.today_earning || 0).toFixed(2);
            
            // Month's Earning: Use backend data that resets at new month
            document.getElementById('month-earning').textContent = "KES " + parseFloat(data.month_earning || 0).toFixed(2);
            document.getElementById('total-revenue').textContent = "KES " + parseFloat(data.total_revenue || 0).toFixed(2);
            document.getElementById('total-withdrawal').textContent = "KES " + parseFloat(data.total_withdrawal || 0).toFixed(2);
            document.getElementById('wallet-balance').textContent = "KES " + parseFloat(data.wallet_balance || 0).toFixed(2);
            document.getElementById('bond-amount').textContent = "Level " + (data.level || '--');
            
            // Profit: Total Revenue + Referral Earnings + Awards
            // This represents the total amount earned including all sources
            const totalRevenue = parseFloat(data.total_revenue || 0);
            const referralEarnings = parseFloat(data.referral_earnings_total || 0);
            const profit = totalRevenue + referralEarnings; // Total revenue + referral earnings
            
            // Update profit display with proper styling
            const profitElement = document.getElementById('profit');
            profitElement.textContent = "KES " + profit.toFixed(2);
            
            // Apply appropriate styling based on profit value
            if (profit > 0) {
              profitElement.parentElement.className = 'earn-block profit';
            } else {
              profitElement.parentElement.className = 'earn-block';
            }
            
            // Update task information
            document.getElementById('tasks-done').textContent = data.tasks_done || 0;
            
            // Update referral information
            document.getElementById('referral-code').textContent = data.invitation_code || "--";
            
            // Show referrer's invitation code (not name)
            const referredByText = data.referred_by || "--";
            document.getElementById('referred-by').textContent = referredByText;
            
            // Update member since date
            if (data.created_at) {
              const createdDate = new Date(data.created_at);
              const formattedDate = createdDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
              document.getElementById('member-since').textContent = formattedDate;
            } else {
              document.getElementById('member-since').textContent = "--";
            }
            
            // Handle temporary worker status display in real-time updates
            const tempWorkerInfo = document.getElementById('temp-worker-info');
            const tempWorkerStartDate = document.getElementById('temp-worker-start-date');
            
            if (data.is_temporary_worker) {
              tempWorkerInfo.style.display = 'block';
              tempWorkerStartDate.style.display = 'block';
              
              // Format and display start date
              if (data.temp_worker_start_date) {
                const startDate = new Date(data.temp_worker_start_date);
                const formattedDate = startDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                });
                document.getElementById('temp-worker-date').textContent = formattedDate;
              } else {
                document.getElementById('temp-worker-date').textContent = 'Recently';
              }
            } else {
              tempWorkerInfo.style.display = 'none';
              tempWorkerStartDate.style.display = 'none';
            }
            
            // Refresh task history to show latest completions
            await loadTaskHistory();
            
            // Show payment notification if balance increased
            const currentBalance = parseFloat(data.wallet_balance || 0);
            const previousBalance = parseFloat(localStorage.getItem('previousBalance') || 0);
            
            if (currentBalance > previousBalance) {
              const increase = currentBalance - previousBalance;
              showPaymentNotification(increase);
            }
            
            localStorage.setItem('previousBalance', currentBalance);
            
            console.log('🔄 Profile auto-updated:', {
              balance: data.wallet_balance,
              tasks: data.tasks_done,
              earnings: data.today_earning
            });
            
            // Always show update notification every 15 seconds
            showUpdateNotification();
          }
        } catch (error) {
          console.error('Error updating profile data:', error);
        }
      }, 15000); // Update every 15 seconds with automatic notification
      
      // Also update immediately when page becomes visible
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          loadProfileData();
        }
      });
      
      // Update when user returns to the tab
      window.addEventListener('focus', () => {
        loadProfileData();
      });
    }

    function showPaymentNotification(amount) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(90deg, #4caf50, #45a049);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        z-index: 10000;
        font-weight: 600;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.2em;">💰</span>
          <div>
            <div style="font-size: 1.1em;">Payment Received!</div>
            <div style="font-size: 0.9em; opacity: 0.9;">KES ${amount.toFixed(2)} added to your balance</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 5 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 5000);
    }

    function showUpdateNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        background: linear-gradient(90deg, #2979ff, #1565c0);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(41, 121, 255, 0.3);
        z-index: 10000;
        font-weight: 600;
        max-width: 300px;
        animation: slideInLeft 0.3s ease-out;
        font-size: 0.9em;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.1em;">🔄</span>
          <div>
            <div style="font-size: 1em;">Profile Updated</div>
            <div style="font-size: 0.8em; opacity: 0.9;">Latest data loaded automatically</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOutLeft 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Add CSS animations for notifications
    const notificationStyle = document.createElement('style');
    notificationStyle.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      @keyframes slideInLeft {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutLeft {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(-100%); opacity: 0; }
      }
    `;
    document.head.appendChild(notificationStyle);

    // --- Prevent PWA Installation ---
    // Explicitly prevent any PWA installation prompts
    window.addEventListener('beforeinstallprompt', function(e) {
      console.log('🚫 Preventing PWA installation prompt');
      e.preventDefault();
      return false;
    });
    
    // Prevent service worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          console.log('🚫 Unregistering service worker:', registration.scope);
          registration.unregister();
        }
      });
    }
    
    // Remove any PWA-related elements from DOM
    document.addEventListener('DOMContentLoaded', function() {
      // Remove any manifest links
      const manifestLinks = document.querySelectorAll('link[rel="manifest"]');
      manifestLinks.forEach(link => {
        console.log('🚫 Removing manifest link');
        link.remove();
      });
      
      // Remove any apple-touch-icon links
      const appleIcons = document.querySelectorAll('link[rel="apple-touch-icon"]');
      appleIcons.forEach(icon => {
        console.log('🚫 Removing apple-touch-icon');
        icon.remove();
      });
      
      // Remove any theme-color meta tags
      const themeColors = document.querySelectorAll('meta[name="theme-color"]');
      themeColors.forEach(meta => {
        console.log('🚫 Removing theme-color meta');
        meta.remove();
      });
      
      // Remove only specific installation button elements
      const installButtons = document.querySelectorAll('[class*="install-btn"], [id*="install-btn"], [class*="download-btn"], [id*="download-btn"]');
      installButtons.forEach(element => {
        console.log('🚫 Removing installation button:', element);
        element.remove();
      });
      
      // Block any installation-related notifications
      const notificationBar = document.getElementById('system-notification-bar');
      if (notificationBar) {
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' || mutation.type === 'characterData') {
              const text = notificationBar.textContent.toLowerCase();
              if (text.includes('install') || text.includes('download') || text.includes('add to home') || text.includes('pwa')) {
                console.log('🚫 Blocking installation notification:', notificationBar.textContent);
                notificationBar.style.display = 'none';
                notificationBar.innerHTML = '';
              }
            }
          });
        });
        observer.observe(notificationBar, { childList: true, characterData: true, subtree: true });
      }
    });
    
    // Additional blocking for dynamic content
    setInterval(function() {
      // Remove only specific installation button elements
      const installButtons = document.querySelectorAll('[class*="install-btn"], [id*="install-btn"], [class*="download-btn"], [id*="download-btn"]');
      installButtons.forEach(element => {
        console.log('🚫 Removing dynamic installation button:', element);
        element.remove();
      });
      
      // Block installation-related notifications
      const notificationBar = document.getElementById('system-notification-bar');
      if (notificationBar && notificationBar.textContent) {
        const text = notificationBar.textContent.toLowerCase();
        if (text.includes('install') || text.includes('download') || text.includes('add to home') || text.includes('pwa')) {
          console.log('🚫 Blocking installation notification:', notificationBar.textContent);
          notificationBar.style.display = 'none';
          notificationBar.innerHTML = '';
        }
      }
    }, 5000); // Check every 5 seconds instead of every second
    
    // --- Logout Function ---
    function logoutUser() {
      console.log('🚪 Logout function called');
      // Show confirmation dialog
      if (confirm('Are you sure you want to log out? You will need to enter your credentials again to access the system.')) {
        // Clear all authentication data
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        sessionStorage.clear();
        
        // Clear any cookies
        document.cookie.split(";").forEach(function(c) { 
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
        });
        
        // Show logout notification
        console.log('🚪 Showing logout notification');
        showLogoutNotification();
        
        // Redirect to login page after a short delay
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1500);
      }
    }

    // --- Exit Button ---
    document.getElementById('exit-btn').onclick = logoutUser;

    // Show logout notification
    function showLogoutNotification() {
      console.log('🚪 Creating logout notification popup');
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ff4757, #c62828);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(198, 40, 40, 0.4);
        z-index: 10000;
        font-weight: 600;
        text-align: center;
        animation: fadeInScale 0.3s ease-out;
        font-size: 1.1em;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
          <span style="font-size: 2em;">🚪</span>
          <div>
            <div style="font-size: 1.2em; margin-bottom: 5px;">Logging Out...</div>
            <div style="font-size: 0.9em; opacity: 0.9;">Please wait while we secure your session</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Add animation CSS
      const logoutStyle = document.createElement('style');
      logoutStyle.textContent = `
        @keyframes fadeInScale {
          from { 
            opacity: 0; 
            transform: translate(-50%, -50%) scale(0.8); 
          }
          to { 
            opacity: 1; 
            transform: translate(-50%, -50%) scale(1); 
          }
        }
      `;
      document.head.appendChild(logoutStyle);
    }

    // Function to update today's earnings display when a task is completed
    window.updateTodayEarningsDisplay = function(additionalEarning) {
      const todayEarningElement = document.getElementById('today-earning');
      if (todayEarningElement) {
        const currentText = todayEarningElement.textContent;
        const currentAmount = parseFloat(currentText.replace('KES ', '')) || 0;
        const newAmount = currentAmount + additionalEarning;
        todayEarningElement.textContent = "KES " + newAmount.toFixed(2);
        console.log('💰 Today\'s earnings updated:', newAmount);
      }
      
      // Also update total revenue and profit
      updateTotalRevenueAndProfit(additionalEarning);
    }
    
    // Function to update monthly earnings display when a task is completed
    window.updateMonthlyEarningsDisplay = function(additionalEarning) {
      const monthEarningElement = document.getElementById('month-earning');
      if (monthEarningElement) {
        const currentText = monthEarningElement.textContent;
        const currentAmount = parseFloat(currentText.replace('KES ', '')) || 0;
        const newAmount = currentAmount + additionalEarning;
        monthEarningElement.textContent = "KES " + newAmount.toFixed(2);
        console.log('💰 Monthly earnings updated:', newAmount);
      }
      
      // Also update total revenue and profit
      updateTotalRevenueAndProfit(additionalEarning);
    }
    
    // Function to update total revenue and profit when a task is completed
    function updateTotalRevenueAndProfit(additionalEarning) {
      // Update total revenue
      const totalRevenueElement = document.getElementById('total-revenue');
      if (totalRevenueElement) {
        const currentText = totalRevenueElement.textContent;
        const currentAmount = parseFloat(currentText.replace('KES ', '')) || 0;
        const newAmount = currentAmount + additionalEarning;
        totalRevenueElement.textContent = "KES " + newAmount.toFixed(2);
        console.log('💰 Total revenue updated:', newAmount);
      }
      
      // Update profit (total revenue + referral earnings)
      const profitElement = document.getElementById('profit');
      
      if (profitElement && totalRevenueElement) {
        const totalRevenueText = totalRevenueElement.textContent;
        const totalRevenue = parseFloat(totalRevenueText.replace('KES ', '')) || 0;
        
        // Get referral earnings from the last API response or default to 0
        const referralEarnings = parseFloat(window.lastProfileData?.referral_earnings_total || 0);
        const profit = totalRevenue + referralEarnings; // Total revenue + referral earnings
        
        profitElement.textContent = "KES " + profit.toFixed(2);
        
        // Apply appropriate styling based on profit value
        if (profit > 0) {
          profitElement.parentElement.className = 'earn-block profit';
        } else {
          profitElement.parentElement.className = 'earn-block';
        }
        
        console.log('💰 Profit updated:', profit, '(Revenue:', totalRevenue, '+ Referrals:', referralEarnings, ')');
      }
    }
    
    // Function to copy invitation code
    function copyInvitationCode() {
      const invitationCodeElement = document.getElementById('referral-code');
      const copyButton = document.querySelector('.copy-btn');
      
      if (!invitationCodeElement || invitationCodeElement.textContent === '--') {
        alert('No invitation code available');
        return;
      }
      
      const invitationCode = invitationCodeElement.textContent;
      
      // Copy to clipboard
      navigator.clipboard.writeText(invitationCode).then(() => {
        // Show success feedback
        copyButton.textContent = '✅ Copied!';
        copyButton.classList.add('copied');
        
        // Reset button after 2 seconds
        setTimeout(() => {
          copyButton.textContent = '📋 Copy';
          copyButton.classList.remove('copied');
        }, 2000);
        
        // Show notification
        showNotification(`Invitation code "${invitationCode}" copied to clipboard!`, 'success');
      }).catch(err => {
        console.error('Failed to copy invitation code:', err);
        alert('Failed to copy invitation code. Please try again.');
      });
    }

    // Function to refresh all profile data from API (backup method)
    window.refreshProfileData = async function() {
      console.log('🔄 Refreshing profile data from API...');
      try {
        await loadProfileData();
        console.log('✅ Profile data refreshed successfully');
        
        // Show success notification
        const notificationBar = document.getElementById('system-notification-bar');
        notificationBar.innerHTML = '<span style="color:#4caf50;">✅ Profile data refreshed successfully!</span>';
        notificationBar.style.display = "block";
        setTimeout(() => {
          notificationBar.style.display = "none";
        }, 3000);
      } catch (error) {
        console.error('❌ Error refreshing profile data:', error);
        
        // Show error notification
        const notificationBar = document.getElementById('system-notification-bar');
        notificationBar.innerHTML = '<span style="color:#ff5858;">❌ Error refreshing profile data</span>';
        notificationBar.style.display = "block";
        setTimeout(() => {
          notificationBar.style.display = "none";
        }, 3000);
      }
    }
    
    
    // Prevent zooming on mobile devices
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Session Management Functions
    let currentSessions = [];
    let currentDeviceFingerprint = null;
    
    // Load active sessions
    async function loadActiveSessions() {
      console.log('🔍 Loading active sessions...');
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.log('❌ No token found');
          return;
        }
        
        console.log('📡 Fetching sessions from API...');
        const response = await fetch('/api/sessions/sessions', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('📊 Sessions response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('✅ Sessions loaded:', data);
          currentSessions = data.sessions || [];
          currentDeviceFingerprint = data.currentDevice;
          displaySessions();
        } else {
          const errorText = await response.text();
          console.error('❌ Failed to load sessions:', response.status, errorText);
          showSessionError('Failed to load sessions');
        }
      } catch (error) {
        console.error('❌ Error loading sessions:', error);
        showSessionError('Error loading sessions');
      }
    }
    
    // Display sessions
    function displaySessions() {
      const sessionsContent = document.getElementById('sessions-content');
      
      if (currentSessions.length === 0) {
        sessionsContent.innerHTML = '<div class="no-sessions">No active sessions found</div>';
        return;
      }
      
      sessionsContent.innerHTML = currentSessions.map(session => {
        const isCurrent = session.isCurrent;
        const deviceIcon = getDeviceIcon(session.deviceInfo.deviceType);
        const loginTime = new Date(session.createdAt).toLocaleString();
        
        return `
          <div class="session-item ${isCurrent ? 'current' : ''}">
            <div class="session-device-type">
              ${deviceIcon} ${session.deviceInfo.deviceType} - ${session.deviceInfo.browser} on ${session.deviceInfo.os}
            </div>
            <div class="session-device-info">
              IP: ${session.deviceInfo.ip} | ${isCurrent ? 'Current Device' : 'Other Device'}
            </div>
            <div class="session-time">
              Logged in: ${loginTime}
            </div>
            ${!isCurrent ? `
              <div class="session-actions">
                <button class="session-logout-btn" onclick="logoutFromDevice(${session.id})">
                  Logout This Device
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Get device icon
    function getDeviceIcon(deviceType) {
      switch (deviceType.toLowerCase()) {
        case 'mobile': return '📱';
        case 'tablet': return '📱';
        case 'desktop': return '💻';
        default: return '🖥️';
      }
    }
    
    // Logout from specific device
    async function logoutFromDevice(sessionId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        const response = await fetch(`/api/sessions/sessions/${sessionId}/logout`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showSessionSuccess('Successfully logged out from device');
          loadActiveSessions(); // Refresh sessions
        } else {
          showSessionError('Failed to logout from device');
        }
      } catch (error) {
        console.error('Error logging out from device:', error);
        showSessionError('Error logging out from device');
      }
    }
    
    // Logout from all devices
    async function logoutFromAllDevices() {
      console.log('🚪 Logging out from all devices...');
      if (!confirm('Are you sure you want to logout from all devices? This will end your current session too.')) {
        console.log('❌ User cancelled logout');
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.log('❌ No token found');
          return;
        }
        
        console.log('📡 Sending logout request...');
        const response = await fetch('/api/sessions/sessions/logout-all', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('📊 Logout response status:', response.status);
        
        if (response.ok) {
          console.log('✅ Successfully logged out from all devices');
          showSessionSuccess('Successfully logged out from all devices');
          // Redirect to login page
          setTimeout(() => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
          }, 2000);
        } else {
          const errorText = await response.text();
          console.error('❌ Failed to logout from all devices:', response.status, errorText);
          showSessionError('Failed to logout from all devices');
        }
      } catch (error) {
        console.error('❌ Error logging out from all devices:', error);
        showSessionError('Error logging out from all devices');
      }
    }
    
    // Load security events
    async function loadSecurityEvents() {
      try {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        const response = await fetch('/api/sessions/security-events', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          displaySecurityEvents(data.events || []);
        } else {
          console.error('Failed to load security events:', response.statusText);
        }
      } catch (error) {
        console.error('Error loading security events:', error);
      }
    }
    
    // Display security events
    function displaySecurityEvents(events) {
      const securityContent = document.getElementById('security-content');
      
      if (events.length === 0) {
        securityContent.innerHTML = '<div class="no-events">No security events found</div>';
        return;
      }
      
      securityContent.innerHTML = events.map(event => {
        const eventTime = new Date(event.createdAt).toLocaleString();
        const eventIcon = getSecurityEventIcon(event.eventType);
        
        return `
          <div class="security-item">
            <div class="security-event-type">
              ${eventIcon} ${event.eventType.replace(/_/g, ' ')}
            </div>
            <div class="security-event-info">
              ${event.details.deviceInfo ? `${event.details.deviceInfo.deviceType} - ${event.details.deviceInfo.browser}` : ''}
              ${event.details.ip ? ` | IP: ${event.details.ip}` : ''}
            </div>
            <div class="security-event-time">
              ${eventTime}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Get security event icon
    function getSecurityEventIcon(eventType) {
      switch (eventType) {
        case 'LOGIN_SUCCESS': return '✅';
        case 'LOGOUT_FROM_DEVICE': return '🚪';
        case 'LOGOUT_ALL_DEVICES': return '🚪';
        case 'SESSION_INVALID': return '⚠️';
        case 'FAILED_LOGIN': return '❌';
        default: return '🔒';
      }
    }
    
    // Show session success message
    function showSessionSuccess(message) {
      const notificationBar = document.getElementById('system-notification-bar');
      notificationBar.innerHTML = `<span style="color:#4caf50;">✅ ${message}</span>`;
      notificationBar.style.display = "block";
      setTimeout(() => {
        notificationBar.style.display = "none";
      }, 3000);
    }
    
    // Show session error message
    function showSessionError(message) {
      const notificationBar = document.getElementById('system-notification-bar');
      notificationBar.innerHTML = `<span style="color:#ff5858;">❌ ${message}</span>`;
      notificationBar.style.display = "block";
      setTimeout(() => {
        notificationBar.style.display = "none";
      }, 3000);
    }
    
    // Session management event listeners will be added in main DOMContentLoaded
    
    // --- Init ---
    document.addEventListener("DOMContentLoaded", function() {
      console.log('🚀 Profile page initialized');
      
      // Load trial countdown
      const trialScript = document.createElement('script');
      trialScript.src = 'js/trial-countdown.js';
      document.head.appendChild(trialScript);
      
      // Check if user is authenticated
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('❌ No authentication token found, redirecting to login');
        window.location.href = "index.html";
        return;
      }
      
      // Load all data with proper error handling
      Promise.allSettled([
        loadNotifications(),
        loadProfileData()
      ]).then(results => {
        console.log('📊 All profile data loading completed');
        results.forEach((result, index) => {
          if (result.status === 'rejected') {
            console.error(`❌ Component ${index} failed to load:`, result.reason);
          } else {
            console.log(`✅ Component ${index} loaded successfully`);
          }
        });
      });
    });
    
    // Make functions available globally for task completion
    window.updateTodayEarningsDisplay = updateTodayEarningsDisplay;
    window.updateMonthlyEarningsDisplay = updateMonthlyEarningsDisplay;
    
    // Session management event listeners
    // View sessions button
    document.getElementById('view-sessions-btn').addEventListener('click', function() {
      const sessionsList = document.getElementById('sessions-list');
      if (sessionsList.style.display === 'none') {
        sessionsList.style.display = 'block';
        loadActiveSessions();
      } else {
        sessionsList.style.display = 'none';
      }
    });
    
    // Close sessions button
    document.getElementById('close-sessions-btn').addEventListener('click', function() {
      document.getElementById('sessions-list').style.display = 'none';
    });
    
    // Logout all devices button
    document.getElementById('logout-all-btn').addEventListener('click', logoutFromAllDevices);
    
    // View security events button (if exists)
    const viewSecurityBtn = document.getElementById('view-security-btn');
    if (viewSecurityBtn) {
      viewSecurityBtn.addEventListener('click', function() {
        const securityEvents = document.getElementById('security-events');
        if (securityEvents.style.display === 'none') {
          securityEvents.style.display = 'block';
          loadSecurityEvents();
        } else {
          securityEvents.style.display = 'none';
        }
      });
    }
    
    // Close security events button
    const closeSecurityBtn = document.getElementById('close-security-btn');
    if (closeSecurityBtn) {
      closeSecurityBtn.addEventListener('click', function() {
        document.getElementById('security-events').style.display = 'none';
      });
    }
    
    // Cleanup function to prevent memory leaks
    window.addEventListener('beforeunload', function() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      countdownCreated = false;
    });
  </script>
  <script src="js/admin-notifications.js"></script>
</body>
</html>