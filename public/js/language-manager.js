// Global Language Manager
class LanguageManager {
  constructor() {
    this.currentLang = 'en';
    this.translations = {};
    this.initialized = false;
  }

  // Initialize the language manager
  async init() {
    if (this.initialized) return;
    
    // Load user's saved language preference
    const savedLang = localStorage.getItem('userLanguage');
    if (savedLang) {
      this.currentLang = savedLang;
    } else {
      // Get language from server if no saved preference
      await this.loadUserLanguage();
    }
    
    // Load translations
    await this.loadTranslations();
    
    // Apply language to current page
    this.applyLanguage();
    
    this.initialized = true;
    console.log('üåç Language Manager initialized with:', this.currentLang);
  }

  // Load user's language from server
  async loadUserLanguage() {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
      const response = await fetch('/api/get-lang', {
        headers: { Authorization: "Bearer " + token }
      });
      
      if (response.ok) {
        const data = await response.json();
        this.currentLang = data.lang || 'en';
        localStorage.setItem('userLanguage', this.currentLang);
      }
    } catch (error) {
      console.error('Error loading user language:', error);
    }
  }

  // Load all translations
  async loadTranslations() {
    this.translations = {
      'en': {
        // Navigation
        'nav-home-label': 'Home',
        'nav-task-label': 'Task',
        'nav-team-label': 'Team Management',
        'nav-level-label': 'Level',
        'nav-profile-label': 'Profile',
        'team-management-title': 'Team Management',
        
        // Home page
        'welcome-msg': 'Welcome to UAI',
        'start-msg': 'Start your work journey',
        'company-activities-label': 'Company Activities',
        'news-label': 'News',
        'benefits-label': 'Member Benefits',
        'positions-label': 'Advertising Positions',
        'team-expansion-label': 'Team Expansion',
        'financial-management-label': 'UAI wealth fund',
        'casino-btn-label': 'Click here to enter the casino',
        
        // Profile page
        'profile-title': 'Profile',
        'wallet-balance-label': 'Wallet Balance',
        'profit-label': 'Profit',
        'tasks-done-label': 'Tasks Done',
        'bond-label': 'Bond',
        'logout-btn': 'Log Out',
        'language-select-label': 'Select Language',
        'notification-label': 'Notification',
        'withdraw-label': 'Withdraw',
        'bind-details-label': 'Bind Withdrawal Details',
        'privacy-policy-label': 'Privacy Policy',
        
        // Task page
        'task-list-title': 'Task list',
        'ongoing-label': 'Ongoing',
        'all-label': 'All',
        'completed-label': 'Completed',
        'install-btn': 'Install',
        'completed-btn': 'Completed',
        'upgrade-required-btn': 'Upgrade Required',
        'downloading-btn': 'Downloading...',
        
        // Level page
        'level-title': 'Level',
        'choose-level-btn': 'Choose this level',
        'level-locked': 'Level Locked',
        'upgrade-info-title': 'üí∞ Upgrade Information',
        'remaining-tasks-label': 'Remaining tasks:',
        'completed-tasks-label': 'Completed tasks:',
        'cost-label': 'Cost',
        'level-locked': 'Level Locked',
        'promotion-tasks-title': 'Number of promotion tasks and commission income per day',
        'time-unit-label': 'Time unit',
        'number-of-tasks-label': 'Number of tasks',
        'total-commission-label': 'Total commission',
        'daily-label': 'Daily',
        'invitation-commission-title': 'Invitation commission profit margin',
        'invitation-method-label': 'Invitation Method',
        'invitation-rate-label': 'Invitation commission rate',
        'income-amount-label': 'Income amount',
        'task-commission-title': 'Task commission income ratio',
        'task-completion-label': 'Task completion from',
        'task-commission-ratio-label': 'Task commission ratio',
        'new-user-upgrade': 'New user upgrade to Level',
        'already-at-level': 'You are already at Level',
        'downgrade-from': 'Downgrade from Level',
        'upgrade-from': 'Upgrade from Level',
        'refund-amount': 'üí∞ Refund: KES',
        'net-cost': 'üí≥ Net cost: KES',
        'your-balance': 'üíµ Your balance: KES',
        'insufficient-balance': '‚ùå Insufficient balance (need KES',
        'sufficient-balance': '‚úÖ Sufficient balance',
        'from-level': 'from Level',
        
        // Common
        'loading': 'Loading...',
        'error': 'Error',
        'success': 'Success',
        'network-error': 'Network error! Please try again.',
        'please-login': 'Please log in first',
        'failed-to-load': 'Failed to load data',
        'upgrade-success': 'Successfully upgraded to Level',
        'cost-label': 'Cost: KES',
        'refund-label': 'Refund: KES',
        'net-cost-label': 'Net cost: KES',
        'to-level': 'to Level',
        'new-user-upgrade': 'New user upgrade to Level',
        'already-at-level': 'You are already at Level',
        'downgrade-from': 'Downgrade from Level',
        'upgrade-from': 'Upgrade from Level',
        'insufficient-balance': 'Insufficient balance (need KES',
        'sufficient-balance': 'Sufficient balance',
        'upgrade-info-title': 'üí∞ Upgrade Information'
      },
      'sw': {
        // Navigation
        'nav-home-label': 'Nyumbani',
        'nav-task-label': 'Kazi',
        'nav-team-label': 'Usimamizi wa Timu',
        'nav-level-label': 'Kiwango',
        'nav-profile-label': 'Wasifu',
        'team-management-title': 'Usimamizi wa Timu',
        
        // Home page
        'welcome-msg': 'Karibu kwenye UAI',
        'start-msg': 'Anza safari yako ya kazi',
        'company-activities-label': 'Shughuli za Kampuni',
        'news-label': 'Habari',
        'benefits-label': 'Faida za Wanachama',
        'positions-label': 'Nafasi za Matangazo',
        'team-expansion-label': 'Upanuzi wa Timu',
        'financial-management-label': 'Mfuko wa Uchumi wa UAI',
        'casino-btn-label': 'Bofya hapa kuingia kwenye kasino',
        
        // Profile page
        'profile-title': 'Wasifu',
        'wallet-balance-label': 'Salio la Wallet',
        'profit-label': 'Faida',
        'tasks-done-label': 'Kazi Zilizofanywa',
        'bond-label': 'Bond',
        'logout-btn': 'Toka',
        'language-select-label': 'Chagua Lugha',
        'notification-label': 'Arifa',
        'withdraw-label': 'Toa',
        'bind-details-label': 'Weka Maelezo ya Uondoaji',
        'privacy-policy-label': 'Sera ya Faragha',
        
        // Task page
        'task-list-title': 'Orodha ya kazi',
        'ongoing-label': 'Inaendelea',
        'all-label': 'Zote',
        'completed-label': 'Zilizokamilika',
        'install-btn': 'Sakinisha',
        'completed-btn': 'Imekamilika',
        'upgrade-required-btn': 'Inahitaji kufuzu',
        'downloading-btn': 'Inapakua...',
        
        // Level page
        'level-title': 'Kiwango',
        'choose-level-btn': 'Chagua kiwango hiki',
        'level-locked': 'Kiwango Kimefungwa',
        'upgrade-info-title': 'üí∞ Maelezo ya Kufuzu',
        'remaining-tasks-label': 'Kazi zilizobaki:',
        'completed-tasks-label': 'Kazi zilizokamilika:',
        'cost-label': 'Gharama',
        'level-locked': 'Kiwango Kimefungwa',
        'promotion-tasks-title': 'Idadi ya kazi za kukuza na mapato ya komishoni kwa siku',
        'time-unit-label': 'Kipimo cha muda',
        'number-of-tasks-label': 'Idadi ya kazi',
        'total-commission-label': 'Jumla ya komishoni',
        'daily-label': 'Kwa siku',
        'invitation-commission-title': 'Faida ya komishoni ya mialiko',
        'invitation-method-label': 'Njia ya Mialiko',
        'invitation-rate-label': 'Kiwango cha komishoni ya mialiko',
        'income-amount-label': 'Kiasi cha mapato',
        'task-commission-title': 'Kiwango cha mapato ya komishoni ya kazi',
        'task-completion-label': 'Kukamilika kwa kazi kutoka',
        'task-commission-ratio-label': 'Kiwango cha komishoni ya kazi',
        'new-user-upgrade': 'Mpya kufuzu kwa Kiwango',
        'already-at-level': 'Uko tayari kwenye Kiwango',
        'downgrade-from': 'Kushuka kutoka Kiwango',
        'upgrade-from': 'Kufuzu kutoka Kiwango',
        'refund-amount': 'üí∞ Rudi: KES',
        'net-cost': 'üí≥ Gharama halisi: KES',
        'your-balance': 'üíµ Salio lako: KES',
        'insufficient-balance': '‚ùå Salio haitoshi (inahitaji KES',
        'sufficient-balance': '‚úÖ Salio linalotosha',
        'from-level': 'kutoka Kiwango',
        
        // Common
        'loading': 'Inapakia...',
        'error': 'Hitilafu',
        'success': 'Mafanikio',
        'network-error': 'Hitilafu ya mtandao! Jaribu tena.',
        'please-login': 'Tafadhali ingia kwanza',
        'failed-to-load': 'Imeshindwa kupakia data',
        'upgrade-success': 'Imefuzu kwa mafanikio kwa Kiwango',
        'cost-label': 'Gharama: KES',
        'refund-label': 'Rudi: KES',
        'net-cost-label': 'Gharama halisi: KES',
        'to-level': 'kwa Kiwango',
        'new-user-upgrade': 'Mpya kufuzu kwa Kiwango',
        'already-at-level': 'Uko tayari kwenye Kiwango',
        'downgrade-from': 'Kushuka kutoka Kiwango',
        'upgrade-from': 'Kufuzu kutoka Kiwango',
        'insufficient-balance': 'Salio haitoshi (inahitaji KES',
        'sufficient-balance': 'Salio linalotosha',
        'upgrade-info-title': 'üí∞ Maelezo ya Kufuzu'
      },
      'fr': {
        // Navigation
        'nav-home-label': 'Accueil',
        'nav-task-label': 'T√¢ches',
        'nav-team-label': 'Gestion d\'√©quipe',
        'nav-level-label': 'Niveau',
        'nav-profile-label': 'Profil',
        'team-management-title': 'Gestion d\'√©quipe',
        
        // Home page
        'welcome-msg': 'Bienvenue √† UAI',
        'start-msg': 'Commencez votre parcours de travail',
        'company-activities-label': 'Activit√©s de l\'entreprise',
        'news-label': 'Actualit√©s',
        'benefits-label': 'Avantages des membres',
        'positions-label': 'Positions publicitaires',
        'team-expansion-label': 'Expansion de l\'√©quipe',
        'financial-management-label': 'Fonds de Richesse UAI',
        'casino-btn-label': 'Cliquez ici pour entrer au casino',
        
        // Profile page
        'profile-title': 'Profil',
        'wallet-balance-label': 'Solde du portefeuille',
        'profit-label': 'Profit',
        'tasks-done-label': 'T√¢ches termin√©es',
        'bond-label': 'Obligation',
        'logout-btn': 'Se d√©connecter',
        'language-select-label': 'S√©lectionner la langue',
        'notification-label': 'Notification',
        'withdraw-label': 'Retirer',
        'bind-details-label': 'Lier les d√©tails de retrait',
        'privacy-policy-label': 'Politique de confidentialit√©',
        
        // Task page
        'task-list-title': 'Liste des t√¢ches',
        'ongoing-label': 'En cours',
        'all-label': 'Tout',
        'completed-label': 'Termin√©',
        'install-btn': 'Installer',
        'completed-btn': 'Termin√©',
        'upgrade-required-btn': 'Mise √† niveau requise',
        'downloading-btn': 'T√©l√©chargement...',
        
        // Level page
        'level-title': 'Niveau',
        'choose-level-btn': 'Choisir ce niveau',
        'level-locked': 'Niveau verrouill√©',
        'upgrade-info-title': 'üí∞ Informations de mise √† niveau',
        'remaining-tasks-label': 'T√¢ches restantes:',
        'completed-tasks-label': 'T√¢ches termin√©es:',
        'cost-label': 'Co√ªt',
        'level-locked': 'Niveau verrouill√©',
        'promotion-tasks-title': 'Nombre de t√¢ches de promotion et revenus de commission par jour',
        'time-unit-label': 'Unit√© de temps',
        'number-of-tasks-label': 'Nombre de t√¢ches',
        'total-commission-label': 'Commission totale',
        'daily-label': 'Quotidien',
        'invitation-commission-title': 'Marge de profit de commission d\'invitation',
        'invitation-method-label': 'M√©thode d\'invitation',
        'invitation-rate-label': 'Taux de commission d\'invitation',
        'income-amount-label': 'Montant des revenus',
        'task-commission-title': 'Ratio de revenus de commission de t√¢ches',
        'task-completion-label': 'Ach√®vement de t√¢ches depuis',
        'task-commission-ratio-label': 'Ratio de commission de t√¢ches',
        'new-user-upgrade': 'Nouvelle mise √† niveau utilisateur vers le niveau',
        'already-at-level': 'Vous √™tes d√©j√† au niveau',
        'downgrade-from': 'R√©trograder du niveau',
        'upgrade-from': 'Mettre √† niveau depuis le niveau',
        'refund-amount': 'üí∞ Remboursement: KES',
        'net-cost': 'üí≥ Co√ªt net: KES',
        'your-balance': 'üíµ Votre solde: KES',
        'insufficient-balance': '‚ùå Solde insuffisant (n√©cessite KES',
        'sufficient-balance': '‚úÖ Solde suffisant',
        'from-level': 'du niveau',
        
        // Common
        'loading': 'Chargement...',
        'error': 'Erreur',
        'success': 'Succ√®s',
        'network-error': 'Erreur r√©seau! Veuillez r√©essayer.',
        'please-login': 'Veuillez vous connecter d\'abord',
        'failed-to-load': '√âchec du chargement des donn√©es',
        'upgrade-success': 'Mis √† niveau avec succ√®s vers le niveau',
        'cost-label': 'Co√ªt: KES',
        'refund-label': 'Remboursement: KES',
        'net-cost-label': 'Co√ªt net: KES',
        'to-level': 'vers le niveau',
        'new-user-upgrade': 'Nouvelle mise √† niveau utilisateur vers le niveau',
        'already-at-level': 'Vous √™tes d√©j√† au niveau',
        'downgrade-from': 'R√©trograder du niveau',
        'upgrade-from': 'Mettre √† niveau depuis le niveau',
        'insufficient-balance': 'Solde insuffisant (n√©cessite KES',
        'sufficient-balance': 'Solde suffisant',
        'upgrade-info-title': 'üí∞ Informations de mise √† niveau'
      }
    };
  }

  // Change language and save globally
  async changeLanguage(lang) {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
      // Save to server
      await fetch('/api/set-lang', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ lang: lang })
      });

      // Save locally
      this.currentLang = lang;
      localStorage.setItem('userLanguage', lang);
      
      // Apply new language
      this.applyLanguage();
      
      console.log('üåç Language changed to:', lang);
      
      // Show success message
      this.showLanguageChangeMessage(lang);
      
    } catch (error) {
      console.error('Error changing language:', error);
    }
  }

  // Apply current language to all elements
  applyLanguage() {
    const currentTranslations = this.translations[this.currentLang] || this.translations['en'];
    
    // Update all elements with data-translate attribute
    document.querySelectorAll('[data-translate]').forEach(element => {
      const key = element.getAttribute('data-translate');
      const translation = currentTranslations[key];
      if (translation) {
        element.textContent = translation;
      }
    });

    // Update language chooser if it exists
    const languageChooser = document.getElementById('language-chooser');
    if (languageChooser) {
      languageChooser.value = this.currentLang;
    }

    // Update page title if it has a translation
    const titleKey = document.body.getAttribute('data-page-title');
    if (titleKey && currentTranslations[titleKey]) {
      document.title = currentTranslations[titleKey];
    }
  }

  // Get translation for a key
  getText(key) {
    const currentTranslations = this.translations[this.currentLang] || this.translations['en'];
    return currentTranslations[key] || key;
  }

  // Show language change success message
  showLanguageChangeMessage(lang) {
    const langNames = {
      'en': 'English',
      'sw': 'Swahili',
      'fr': 'French'
    };
    
    const message = document.createElement('div');
    message.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4caf50;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
    `;
    
    message.textContent = `üåç Language changed to ${langNames[lang] || lang}`;
    
    // Add animation CSS
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(message);
    
    // Remove after 3 seconds
    setTimeout(() => {
      message.remove();
      style.remove();
    }, 3000);
  }

  // Auto-apply language when page loads
  static async autoInit() {
    if (!window.languageManager) {
      window.languageManager = new LanguageManager();
    }
    await window.languageManager.init();
  }
}

// Auto-initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  LanguageManager.autoInit();
});

// Export for use in other scripts
window.LanguageManager = LanguageManager; 