<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Level</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <style>
    body {
      background: #f5faff;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #222;
      margin: 0;
      padding-bottom: 70px; /* Add space for bottom navigation */
      overflow-x: hidden; /* Prevent horizontal scrolling */
      width: 100%;
      min-height: 100vh;
    }
    .level-header-card {
      background: linear-gradient(90deg, #041d49 60%, #82b1ff 100%);
      border-radius: 18px;
      margin: 18px 8px 18px 8px;
      padding: 18px 18px 20px 18px;
      border: 1.5px solid #e3f2fd;
      box-shadow: 0 2px 8px #2979ff22;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 110px;
      color: #fff;
    }
    .level-arrow {
      background: #fff;
      border-radius: 50%;
      border: 1.5px solid #2979ff;
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 1.7em;
      color: #2979ff;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 5;
      box-shadow: 0 2px 8px #2979ff22;
      transition: background 0.18s;
    }
    .level-arrow:hover { background: #e3f2fd; }
    .level-arrow.left { left: -16px;}
    .level-arrow.right { right: -16px;}
    .level-main {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      z-index: 2;
    }
    .level-title {
      font-size: 1.45em;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .hexagon,
            .uai-in-hex {
                width: 46px;
                height: 46px;
                background: #ee10b6;
            width: 34px; height: 34px;  
            }
    .level-logo {
      
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 10px #2979ff22;
      margin-right: 7px;
      font-size: 1.2em;
      color: #2979ff;
      font-weight: 800;
    }
    .level-badge-img {
      width: 78px; height: 78px; margin-left: 14px; margin-right: 12px;
      border-radius: 50%; background: #fff;
      box-shadow: 0 2px 10px #2979ff22;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .level-badge-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .level-info-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .level-info-row {
      font-size: 1.11em;
      font-weight: 500;
      color: #fff;
      display: flex;
      gap: 18px;
      align-items: center;
    }
    .level-info-row .label { color: #e3f2fd;}
    .level-progress-bar-bg {
      width: 100%; height: 6px; background: #e3f2fd; border-radius: 7px;
      margin-top: 7px; margin-bottom: 2px;
      overflow: hidden;
    }
    .level-progress-bar-fg {
      height: 100%; background: linear-gradient(90deg, #2979ff 70%, #82b1ff 100%);
      border-radius: 7px;
      width: 0;
      transition: width 0.6s;
    }
    .level-carousel-nav {
      display: flex; justify-content: center; align-items: center;
      margin: 18px 0 0 0;
      gap: 22px;
    }
    .level-carousel-step {
      color: #2979ff;
      font-weight: 600;
      font-size: 1.07em;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 8px;
      opacity: 0.6;
      position: relative;
      outline: none;
      transition: color 0.15s;
    }
    .level-carousel-step.active {
      color: #ff9900;
      opacity: 1;
      font-weight: 700;
    }
    .level-carousel-step.locked {
      color: #bdbdbd;
      opacity: 0.7;
      cursor: not-allowed;
    }
    .level-carousel-step.active:after {
      content: '';
      display: block;
      width: 7px; height: 7px;
      background: #ff9900;
      border-radius: 50%;
      position: absolute;
      left: 50%; transform: translateX(-50%);
      bottom: -11px;
    }
    .level-section-title {
      font-size: 1.14em;
      font-weight: 700;
      color: #ff9900;
      margin: 18px 0 7px 0;
      padding-left: 8px;
    }
    .level-table {
      width: 100%; border-collapse: collapse; margin-bottom: 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px #2979ff22;
      overflow: hidden;
    }
    .level-table th, .level-table td {
      padding: 11px 7px;
      text-align: center;
      border-bottom: 1px solid #e3f2fd;
      font-size: 1.05em;
    }
    .level-table th {
      background: #2979ff;
      color: #fff;
      font-weight: 700;
      border-bottom: 2px solid #2979ff88;
    }
    .level-table tr:last-child td { border-bottom: none;}
    .choose-level-btn {
      background: #2979ff;
      color: #fff;
      border: none;
      border-radius: 22px;
      padding: 14px 0;
      width: 96%;
      font-size: 1.21em;
      font-weight: 700;
      display: block;
      margin: 24px auto 12px auto;
      box-shadow: 0 2px 10px #2979ff22;
      cursor: pointer;
      transition: background 0.18s;
    }
    .choose-level-btn:active { background: #ff9900;}
    .choose-level-btn.locked {
      background: #bdbdbd;
      color: #fff;
      cursor: not-allowed;
    }
    .locked-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(41,121,255,0.68);
      border-radius: 18px;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.3em;
      font-weight: 700;
      pointer-events: none;
      text-shadow: 0 2px 12px #000;
    }
    nav.bottom-nav {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 58px;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 8px #2979ff22;
      z-index: 1000;
      border-top: 1.5px solid #e3f2fd;
    }
    nav.bottom-nav a {
      color: #2979ff;
      font-size: 0.98em;
      font-weight: 600;
      text-align: center;
      padding: 2px 2px 0 2px;
      border-radius: 7px;
      display: flex; flex-direction: column; align-items: center;
      text-decoration: none;
      flex: 1;
      transition: background 0.2s, color 0.2s;
    }
    nav.bottom-nav a.active, nav.bottom-nav a:focus {
      background: #e3f2fd;
      color: #ff9900;
      font-weight: 700;
    }
    nav.bottom-nav a svg {
      width: 23px; height: 23px;
      margin: 0 auto 2px auto;
      fill: currentColor;
    }
    nav.bottom-nav a span {
      font-size: 0.75em;
      line-height: 1;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      border-radius: 18px;
      max-width: 320px;
      width: 90%;
      padding: 32px 20px;
      text-align: center;
      box-shadow: 0 4px 32px rgba(0,0,0,0.3);
      margin: 20px;
    }
    .modal-emoji {
      font-size: 3em;
      margin-bottom: 15px;
    }
    .modal-title {
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .modal-message {
      font-size: 1.1em;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    .modal-button {
      background: #2979ff;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 28px;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-button:hover {
      background: #1565c0;
    }
    @media (max-width:600px) {
      .level-header-card, .level-table, .level-section-title { max-width: 98vw; }
      .level-badge-img { width: 60px; height: 60px;}
      .level-title { font-size: 1.3em; }
      .level-info-row { font-size: 1em; }
      .level-carousel-step { font-size: 0.95em; }
      .level-table th, .level-table td { font-size: 0.95em; padding: 8px 5px; }
      .choose-level-btn { font-size: 1.1em; }
      .modal-content { max-width: 280px; padding: 28px 16px; }
      .modal-emoji { font-size: 2.5em; }
      .modal-title { font-size: 1.2em; }
      .modal-message { font-size: 1em; }
    }
    
    /* Mobile-specific optimizations for Android */
    @media (max-width: 480px) {
      body { 
        padding-bottom: 80px; 
        font-size: 14px;
      }
      .level-header-card { 
        margin: 8px 4px; 
        padding: 12px 10px; 
        min-height: 90px;
        border-radius: 12px;
      }
      .level-arrow { 
        width: 32px; 
        height: 32px; 
        font-size: 1.3em;
      }
      .level-arrow.left { left: -8px; }
      .level-arrow.right { right: -8px; }
      .level-title { 
        font-size: 1.1em; 
        gap: 8px;
      }
      .level-title span {
        font-size: 0.6em;
        padding: 1px 4px;
      }
      .level-info-row { 
        font-size: 0.85em; 
        gap: 8px; 
      }
      .level-badge-img { 
        width: 45px; 
        height: 45px; 
        margin-left: 8px; 
        margin-right: 6px;
      }
      .level-carousel-nav { 
        gap: 12px; 
        margin: 12px 0 0 0; 
      }
      .level-carousel-step { 
        font-size: 0.8em; 
        padding: 0 4px; 
      }
      .level-section-title { 
        font-size: 1em; 
        margin: 12px 0 6px 0; 
      }
      .level-table { 
        margin-bottom: 10px; 
        font-size: 0.8em;
      }
      .level-table th, .level-table td { 
        font-size: 0.8em; 
        padding: 5px 3px; 
      }
      .choose-level-btn { 
        font-size: 0.95em; 
        padding: 10px 0; 
        margin: 16px auto 8px auto;
        width: 92%;
        border-radius: 18px;
      }
      .modal-content { 
        max-width: 240px; 
        padding: 20px 12px; 
        margin: 12px;
      }
      .modal-emoji { font-size: 2em; }
      .modal-title { font-size: 1em; }
      .modal-message { font-size: 0.9em; }
      .modal-button { 
        padding: 8px 20px; 
        font-size: 0.95em; 
      }
      nav.bottom-nav { height: 60px; }
      nav.bottom-nav a { font-size: 0.85em; }
      nav.bottom-nav a svg { width: 18px; height: 18px; }
      nav.bottom-nav a span { font-size: 0.65em; }
    }
    
    /* Extra small screens */
    @media (max-width: 360px) {
      body { font-size: 13px; }
      .level-header-card { 
        margin: 6px 3px; 
        padding: 10px 8px; 
        min-height: 80px;
        border-radius: 10px;
      }
      .level-title { 
        font-size: 1em; 
        gap: 6px;
      }
      .level-title span {
        font-size: 0.55em;
        padding: 1px 3px;
      }
      .level-info-row { 
        font-size: 0.8em; 
        gap: 6px; 
      }
      .level-badge-img { 
        width: 40px; 
        height: 40px; 
        margin-left: 6px; 
        margin-right: 4px;
      }
      .level-carousel-nav { 
        gap: 8px; 
        margin: 10px 0 0 0; 
      }
      .level-carousel-step { 
        font-size: 0.75em; 
        padding: 0 3px; 
      }
      .level-section-title { 
        font-size: 0.95em; 
        margin: 10px 0 5px 0; 
      }
      .level-table { 
        margin-bottom: 8px; 
        font-size: 0.75em;
      }
      .level-table th, .level-table td { 
        font-size: 0.75em; 
        padding: 4px 2px; 
      }
      .choose-level-btn { 
        font-size: 0.9em; 
        padding: 8px 0; 
        width: 90%;
        border-radius: 16px;
      }
      nav.bottom-nav { height: 55px; }
      nav.bottom-nav a { font-size: 0.8em; }
      nav.bottom-nav a svg { width: 16px; height: 16px; }
      nav.bottom-nav a span { font-size: 0.6em; }
    }
  </style>
</head>
<body>
  <div id="level-container"></div>
  <nav class="bottom-nav" aria-label="Bottom Navigation">
    <a href="home.html" id="nav-home">
      <svg viewBox="0 0 24 24"><path d="M3 21v-7.5l9-6.5 9 6.5V21H3z"/></svg>
      <span id="nav-home-label">Home</span>
    </a>
    <a href="task.html" id="nav-task">
      <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 10h8M8 14h4"/></svg>
      <span id="nav-task-label">Task</span>
    </a>
    <a href="team management.html" id="nav-team">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="3"/><path d="M12 15c-4 0-8 2-8 4v1h16v-1c0-2-4-4-8-4z"/></svg>
      <span id="nav-team-label">Team Management</span>
    </a>
    <a href="level.html" class="active" aria-current="page" id="nav-level">
      <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 7v10l10 5 10-5V7"/></svg>
      <span id="nav-level-label">Level</span>
    </a>
    <a href="profile.html" id="nav-profile">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M2 20v-2a8 8 0 0 1 16 0v2"/></svg>
      <span id="nav-profile-label">Profile</span>
    </a>
  </nav>

  <!-- Modal for notifications -->
  <div id="notification-modal" class="modal-overlay">
    <div class="modal-content">
      <div id="modal-emoji" class="modal-emoji">🎉</div>
      <div id="modal-title" class="modal-title">Congratulations!</div>
      <div id="modal-message" class="modal-message">You have successfully joined this level.</div>
      <button id="modal-button" class="modal-button" type="button" onclick="hideModal()">OK</button>
    </div>
  </div>

  <script>
    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'index.html';
        return false;
      }
      return true;
    }

    // Blue theme badges/icons (use any badge icon you wish)
    const badgeUrls = [
      "https://img.icons8.com/color/96/crown.png", // LV1
      "https://img.icons8.com/color/96/diamond.png", // LV2
      "https://img.icons8.com/color/96/medal.png",   // LV3
      "https://img.icons8.com/color/96/trophy.png",  // LV4
      "https://img.icons8.com/color/96/star.png",    // LV5
      "https://img.icons8.com/color/96/star.png",    // LV6
      "https://img.icons8.com/color/96/lock--v2.png",// LV7
      "https://img.icons8.com/color/96/lock--v2.png",// LV8
      "https://img.icons8.com/color/96/lock--v2.png" // LV9
    ];

    // Level costs will be fetched from database
    let levelCosts = {};

    let levels = [];
    let currentIndex = 0;
    let userLevel = 1;

    // Load levels data from backend
    async function loadLevelsData() {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      try {
        const res = await fetch('/api/levels', {
          headers: { Authorization: "Bearer " + token }
        });
        if (!res.ok) throw new Error('Failed to load levels data');
        
        const data = await res.json();
        userLevel = data.currentLevel || 1;
        
        // Original cost system (hardcoded)
        const originalCosts = {
          0: 0,        // Temporary worker
          1: 2600,     // Level 1
          2: 7500,     // Level 2
          3: 23500,    // Level 3
          4: 20000,    // Level 4
          5: 177000,   // Level 5
          6: 482000,   // Level 6
          7: 1084000,  // Level 7
          8: 2257000,  // Level 8
          9: 4270000   // Level 9
        };
        
        // Build level costs object from original data
        Object.keys(originalCosts).forEach(level => {
          levelCosts[level] = originalCosts[level];
        });
        
        // Transform backend data to frontend format with original costs
        levels = data.levelData.map((level, index) => {
          // Lock levels 7, 8, and 9
          const isLocked = level.level >= 7;
          
          return {
            level: level.level,
            cost: originalCosts[level.level] || 0, // Use original costs
            badge: badgeUrls[index] || badgeUrls[0],
            target: level.target,
            remaining: level.dailyTasks - data.completedToday,
            completed: data.completedToday,
            dailyTasks: level.dailyTasks,
            dailyCommission: level.dailyCommission,
            rewardPerTask: level.rewardPerTask || 17,
            promotionMargin: [
              { method: "Invite A to become a member", rate: `${level.invitation_rate_a || 12}%`, amount: Math.round(level.target * (level.invitation_rate_a || 12) / 100) },
              { method: "A invite subordinate B to become a member", rate: `${level.invitation_rate_b || 3}%`, amount: Math.round(level.target * (level.invitation_rate_b || 3) / 100) },
              { method: "B invite subordinates C to become member", rate: `${level.invitation_rate_c || 1}%`, amount: Math.round(level.target * (level.invitation_rate_c || 1) / 100) }
            ],
            commissionRatio: [
              { from: "Subordinate A completes the task", ratio: `${level.task_commission_rate_a || 5}%`, amount: Math.round(level.dailyCommission * (level.task_commission_rate_a || 5) / 100) },
              { from: "Subordinate B completes the task", ratio: `${level.task_commission_rate_b || 2}%`, amount: Math.round(level.dailyCommission * (level.task_commission_rate_b || 2) / 100) },
              { from: "Subordinate C completes the task", ratio: `${level.task_commission_rate_c || 1}%`, amount: Math.round(level.dailyCommission * (level.task_commission_rate_c || 1) / 100) }
            ],
            locked: isLocked
          };
        });
        
        await renderLevel(currentIndex);
        
        // Start real-time wallet balance updates
        startRealTimeWalletUpdates();
      } catch (error) {
        console.error('Error loading levels data:', error);
      }
    }

    // Fetch wallet balance from the same API as profile.html
    async function fetchWalletBalance() {
      const token = localStorage.getItem('token');
      if (!token) return 0;
      
      try {
        const res = await fetch('/api/user-stats', {
          headers: { Authorization: "Bearer " + token }
        });
        if (res.ok) {
          const data = await res.json();
          return parseFloat(data.wallet_balance || 0);
        }
      } catch (error) {
        console.error('Error fetching wallet balance:', error);
      }
      return 0;
    }

    // Real-time wallet balance updates
    function startRealTimeWalletUpdates() {
      // Update wallet balance every 15 seconds
      setInterval(async () => {
        const newBalance = await fetchWalletBalance();
        updateWalletBalanceDisplay(newBalance);
      }, 15000);
      
      // Also update when page becomes visible
      document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
          const newBalance = await fetchWalletBalance();
          updateWalletBalanceDisplay(newBalance);
        }
      });
      
      // Update when user returns to the tab
      window.addEventListener('focus', async () => {
        const newBalance = await fetchWalletBalance();
        updateWalletBalanceDisplay(newBalance);
      });
    }

    // Update wallet balance display
    function updateWalletBalanceDisplay(balance) {
      const walletDisplay = document.getElementById('wallet-balance-display');
      if (walletDisplay) {
        walletDisplay.textContent = `KES ${balance.toLocaleString()}`;
      }
    }

    async function renderLevel(index) {
      if (!levels.length) return;
      
      const l = levels[index];
      const cost = l.cost || 0;
      // Calculate total commission as number of tasks * reward per task
      const rewardPerTask = l.rewardPerTask || 17; // fallback to 17 if not present
      const totalCommission = l.dailyTasks * rewardPerTask;
      
      // Fetch user wallet balance using the same method as profile.html
      const walletBalance = await fetchWalletBalance();
      
      document.getElementById('level-container').innerHTML = `
        <div class="level-header-card" style="position:relative;">
          <span class="level-arrow left" onclick="moveLevel(-1)" ${index===0?'style=\"visibility:hidden;\"':''}>&lt;</span>
          <div class="level-main">
            <div>
              <div class="level-title">
                <span class="level-logo">UAI</span>
                Lv${l.level}
                ${l.level === 1 ? '<span style="background:#ff6b35;color:#fff;font-size:0.7em;padding:2px 6px;border-radius:8px;margin-left:8px;font-weight:600;">MOST POPULAR</span>' : ''}
                ${l.level === 2 ? '<span style="background:#2979ff;color:#fff;font-size:0.7em;padding:2px 6px;border-radius:8px;margin-left:8px;font-weight:600;">POPULAR</span>' : ''}
              </div>
              <div class="level-info-box">
                <div class="level-info-row"><span class="label">Remaining tasks:</span> ${l.remaining}</div>
                <div class="level-info-row"><span class="label">Completed tasks:</span> ${l.completed}</div>
                <div class="level-progress-bar-bg">
                  <div class="level-progress-bar-fg" style="width:${l.completed/(l.dailyTasks||1)*100}%"></div>
                </div>
              </div>
            </div>
            <div class="level-badge-img">
              <img src="${l.badge}" style="width:100%;height:100%;" alt="Badge" />
            </div>
            <div style="text-align:right;">
              <div style="font-weight:600;font-size:1.07em;color:#fff;margin-bottom:9px;">Cost</div>
              <div style="font-size:1.23em;font-weight:700;color:#fff;">KES ${cost.toLocaleString()}</div>
            </div>
          </div>
          <span class="level-arrow right" onclick="moveLevel(1)" ${index===levels.length-1?'style=\"visibility:hidden;\"':''}>&gt;</span>
          ${l.locked ? `<div class="locked-overlay">Level Locked 🔒</div>` : ""}
        </div>
        
        <!-- Wallet Balance Display -->
        <div style="background:#fff;margin:8px;padding:12px;border-radius:12px;box-shadow:0 2px 8px #2979ff22;text-align:center;">
          <div style="font-size:0.9em;color:#666;margin-bottom:4px;">Your Wallet Balance</div>
          <div style="font-size:1.4em;font-weight:700;color:#2979ff;" id="wallet-balance-display">KES ${walletBalance.toLocaleString()}</div>
        </div>
        
        <div class="level-carousel-nav">
          ${levels.map((lv, i) => `<button class="level-carousel-step${i===index?' active':''}${lv.locked?' locked':''}" onclick="moveLevel(${i-currentIndex})" ${lv.locked?'disabled':''}>LV${lv.level}${lv.locked?' 🔒':''}</button>`).join('')}
        </div>
        <div class="level-section-title">Lv${l.level}</div>
        <div style="padding:0 8px;">
          <div class="level-section-title" style="color:#2979ff;">Number of promotion tasks and commission income per day</div>
          <table class="level-table">
            <tr>
              <th>Time unit</th>
              <th>Number of tasks</th>
              <th>Total commission</th>
            </tr>
            <tr>
              <td>Daily</td>
              <td>${l.dailyTasks}</td>
              <td>${totalCommission.toLocaleString()}</td>
            </tr>
          </table>
          <div class="level-section-title" style="color:#2979ff;">Invitation commission profit margin</div>
          <table class="level-table">
            <tr>
              <th>Invitation Method</th>
              <th>Invitation commission rate</th>
              <th>Income amount</th>
            </tr>
            ${l.promotionMargin.length ? l.promotionMargin.map(pm => `<tr><td>${pm.method}</td><td>${pm.rate}</td><td>${pm.amount.toLocaleString()}</td></tr>`).join('') : `<tr><td colspan=\"3\" style=\"color:#bdbdbd;\">Locked</td></tr>`}
          </table>
          <div class="level-section-title" style="color:#2979ff;">Task commission income ratio</div>
          <table class="level-table">
            <tr>
              <th>Task completion from</th>
              <th>Task commission ratio</th>
              <th>Income amount</th>
            </tr>
            ${l.commissionRatio.length ? l.commissionRatio.map(cr => `<tr><td>${cr.from}</td><td>${cr.ratio}</td><td>${cr.amount.toLocaleString()}</td></tr>`).join('') : `<tr><td colspan=\"3\" style=\"color:#bdbdbd;\">Locked</td></tr>`}
          </table>
          <button class="choose-level-btn${l.locked?' locked':''}" ${l.locked?'disabled':''} onclick="chooseLevel(${l.level}, ${cost})">
            ${l.locked ? 'Level Locked 🔒' : `Choose this level (KES ${cost.toLocaleString()})`}
          </button>
        </div>
      `;
    }

    async function moveLevel(step) {
      currentIndex += step;
      if (currentIndex < 0) currentIndex = 0;
      if (currentIndex > levels.length-1) currentIndex = levels.length-1;
      await renderLevel(currentIndex);
    }

    function showModal(type, message) {
      const modal = document.getElementById('notification-modal');
      const emoji = document.getElementById('modal-emoji');
      const title = document.getElementById('modal-title');
      const msg = document.getElementById('modal-message');
      const button = document.getElementById('modal-button');
      
      if (type === 'error') {
        emoji.textContent = '😢';
        title.textContent = 'Sorry!';
        title.style.color = '#e53935';
        button.style.background = '#e53935';
      } else {
        emoji.textContent = '🎉';
        title.textContent = 'Congratulations!';
        title.style.color = '#2979ff';
        button.style.background = '#2979ff';
      }
      
      msg.textContent = message;
      modal.style.display = 'flex';
    }

    function hideModal() {
      document.getElementById('notification-modal').style.display = 'none';
    }

    async function chooseLevel(level, cost) {
      const token = localStorage.getItem('token');
      if (!token) {
        showModal('error', 'Please log in first');
        return;
      }

      // Check if level is locked (7, 8, 9)
      if (level >= 7) {
        showModal('error', 'This level is currently locked and unavailable for selection.');
        return;
      }

      try {
        // Pre-check user balance using the same method as profile.html
        const userBalance = await fetchWalletBalance();
        
        if (userBalance < cost) {
          showModal('error', `Insufficient funds! You need KES ${cost.toLocaleString()} but your balance is KES ${userBalance.toLocaleString()}`);
          return;
        }

        const res = await fetch('/api/choose-level', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token 
          },
          body: JSON.stringify({ level: level })
        });

        const data = await res.json();
        
        if (!res.ok) {
          showModal('error', data.error || 'Failed to choose level');
          return;
        }

        // Success message with formatted costs
        let successMessage = `🎉 Congratulations! You have successfully joined Level ${level}!`;
        
        if (data.refundAmount && data.refundAmount > 0) {
          successMessage += `\n\n💰 Refund: KES ${data.refundAmount.toLocaleString()} from previous level`;
          successMessage += `\n💳 Net cost: KES ${data.netCost.toLocaleString()}`;
        } else {
          successMessage += `\n\n💳 Cost: KES ${cost.toLocaleString()}`;
        }
        
        showModal('success', successMessage);
        // Reload levels data to reflect changes
        await loadLevelsData();
        
        // Update wallet balance display after level selection
        const newBalance = await fetchWalletBalance();
        updateWalletBalanceDisplay(newBalance);
        
      } catch (error) {
        console.error('Error choosing level:', error);
        showModal('error', 'Network error! Please try again.');
      }
    }

    window.moveLevel = moveLevel;
    window.chooseLevel = chooseLevel;
    window.hideModal = hideModal;

    document.addEventListener("DOMContentLoaded", function() {
      if (!checkAuth()) return;
      loadLevelsData();
      
      // Update wallet balance when page becomes visible
      document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
          const newBalance = await fetchWalletBalance();
          updateWalletBalanceDisplay(newBalance);
        }
      });
      
      // Update wallet balance when user returns to the tab
      window.addEventListener('focus', async () => {
        const newBalance = await fetchWalletBalance();
        updateWalletBalanceDisplay(newBalance);
      });
    });
  </script>
</body>
</html>